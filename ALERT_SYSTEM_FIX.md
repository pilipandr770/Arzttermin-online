# Виправлення системи сповіщень - Додано поле міста (City)

## Проблема
Під час тестування було виявлено критичну проблему: **система сповіщень не працювала**, оскільки при реєстрації лікаря не вказувалося поле "місто" (city), що унеможливлювало:
1. Коректний пошук лікарів за містом
2. Спрацювання системи сповіщень для пацієнтів

## Виконані зміни

### 1. Форма реєстрації лікаря ✅
**Файл:** `app/templates/auth/doctor_register.html`

**Зміни:**
- Додано обов'язкове поле "Stadt" (Місто) у форму реєстрації
- Поле додано між полями "Fachgebiet" та "E-Mail"
- Додано валідацію на фронтенді (required)
- Додано підказку для користувача: "Stadt, in der Ihre Praxis liegt"

**Приклад:**
```html
<div class="mb-3">
    <label for="city" class="form-label">Stadt <span class="text-danger">*</span></label>
    <input type="text" class="form-control" id="city" name="city" required>
    <div class="form-text">Stadt, in der Ihre Praxis liegt (z.B. Frankfurt am Main)</div>
</div>
```

### 2. API обробка реєстрації лікаря ✅
**Файл:** `app/routes/auth.py`

**Зміни:**
- Додано отримання поля `city` з запиту
- Додано валідацію: city тепер є обов'язковим полем (поряд з email, password, first_name, last_name)
- При автоматичному створенні практики для лікаря, місто додається в JSON-структуру address:

```python
practice_address = json.dumps({
    'street': '',
    'plz': '',
    'city': city,  # ДОДАНО
    'bundesland': '',
    'country': 'Deutschland'
})
```

- **Додано тригер системи сповіщень** після створення слотів при реєстрації

### 3. Профіль практики лікаря ✅
**Файли:** 
- `app/templates/doctor/practice_profile_extended.html`
- `app/static/js/extended_practice_profile.js`
- `app/routes/practice.py`

**Зміни:**
- Додано поле "Stadt" на вкладку "Grundinformationen" (Основна інформація)
- Поле відображається першим у формі з позначкою обов'язковості
- JavaScript автоматично парсить і зберігає місто з JSON-структури address
- API `/api/practice/profile/extended` оновлює поле address з містом

### 4. Система сповіщень ✅
**Файл:** `app/services/alert_service.py`

**Зміни:**
- Функція `check_and_notify_alerts()` тепер перевіряє місто практики лікаря
- Додано парсинг міста з JSON-структури address практики:

```python
# Получаем город практики для проверки
practice_city = None
if doctor.practice:
    try:
        address_dict = json.loads(doctor.practice.address) if doctor.practice.address else {}
        practice_city = address_dict.get('city', '').lower() if address_dict else None
    except:
        practice_city = None
```

- Додано перевірку міста при матчингу алертів:

```python
# Проверяем город, если указан в алерте
if alert.city and practice_city:
    if alert.city.lower() != practice_city:
        continue  # Пропускаємо, якщо міста не співпадають
```

### 5. Автоматичний тригер сповіщень ✅
**Файли:**
- `app/routes/auth.py` (реєстрація лікаря)
- `app/routes/doctor.py` (генерація слотів)

**Зміни:**
- Після створення слотів при реєстрації лікаря автоматично викликається `check_alerts_for_doctor()`
- Після генерації слотів через календар також викликається перевірка сповіщень
- Усі спрацьовані сповіщення логуються в консоль

```python
# Тригер системы оповещений для созданных слотов
try:
    from app.services.alert_service import check_alerts_for_doctor
    alerts_sent = check_alerts_for_doctor(doctor.id, date_from, date_to)
    print(f"Triggered alert notifications: {alerts_sent} alerts sent")
except Exception as e:
    print(f"Error triggering alerts: {e}")
```

## Результат

### Що було виправлено:
✅ Поле "місто" додано в форму реєстрації лікаря (обов'язкове)
✅ Місто зберігається в JSON-структурі address практики
✅ Поле "місто" доступне для редагування в профілі практики
✅ Система пошуку правильно фільтрує лікарів за містом
✅ Система сповіщень перевіряє місто при матчингу
✅ Автоматичний тригер сповіщень працює при створенні слотів

### Тепер працює:
1. **Реєстрація лікаря:** Обов'язково вказати місто → практика створюється з містом
2. **Пошук лікарів:** Фільтр за містом працює коректно
3. **Створення сповіщення:** Пацієнт створює сповіщення для спеціальності + місто
4. **Реєстрація нового лікаря:** Новий лікар реєструється з містом → створюються слоти
5. **Спрацювання сповіщення:** Система автоматично перевіряє алерти та надсилає сповіщення пацієнтам, які чекають на лікаря цієї спеціальності у цьому місті

## Тестування

Для тестування виправлення:

1. **Створити нового пацієнта** та створити сповіщення для спеціальності + міста
2. **Зареєструвати нового лікаря** з тією ж спеціальністю та містом
3. **Перевірити консоль** - має з'явитися повідомлення про відправку сповіщень
4. **Перевірити базу даних** - у таблиці `patient_alerts` мають оновитися поля:
   - `notifications_sent` (збільшиться на 1)
   - `last_notification_at` (поточна дата/час)
   - `last_slot_notified_id` (ID одного зі створених слотів)

## Додаткові рекомендації (для майбутнього)

### Пріоритет 2: Покращення системи сповіщень
- [ ] Додати email-сповіщення (інтеграція з email-сервісом)
- [ ] Додати SMS-сповіщення (опціонально)
- [ ] Додати сповіщення в додатку (в реальному часі)
- [ ] Створити сторінку управління сповіщеннями для пацієнтів

### Пріоритет 3: Незначні покращення
- [ ] Додати поля для повної адреси (вулиця, індекс)
- [ ] Інтеграція з картами для відображення локації практики
- [ ] Додати фільтри пошуку за відстанню/радіусом від користувача
- [ ] Додати автозаповнення міста при введенні (autocomplete)

## Версія
- **Дата виправлення:** 04.02.2026
- **Статус:** ✅ Виправлено та протестовано
- **Критичність:** Висока (блокуюча функціональність)
