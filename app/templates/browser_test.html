<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Browser Test - TerminFinder</title>
    <link href="/static/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-5">
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title">üåê Browser Storage Test</h5>
                        <p class="mb-0">Testing localStorage access with local Bootstrap files</p>
                    </div>
                    <div class="card-body">
                        <div id="results" class="mb-3">
                        <div class="alert alert-info">
                            <h6>üîç –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø—Ä–æ–±–ª–µ–º —Å –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º —Ç–µ—Ä–º–∏–Ω–æ–≤</h6>
                            <p>–≠—Ç–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –ø–æ–º–æ–∂–µ—Ç –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å, –ø–æ—á–µ–º—É —Ç–µ—Ä–º–∏–Ω—ã –Ω–µ –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è —É –¥–æ–∫—Ç–æ—Ä–∞.</p>
                            <p><strong>–í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:</strong></p>
                            <ul>
                                <li>–ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ localStorage –±—Ä–∞—É–∑–µ—Ä–æ–º</li>
                                <li>–ü—Ä–æ–±–ª–µ–º—ã —Å –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–µ–π</li>
                                <li>–û—à–∏–±–∫–∏ –≤ JavaScript –∫–æ–¥–µ</li>
                            </ul>
                        </div>

                        <div class="mb-3">
                            <button id="testLocalStorage" class="btn btn-primary me-2">Test localStorage</button>
                            <button id="testLogin" class="btn btn-success me-2">Test Doctor Login</button>
                            <button id="testCalendar" class="btn btn-info me-2">Test Calendar Load</button>
                            <button id="testFullFlow" class="btn btn-warning">üîß –ü–æ–ª–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞</button>
                        </div>

                        <div id="login-section" class="mb-3" style="display: none;">
                            <h6>Doctor Login</h6>
                            <div class="mb-2">
                                <input type="email" id="email" class="form-control" placeholder="Email" value="doctor@test.com">
                            </div>
                            <div class="mb-2">
                                <input type="password" id="password" class="form-control" placeholder="Password" value="password123">
                            </div>
                            <button id="loginBtn" class="btn btn-success">Login</button>
                        </div>

                        <div id="calendar-section" style="display: none;">
                            <h6>Calendar Data</h6>
                            <div id="calendar-data"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let authToken = null;

        // Test localStorage access
        function testLocalStorage() {
            const results = document.getElementById('results');
            try {
                localStorage.setItem('test', 'working');
                const value = localStorage.getItem('test');
                localStorage.removeItem('test');

                if (value === 'working') {
                    results.innerHTML = '<div class="alert alert-success">‚úÖ localStorage —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ</div>';
                    return true;
                } else {
                    results.innerHTML = '<div class="alert alert-warning">‚ö†Ô∏è localStorage –¥–æ—Å—Ç—É–ø–µ–Ω, –Ω–æ –¥–∞–Ω–Ω—ã–µ –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è</div>';
                    return false;
                }
            } catch (error) {
                results.innerHTML = `<div class="alert alert-danger">‚ùå localStorage –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω: ${error.message}</div>`;
                return false;
            }
        }

        // Test doctor login
        async function testLogin() {
            const results = document.getElementById('results');
            const loginSection = document.getElementById('login-section');

            try {
                const response = await fetch('/api/auth/doctor/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        email: 'doctor@test.com',
                        password: 'password123'
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    authToken = data.access_token;

                    // Try to save token to localStorage
                    try {
                        localStorage.setItem('auth_token', authToken);
                        results.innerHTML = '<div class="alert alert-success">‚úÖ –í—Ö–æ–¥ —É—Å–ø–µ—à–µ–Ω, —Ç–æ–∫–µ–Ω —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ localStorage</div>';
                        document.getElementById('calendar-section').style.display = 'block';
                    } catch (storageError) {
                        results.innerHTML = `<div class="alert alert-warning">‚úÖ –í—Ö–æ–¥ —É—Å–ø–µ—à–µ–Ω, –Ω–æ localStorage –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω: ${storageError.message}</div>`;
                        document.getElementById('calendar-section').style.display = 'block';
                    }
                } else {
                    const error = await response.text();
                    results.innerHTML = `<div class="alert alert-danger">‚ùå –û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞: ${error}</div>`;
                }
            } catch (error) {
                results.innerHTML = `<div class="alert alert-danger">‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ${error.message}</div>`;
            }
        }

        // Test calendar loading
        async function testCalendar() {
            const results = document.getElementById('results');
            const calendarData = document.getElementById('calendar-data');

            if (!authToken) {
                // Try to get token from localStorage
                try {
                    authToken = localStorage.getItem('auth_token');
                } catch (error) {
                    results.innerHTML = `<div class="alert alert-danger">‚ùå –ù–µ—Ç —Ç–æ–∫–µ–Ω–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏: ${error.message}</div>`;
                    return;
                }
            }

            if (!authToken) {
                results.innerHTML = '<div class="alert alert-danger">‚ùå –ù–µ—Ç —Ç–æ–∫–µ–Ω–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏</div>';
                return;
            }

            try {
                const response = await fetch('/api/doctors/calendar/slots?start_date=2026-01-28&end_date=2026-01-28', {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    const slots = data.slots || [];

                    // Count statuses
                    const statusCounts = {};
                    slots.forEach(slot => {
                        statusCounts[slot.status] = (statusCounts[slot.status] || 0) + 1;
                    });

                    calendarData.innerHTML = `
                        <div class="alert alert-success">
                            <strong>‚úÖ –ö–∞–ª–µ–Ω–¥–∞—Ä—å –∑–∞–≥—Ä—É–∂–µ–Ω —É—Å–ø–µ—à–Ω–æ!</strong><br>
                            –í—Å–µ–≥–æ —Å–ª–æ—Ç–æ–≤: ${slots.length}<br>
                            –î–æ—Å—Ç—É–ø–Ω—ã—Ö: ${statusCounts.available || 0}<br>
                            –ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö: ${statusCounts.booked || 0}
                        </div>
                        <div class="mt-3">
                            <h6>–ü—Ä–∏–º–µ—Ä—ã —Å–ª–æ—Ç–æ–≤:</h6>
                            <pre>${JSON.stringify(slots.slice(0, 3), null, 2)}</pre>
                        </div>
                    `;

                    results.innerHTML = '<div class="alert alert-success">‚úÖ –ö–∞–ª–µ–Ω–¥–∞—Ä—å –∑–∞–≥—Ä—É–∂–µ–Ω —É—Å–ø–µ—à–Ω–æ</div>';
                } else {
                    const error = await response.text();
                    results.innerHTML = `<div class="alert alert-danger">‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞–ª–µ–Ω–¥–∞—Ä—è: ${error}</div>`;
                }
            } catch (error) {
                results.innerHTML = `<div class="alert alert-danger">‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ${error.message}</div>`;
            }
        }

        // Full diagnostic flow
        async function testFullFlow() {
            const results = document.getElementById('results');
            results.innerHTML = '<div class="alert alert-info">üöÄ –ó–∞–ø—É—Å–∫ –ø–æ–ª–Ω–æ–π –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏...</div>';

            // Step 1: Test localStorage
            results.innerHTML += '<div class="mt-2"><strong>–®–∞–≥ 1:</strong> –ü—Ä–æ–≤–µ—Ä–∫–∞ localStorage...</div>';
            const localStorageOk = testLocalStorage();
            if (!localStorageOk) {
                results.innerHTML += `
                    <div class="alert alert-danger mt-2">
                        <strong>‚ùå localStorage –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω!</strong><br>
                        –≠—Ç–æ –æ—Å–Ω–æ–≤–Ω–∞—è –ø—Ä–∏—á–∏–Ω–∞, –ø–æ—á–µ–º—É —Ç–µ—Ä–º–∏–Ω—ã –Ω–µ –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è.<br>
                        <strong>–†–µ—à–µ–Ω–∏–µ:</strong>
                        <ol>
                            <li>–ù–∞–∂–º–∏—Ç–µ –Ω–∞ üîí –≤ –∞–¥—Ä–µ—Å–Ω–æ–π —Å—Ç—Ä–æ–∫–µ –±—Ä–∞—É–∑–µ—Ä–∞</li>
                            <li>–í—ã–±–µ—Ä–∏—Ç–µ "Cookies and site data" ‚Üí "Allow"</li>
                            <li>–ò–ª–∏ –æ—Ç–∫—Ä–æ–π—Ç–µ —Å–∞–π—Ç –≤ —Ä–µ–∂–∏–º–µ –∏–Ω–∫–æ–≥–Ω–∏—Ç–æ</li>
                            <li>–ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É</li>
                        </ol>
                    </div>
                `;
                return;
            }

            // Step 2: Test login
            results.innerHTML += '<div class="mt-2"><strong>–®–∞–≥ 2:</strong> –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Ö–æ–¥–∞...</div>';
            await testLogin();
            if (!authToken) {
                results.innerHTML += '<div class="alert alert-danger mt-2">‚ùå –í—Ö–æ–¥ –Ω–µ —É–¥–∞–ª—Å—è</div>';
                return;
            }

            // Step 3: Test calendar loading
            results.innerHTML += '<div class="mt-2"><strong>–®–∞–≥ 3:</strong> –ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞–ª–µ–Ω–¥–∞—Ä—è...</div>';
            await testCalendar();

            // Step 4: Summary
            results.innerHTML += `
                <div class="alert alert-success mt-3">
                    <strong>‚úÖ –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!</strong><br>
                    –ï—Å–ª–∏ –≤—Å–µ —à–∞–≥–∏ –ø—Ä–æ—à–ª–∏ —É—Å–ø–µ—à–Ω–æ, —Ç–µ—Ä–º–∏–Ω—ã –¥–æ–ª–∂–Ω—ã –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è.<br>
                    –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–µ—Ä–µ–π—Ç–∏ –Ω–∞ <a href="/doctor/calendar" target="_blank">—Å—Ç—Ä–∞–Ω–∏—Ü—É –∫–∞–ª–µ–Ω–¥–∞—Ä—è</a>
                </div>
            `;
        }

        // Event listeners
        document.getElementById('testLocalStorage').addEventListener('click', testLocalStorage);
        document.getElementById('testLogin').addEventListener('click', testLogin);
        document.getElementById('testCalendar').addEventListener('click', testCalendar);
        document.getElementById('testFullFlow').addEventListener('click', testFullFlow);

        // Auto-run localStorage test on page load
        document.addEventListener('DOMContentLoaded', function() {
            testLocalStorage();
        });
    </script>
</body>
</html>