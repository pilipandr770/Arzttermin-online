<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ title if title else 'TerminFinder - Intelligente Terminbuchung f√ºr √Ñrzte' }}</title>
    <link href="{{ url_for('static', filename='css/bootstrap.min.css') }}" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link href="{{ url_for('static', filename='css/style.css') }}" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/custom.css') }}" rel="stylesheet">
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
        <div class="container">
            <a class="navbar-brand" href="#">TerminFinder</a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="#about">√úber uns</a>
                <a class="nav-link" href="#how-it-works">Wie es funktioniert</a>
                <a class="nav-link" href="#user-type">Registrieren</a>
                <a class="nav-link" href="#user-type">Anmelden</a>
            </div>
        </div>
    </nav>

    <main>
        {% block content %}{% endblock %}
    </main>

    <footer class="bg-light py-4 mt-5">
        <div class="container text-center">
            <div class="mb-3">
                <a href="{{ url_for('legal.impressum') }}" class="text-muted mx-2">Impressum</a>
                <a href="{{ url_for('legal.datenschutz') }}" class="text-muted mx-2">Datenschutz</a>
                <a href="{{ url_for('legal.agb') }}" class="text-muted mx-2">AGB</a>
                <a href="{{ url_for('legal.account_deletion') }}" class="text-muted mx-2">Konto l√∂schen</a>
            </div>
            <p>&copy; 2026 TerminFinder. Alle Rechte vorbehalten.</p>
            <p class="text-muted mb-1"><small>Projekt in Entwicklung</small></p>
            <p class="text-muted"><small>Kontakt: Andrii Pylypchuk | +49 160 95030120</small></p>
        </div>
    </footer>

    <!-- Help Chatbot Widget -->
    <div id="helpChatWidget">
        <!-- Floating Button -->
        <button id="helpChatBtn" class="help-chat-btn" onclick="toggleHelpChat()" title="Hilfe & Support">
            <i class="bi bi-question-circle-fill"></i>
        </button>

        <!-- Chat Window -->
        <div id="helpChatWindow" class="help-chat-window" style="display: none;">
            <div class="help-chat-header">
                <div>
                    <h6 class="mb-0">
                        <i class="bi bi-robot"></i> TerminFinder Assistent
                    </h6>
                    <small class="text-muted">Ich helfe dir gerne weiter</small>
                </div>
                <div>
                    <button class="btn btn-sm btn-link text-white" onclick="resetHelpChat()" title="Gespr√§ch zur√ºcksetzen">
                        <i class="bi bi-arrow-clockwise"></i>
                    </button>
                    <button class="btn btn-sm btn-link text-white" onclick="toggleHelpChat()" title="Schlie√üen">
                        <i class="bi bi-x-lg"></i>
                    </button>
                </div>
            </div>
            
            <div id="helpChatMessages" class="help-chat-messages">
                <div class="help-chat-message assistant">
                    <div class="message-content">
                        <i class="bi bi-robot me-2"></i>
                        Hallo! Ich bin dein pers√∂nlicher Assistent. Wie kann ich dir helfen?
                    </div>
                </div>
            </div>
            
            <div class="help-chat-input">
                <input type="text" id="helpChatInput" class="form-control" 
                       placeholder="Deine Frage..." 
                       onkeypress="if(event.key==='Enter') sendHelpMessage()">
                <button id="helpChatVoiceBtn" class="btn btn-voice" onclick="toggleHelpChatVoice()" title="Spracheingabe">
                    <i class="bi bi-mic-fill"></i>
                </button>
                <button class="btn btn-primary" onclick="sendHelpMessage()">
                    <i class="bi bi-send-fill"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Help Chat Styles -->
    <style>
        .help-chat-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            color: white;
            font-size: 28px;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            transition: all 0.3s ease;
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .help-chat-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(0,0,0,0.25);
        }

        .help-chat-btn i {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .help-chat-window {
            position: fixed;
            bottom: 90px;
            right: 20px;
            width: 380px;
            height: 500px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 8px 30px rgba(0,0,0,0.2);
            display: flex;
            flex-direction: column;
            z-index: 1001;
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .help-chat-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            border-radius: 15px 15px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .help-chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            background: #f8f9fa;
        }

        .help-chat-message {
            margin-bottom: 15px;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .help-chat-message.user .message-content {
            background: #667eea;
            color: white;
            margin-left: auto;
            max-width: 80%;
        }

        .help-chat-message.assistant .message-content {
            background: white;
            color: #333;
            margin-right: auto;
            max-width: 80%;
        }

        .message-content {
            padding: 10px 15px;
            border-radius: 15px;
            display: inline-block;
            word-wrap: break-word;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .help-chat-input {
            padding: 15px;
            border-top: 1px solid #dee2e6;
            display: flex;
            gap: 10px;
            background: white;
            border-radius: 0 0 15px 15px;
        }

        .help-chat-input input {
            flex: 1;
            border-radius: 20px;
        }

        .help-chat-input button {
            border-radius: 50%;
            width: 40px;
            height: 40px;
            padding: 0;
        }

        .help-chat-input .btn-voice {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            color: white;
            transition: all 0.3s ease;
        }

        .help-chat-input .btn-voice:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .help-chat-input .btn-voice.recording {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            animation: pulse-btn 1.5s ease-in-out infinite;
        }

        .help-chat-input .btn-voice.processing {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            animation: spin-btn 2s linear infinite;
        }

        @keyframes pulse-btn {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        @keyframes spin-btn {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        @media (max-width: 576px) {
            .help-chat-window {
                width: calc(100vw - 40px);
                height: 400px;
                right: 20px;
            }
        }
    </style>

    <!-- Help Chat Script -->
    <script>
        let helpChatOpen = false;

        function toggleHelpChat() {
            helpChatOpen = !helpChatOpen;
            const window = document.getElementById('helpChatWindow');
            const btn = document.getElementById('helpChatBtn');
            
            if (helpChatOpen) {
                window.style.display = 'flex';
                btn.style.transform = 'rotate(180deg)';
            } else {
                window.style.display = 'none';
                btn.style.transform = 'rotate(0deg)';
            }
        }

        async function sendHelpMessage() {
            const input = document.getElementById('helpChatInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            // Add user message to chat
            addHelpChatMessage(message, 'user');
            input.value = '';
            
            // Show typing indicator
            const typingId = addHelpChatMessage('Schreibt...', 'assistant', true);
            
            try {
                const response = await fetch('/api/help-chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        message: message,
                        current_page: window.location.pathname
                    })
                });
                
                const data = await response.json();
                
                // Remove typing indicator
                document.getElementById(typingId)?.remove();
                
                // Log context info for debugging
                console.log('ü§ñ Help Chat Context:', {
                    userType: data.user_type,
                    currentPage: data.current_page,
                    contextDetected: data.context_detected
                });
                
                if (data.error) {
                    addHelpChatMessage('Entschuldigung, es gab einen Fehler. Bitte versuche es erneut.', 'assistant');
                } else {
                    addHelpChatMessage(data.response, 'assistant');
                }
            } catch (error) {
                console.error('Help chat error:', error);
                document.getElementById(typingId)?.remove();
                addHelpChatMessage('Entschuldigung, ich kann gerade nicht antworten. Bitte versuche es sp√§ter erneut.', 'assistant');
            }
        }

        function addHelpChatMessage(text, type, isTyping = false) {
            const messagesDiv = document.getElementById('helpChatMessages');
            const messageDiv = document.createElement('div');
            const msgId = 'msg_' + Date.now();
            
            messageDiv.id = msgId;
            messageDiv.className = `help-chat-message ${type}`;
            
            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';
            
            // XSS Protection: Use textContent instead of innerHTML for user input
            if (type === 'assistant' && !isTyping) {
                const icon = document.createElement('i');
                icon.className = 'bi bi-robot me-2';
                contentDiv.appendChild(icon);
                contentDiv.appendChild(document.createTextNode(text));
            } else if (type === 'user') {
                contentDiv.textContent = text;
            } else {
                const icon = document.createElement('i');
                icon.className = 'bi bi-three-dots';
                contentDiv.appendChild(icon);
                contentDiv.appendChild(document.createTextNode(' ' + text));
            }
            
            messageDiv.appendChild(contentDiv);
            messagesDiv.appendChild(messageDiv);
            
            // Scroll to bottom
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
            
            return msgId;
        }

        async function resetHelpChat() {
            if (!confirm('M√∂chtest du das Gespr√§ch wirklich zur√ºcksetzen?')) return;
            
            try {
                await fetch('/api/help-chat/reset', {
                    method: 'POST'
                });
                
                // Clear messages
                const messagesDiv = document.getElementById('helpChatMessages');
                messagesDiv.innerHTML = `
                    <div class="help-chat-message assistant">
                        <div class="message-content">
                            <i class="bi bi-robot me-2"></i>
                            Hallo! Ich bin dein pers√∂nlicher Assistent. Wie kann ich dir helfen?
                        </div>
                    </div>
                `;
            } catch (error) {
                console.error('Reset error:', error);
            }
        }

        // Voice navigation integration with Help Chat
        let isHelpChatRecording = false;
        let helpChatMediaRecorder = null;
        let helpChatAudioChunks = [];
        let currentHelpChatAudio = null;

        async function toggleHelpChatVoice() {
            if (isHelpChatRecording) {
                stopHelpChatRecording();
            } else {
                await startHelpChatRecording();
            }
        }

        async function startHelpChatRecording() {
            try {
                // Check browser support with detailed diagnostics
                if (!navigator.mediaDevices) {
                    console.error('‚ùå navigator.mediaDevices not available');
                    alert('Dein Browser unterst√ºtzt keine Sprachaufnahme.\n\nBitte verwende Chrome, Edge oder Safari.');
                    return;
                }

                if (!navigator.mediaDevices.getUserMedia) {
                    console.error('‚ùå getUserMedia not available');
                    alert('Dein Browser unterst√ºtzt keine Sprachaufnahme.\n\nBitte verwende Chrome, Edge oder Safari.');
                    return;
                }

                if (!window.MediaRecorder) {
                    console.error('‚ùå MediaRecorder not available');
                    alert('Dein Browser unterst√ºtzt keine Audioaufnahme.\n\nBitte aktualisiere deinen Browser.');
                    return;
                }

                console.log('‚úÖ Browser supports voice recording');

                // Request microphone access
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true,
                        sampleRate: 44100
                    } 
                });

                console.log('‚úÖ Microphone access granted:', {
                    audioTracks: stream.getAudioTracks().length,
                    trackSettings: stream.getAudioTracks()[0]?.getSettings()
                });

                // Get supported MIME type
                const mimeType = getSupportedMimeType();
                helpChatMediaRecorder = new MediaRecorder(stream, { mimeType });
                helpChatAudioChunks = [];

                // Event handlers
                helpChatMediaRecorder.ondataavailable = (event) => {
                    if (event.data.size > 0) {
                        helpChatAudioChunks.push(event.data);
                    }
                };

                helpChatMediaRecorder.onstop = () => {
                    processHelpChatRecording();
                };

                // Start recording
                helpChatMediaRecorder.start();
                isHelpChatRecording = true;

                // Update UI
                const voiceBtn = document.getElementById('helpChatVoiceBtn');
                voiceBtn.classList.add('recording');
                voiceBtn.title = 'Aufnahme beenden';
                voiceBtn.innerHTML = '<i class="bi bi-mic-fill"></i>';

                console.log('üé§ Help Chat recording started');

                // Auto-stop after 30 seconds
                setTimeout(() => {
                    if (isHelpChatRecording) {
                        stopHelpChatRecording();
                    }
                }, 30000);

            } catch (error) {
                console.error('‚ùå Microphone access denied:', error);
                alert('Mikrofonzugriff verweigert. Bitte erlaube den Zugriff in deinen Browser-Einstellungen.');
            }
        }

        function stopHelpChatRecording() {
            if (helpChatMediaRecorder && isHelpChatRecording) {
                helpChatMediaRecorder.stop();
                isHelpChatRecording = false;

                // Stop all tracks
                helpChatMediaRecorder.stream.getTracks().forEach(track => track.stop());

                // Update UI
                const voiceBtn = document.getElementById('helpChatVoiceBtn');
                voiceBtn.classList.remove('recording');
                voiceBtn.classList.add('processing');
                voiceBtn.disabled = true;
                voiceBtn.title = 'Verarbeitung...';

                console.log('üõë Help Chat recording stopped');
            }
        }

        async function processHelpChatRecording() {
            try {
                // Create audio blob
                const mimeType = helpChatMediaRecorder.mimeType;
                const audioBlob = new Blob(helpChatAudioChunks, { type: mimeType });

                console.log('üì¶ Audio blob created:', {
                    size: audioBlob.size,
                    type: audioBlob.type
                });

                // Show processing message
                const processingId = addHelpChatMessage('üé§ Verarbeite Spracheingabe...', 'assistant', true);

                // Step 1: Transcribe with Whisper API
                const transcription = await transcribeHelpChatAudio(audioBlob);

                if (!transcription.success) {
                    throw new Error(transcription.error || 'Transcription failed');
                }

                const { text, language } = transcription;
                console.log('üìù Transcribed:', text, '(Language:', language + ')');

                // Remove processing message
                document.getElementById(processingId)?.remove();

                // Add transcribed text as user message
                addHelpChatMessage(text, 'user');

                // Step 2: Try Voice UI Controller first
                if (window.voiceUIController) {
                    const result = await window.voiceUIController.executeCommand(text);
                    console.log('üéØ UI Controller result:', result);

                    if (result.success && result.action === 'page_navigation') {
                        // Navigate to page
                        addHelpChatMessage(result.message, 'assistant');
                        result.execute();
                        return; // Page will reload
                        
                    } else if (result.success && [
                        'element_highlight', 
                        'element_click', 
                        'element_focus', 
                        'element_action',
                        'suggest_action'
                    ].includes(result.action)) {
                        // Element action successful
                        addHelpChatMessage(result.message, 'assistant');
                        
                        // Synthesize speech
                        await synthesizeHelpChatSpeech(result.message, language);
                        return; // Done
                    }
                    
                    // If not successful or needs explanation, continue to chatbot
                }

                // Show typing indicator
                const typingId = addHelpChatMessage('Schreibt...', 'assistant', true);

                // Step 3: Process with Help Chatbot
                const chatResponse = await fetch('/api/help-chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: text,
                        current_page: window.location.pathname,
                        language: language,
                        voice_mode: true
                    })
                });

                if (!chatResponse.ok) {
                    throw new Error('Chatbot error');
                }

                const chatData = await chatResponse.json();

                // Remove typing indicator
                document.getElementById(typingId)?.remove();

                console.log('üí¨ Chatbot response:', chatData.response);

                // Add response to chat
                addHelpChatMessage(chatData.response, 'assistant');

                // Step 4: Synthesize speech with TTS
                await synthesizeHelpChatSpeech(chatData.response, language);

            } catch (error) {
                console.error('‚ùå Processing error:', error);
                addHelpChatMessage('‚ùå Fehler bei der Verarbeitung: ' + error.message, 'assistant');

            } finally {
                // Reset UI
                const voiceBtn = document.getElementById('helpChatVoiceBtn');
                voiceBtn.classList.remove('processing');
                voiceBtn.disabled = false;
                voiceBtn.title = 'Spracheingabe';
                voiceBtn.innerHTML = '<i class="bi bi-mic-fill"></i>';
            }
        }

        async function transcribeHelpChatAudio(audioBlob) {
            const formData = new FormData();
            formData.append('audio', audioBlob, 'recording.webm');

            const response = await fetch('/api/voice-transcribe', {
                method: 'POST',
                body: formData
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error || 'Transcription failed');
            }

            return await response.json();
        }

        async function synthesizeHelpChatSpeech(text, language) {
            const response = await fetch('/api/voice-synthesize', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    text: text,
                    language: language
                })
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error || 'Speech synthesis failed');
            }

            // Get audio blob
            const audioBlob = await response.blob();

            // Play audio
            await playHelpChatAudio(audioBlob);
        }

        async function playHelpChatAudio(audioBlob) {
            return new Promise((resolve, reject) => {
                // Stop current audio if playing
                if (currentHelpChatAudio) {
                    currentHelpChatAudio.pause();
                    currentHelpChatAudio = null;
                }

                // Create audio element
                const audioUrl = URL.createObjectURL(audioBlob);
                currentHelpChatAudio = new Audio(audioUrl);

                currentHelpChatAudio.onended = () => {
                    URL.revokeObjectURL(audioUrl);
                    currentHelpChatAudio = null;
                    resolve();
                };

                currentHelpChatAudio.onerror = (error) => {
                    URL.revokeObjectURL(audioUrl);
                    currentHelpChatAudio = null;
                    reject(error);
                };

                // Play
                currentHelpChatAudio.play().catch(reject);
                console.log('üîä Playing audio...');
            });
        }

        function getSupportedMimeType() {
            const types = [
                'audio/webm;codecs=opus',
                'audio/webm',
                'audio/ogg;codecs=opus',
                'audio/mp4',
                'audio/mpeg'
            ];

            for (const type of types) {
                if (MediaRecorder.isTypeSupported(type)) {
                    return type;
                }
            }

            return ''; // Browser will use default
        }
    </script>

    <!-- Voice UI Controller (Intent parsing and element navigation) -->
    <script src="{{ url_for('static', filename='js/voice_ui_controller.js') }}"></script>

    <!-- Voice Navigation System (Whisper + OpenAI TTS) -->
    <script src="{{ url_for('static', filename='js/voice_navigation.js') }}"></script>

    <script src="{{ url_for('static', filename='js/bootstrap.bundle.min.js') }}"></script>
    <script src="{{ url_for('static', filename='js/main.js') }}?v={{ config['VERSION'] or '1.0' }}"></script>
    {% block scripts %}{% endblock %}
</body>
</html>