<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ title if title else 'TerminFinder - Intelligente Terminbuchung f√ºr √Ñrzte' }}</title>
    <link href="{{ url_for('static', filename='css/bootstrap.min.css') }}" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link href="{{ url_for('static', filename='css/style.css') }}" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/custom.css') }}" rel="stylesheet">
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
        <div class="container">
            <a class="navbar-brand" href="#">TerminFinder</a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="#about">√úber uns</a>
                <a class="nav-link" href="#how-it-works">Wie es funktioniert</a>
                <a class="nav-link" href="#user-type">Registrieren</a>
                <a class="nav-link" href="#user-type">Anmelden</a>
            </div>
        </div>
    </nav>

    <main>
        {% block content %}{% endblock %}
    </main>

    <footer class="bg-light py-4 mt-5">
        <div class="container text-center">
            <div class="mb-3">
                <a href="{{ url_for('legal.impressum') }}" class="text-muted mx-2">Impressum</a>
                <a href="{{ url_for('legal.datenschutz') }}" class="text-muted mx-2">Datenschutz</a>
                <a href="{{ url_for('legal.agb') }}" class="text-muted mx-2">AGB</a>
                <a href="{{ url_for('legal.account_deletion') }}" class="text-muted mx-2">Konto l√∂schen</a>
            </div>
            <p>&copy; 2026 TerminFinder. Alle Rechte vorbehalten.</p>
            <p class="text-muted mb-1"><small>Projekt in Entwicklung</small></p>
            <p class="text-muted"><small>Kontakt: Andrii Pylypchuk | +49 160 95030120</small></p>
        </div>
    </footer>

    <!-- Help Chatbot Widget -->
    <div id="helpChatWidget">
        <!-- Floating Button -->
        <button id="helpChatBtn" class="help-chat-btn" onclick="toggleHelpChat()" title="Hilfe & Support">
            <i class="bi bi-question-circle-fill"></i>
        </button>

        <!-- Chat Window -->
        <div id="helpChatWindow" class="help-chat-window" style="display: none;">
            <div class="help-chat-header">
                <div>
                    <h6 class="mb-0">
                        <i class="bi bi-robot"></i> TerminFinder Assistent
                    </h6>
                    <small class="text-muted">Ich helfe dir gerne weiter</small>
                </div>
                <div>
                    <button class="btn btn-sm btn-link text-white" onclick="resetHelpChat()" title="Gespr√§ch zur√ºcksetzen">
                        <i class="bi bi-arrow-clockwise"></i>
                    </button>
                    <button class="btn btn-sm btn-link text-white" onclick="toggleHelpChat()" title="Schlie√üen">
                        <i class="bi bi-x-lg"></i>
                    </button>
                </div>
            </div>
            
            <div id="helpChatMessages" class="help-chat-messages">
                <div class="help-chat-message assistant">
                    <div class="message-content">
                        <i class="bi bi-robot me-2"></i>
                        Hallo! Ich bin dein pers√∂nlicher Assistent. Wie kann ich dir helfen?
                    </div>
                </div>
            </div>
            
            <div class="help-chat-input">
                <input type="text" id="helpChatInput" class="form-control" 
                       placeholder="Deine Frage..." 
                       onkeypress="if(event.key==='Enter') sendHelpMessage()">
                <button class="btn btn-primary" onclick="sendHelpMessage()">
                    <i class="bi bi-send-fill"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Help Chat Styles -->
    <style>
        .help-chat-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            color: white;
            font-size: 28px;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            transition: all 0.3s ease;
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .help-chat-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(0,0,0,0.25);
        }

        .help-chat-btn i {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .help-chat-window {
            position: fixed;
            bottom: 90px;
            right: 20px;
            width: 380px;
            height: 500px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 8px 30px rgba(0,0,0,0.2);
            display: flex;
            flex-direction: column;
            z-index: 1001;
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .help-chat-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            border-radius: 15px 15px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .help-chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            background: #f8f9fa;
        }

        .help-chat-message {
            margin-bottom: 15px;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .help-chat-message.user .message-content {
            background: #667eea;
            color: white;
            margin-left: auto;
            max-width: 80%;
        }

        .help-chat-message.assistant .message-content {
            background: white;
            color: #333;
            margin-right: auto;
            max-width: 80%;
        }

        .message-content {
            padding: 10px 15px;
            border-radius: 15px;
            display: inline-block;
            word-wrap: break-word;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .help-chat-input {
            padding: 15px;
            border-top: 1px solid #dee2e6;
            display: flex;
            gap: 10px;
            background: white;
            border-radius: 0 0 15px 15px;
        }

        .help-chat-input input {
            flex: 1;
            border-radius: 20px;
        }

        .help-chat-input button {
            border-radius: 50%;
            width: 40px;
            height: 40px;
            padding: 0;
        }

        @media (max-width: 576px) {
            .help-chat-window {
                width: calc(100vw - 40px);
                height: 400px;
                right: 20px;
            }
        }
    </style>

    <!-- Help Chat Script -->
    <script>
        let helpChatOpen = false;

        function toggleHelpChat() {
            helpChatOpen = !helpChatOpen;
            const window = document.getElementById('helpChatWindow');
            const btn = document.getElementById('helpChatBtn');
            
            if (helpChatOpen) {
                window.style.display = 'flex';
                btn.style.transform = 'rotate(180deg)';
            } else {
                window.style.display = 'none';
                btn.style.transform = 'rotate(0deg)';
            }
        }

        async function sendHelpMessage() {
            const input = document.getElementById('helpChatInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            // Add user message to chat
            addHelpChatMessage(message, 'user');
            input.value = '';
            
            // Show typing indicator
            const typingId = addHelpChatMessage('Schreibt...', 'assistant', true);
            
            try {
                const response = await fetch('/api/help-chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        message: message,
                        current_page: window.location.pathname
                    })
                });
                
                const data = await response.json();
                
                // Remove typing indicator
                document.getElementById(typingId)?.remove();
                
                // Log context info for debugging
                console.log('ü§ñ Help Chat Context:', {
                    userType: data.user_type,
                    currentPage: data.current_page,
                    contextDetected: data.context_detected
                });
                
                if (data.error) {
                    addHelpChatMessage('Entschuldigung, es gab einen Fehler. Bitte versuche es erneut.', 'assistant');
                } else {
                    addHelpChatMessage(data.response, 'assistant');
                }
            } catch (error) {
                console.error('Help chat error:', error);
                document.getElementById(typingId)?.remove();
                addHelpChatMessage('Entschuldigung, ich kann gerade nicht antworten. Bitte versuche es sp√§ter erneut.', 'assistant');
            }
        }

        function addHelpChatMessage(text, type, isTyping = false) {
            const messagesDiv = document.getElementById('helpChatMessages');
            const messageDiv = document.createElement('div');
            const msgId = 'msg_' + Date.now();
            
            messageDiv.id = msgId;
            messageDiv.className = `help-chat-message ${type}`;
            
            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';
            
            // XSS Protection: Use textContent instead of innerHTML for user input
            if (type === 'assistant' && !isTyping) {
                const icon = document.createElement('i');
                icon.className = 'bi bi-robot me-2';
                contentDiv.appendChild(icon);
                contentDiv.appendChild(document.createTextNode(text));
            } else if (type === 'user') {
                contentDiv.textContent = text;
            } else {
                const icon = document.createElement('i');
                icon.className = 'bi bi-three-dots';
                contentDiv.appendChild(icon);
                contentDiv.appendChild(document.createTextNode(' ' + text));
            }
            
            messageDiv.appendChild(contentDiv);
            messagesDiv.appendChild(messageDiv);
            
            // Scroll to bottom
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
            
            return msgId;
        }

        async function resetHelpChat() {
            if (!confirm('M√∂chtest du das Gespr√§ch wirklich zur√ºcksetzen?')) return;
            
            try {
                await fetch('/api/help-chat/reset', {
                    method: 'POST'
                });
                
                // Clear messages
                const messagesDiv = document.getElementById('helpChatMessages');
                messagesDiv.innerHTML = `
                    <div class="help-chat-message assistant">
                        <div class="message-content">
                            <i class="bi bi-robot me-2"></i>
                            Hallo! Ich bin dein pers√∂nlicher Assistent. Wie kann ich dir helfen?
                        </div>
                    </div>
                `;
            } catch (error) {
                console.error('Reset error:', error);
            }
        }
    </script>

    <script src="{{ url_for('static', filename='js/bootstrap.bundle.min.js') }}"></script>
    <script src="{{ url_for('static', filename='js/main.js') }}?v={{ config['VERSION'] or '1.0' }}"></script>
    {% block scripts %}{% endblock %}
</body>
</html>