{% extends "base_dashboard.html" %}
{% set title = "Arzt Dashboard" %}
{% set user_type = "doctor" %}

{% block head %}
<style>
    .timeline {
        position: relative;
        padding-left: 30px;
    }
    
    .timeline-item {
        position: relative;
        padding-bottom: 20px;
        border-left: 2px solid #dee2e6;
    }
    
    .timeline-item:last-child {
        border-left: 2px solid transparent;
    }
    
    .timeline-marker {
        position: absolute;
        left: -30px;
        top: 0;
        width: 24px;
        height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .timeline-marker i {
        font-size: 16px;
    }
    
    .timeline-content {
        padding-left: 10px;
    }
    
    .text-primary .timeline-marker i {
        animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
    }
</style>
{% endblock %}

{% block dashboard_content %}
<div id="loading" class="text-center py-5">
    <div class="spinner-border" role="status">
        <span class="visually-hidden">Loading...</span>
    </div>
    <p class="mt-2">Lade Dashboard...</p>
</div>

<div id="dashboard-content" style="display: none;">
    <div class="row">
        <!-- Правая колонка - Часы и следующий термин -->
        <div class="col-md-4 order-md-2">
            <!-- Часы реального времени -->
            <div class="card mb-3 bg-primary text-white">
                <div class="card-body text-center">
                    <h6 class="mb-2"><i class="bi bi-clock"></i> Aktuelle Zeit</h6>
                    <div id="current-time" class="display-4 fw-bold mb-2">--:--</div>
                    <div id="current-date" class="small">Laden...</div>
                </div>
            </div>

            <!-- Следующий термин -->
            <div id="next-appointment-card" class="card mb-3">
                <div class="card-header bg-success text-white">
                    <h6 class="mb-0"><i class="bi bi-calendar-event"></i> Nächster Termin</h6>
                </div>
                <div class="card-body">
                    <div id="next-appointment-info">
                        <!-- Загружается через JS -->
                    </div>
                    <hr>
                    <div class="text-center">
                        <div id="countdown-timer" class="display-6 fw-bold text-primary">
                            --:--:--
                        </div>
                        <small class="text-muted">bis zum Termin</small>
                    </div>
                </div>
            </div>

            <!-- Статистика -->
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">Heute</h5>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-6 mb-3">
                            <div class="h3 text-primary" id="today-count">0</div>
                            <small class="text-muted">Termine</small>
                        </div>
                        <div class="col-6 mb-3">
                            <div class="h3 text-success" id="week-fill-rate">0%</div>
                            <small class="text-muted">Auslastung</small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Быстрые действия -->
            <div class="card mt-3">
                <div class="card-header">
                    <h6 class="card-title mb-0">Schnellzugriff</h6>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <a href="{{ url_for('doctor_web.bookings') }}" class="btn btn-outline-primary">
                            <i class="bi bi-calendar-check"></i> Buchungen verwalten
                        </a>
                        <a href="{{ url_for('doctor_web.calendar') }}" class="btn btn-outline-success">
                            <i class="bi bi-calendar"></i> Kalender verwalten
                        </a>
                        <a href="{{ url_for('doctor_web.profile') }}" class="btn btn-outline-secondary">
                            <i class="bi bi-person"></i> Profil
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Левая колонка - Таймлайн дня -->
        <div class="col-md-8 order-md-1">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-list-ul"></i> Heutige Termine</h5>
                </div>
                <div class="card-body">
                    <div id="timeline-container">
                        <!-- Timeline загружается через renderTimeline() -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block dashboard_scripts %}
<style>
.timeline {
    position: relative;
    padding-left: 30px;
}

.timeline-item {
    position: relative;
    padding-bottom: 20px;
    border-left: 2px solid #dee2e6;
    margin-left: 10px;
}

.timeline-item:last-child {
    border-left: 2px solid transparent;
}

.timeline-marker {
    position: absolute;
    left: -11px;
    background: white;
}

.timeline-marker i {
    font-size: 1.2rem;
}

.timeline-content {
    padding-left: 15px;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    loadDashboard();
});

async function loadDashboard() {
    const token = localStorage.getItem('access_token');
    
    if (!token) {
        // Нет токена - перенаправляем на вход
        window.location.href = '/doctor/login';
        return;
    }
    
    try {
        const response = await fetch('/api/doctors/dashboard', {
            method: 'GET',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            }
        });
        
        if (response.ok) {
            const data = await response.json();
            
            // Обновляем счетчики
            if (data.today && data.today.appointments) {
                document.getElementById('today-count').textContent = data.today.appointments.length;
                renderTimeline(data.today.appointments);
            } else {
                document.getElementById('today-count').textContent = '0';
            }
            
            if (data.this_week) {
                const fillRate = Math.round(data.this_week.fill_rate || 0);
                document.getElementById('week-fill-rate').textContent = `${fillRate}%`;
            } else {
                document.getElementById('week-fill-rate').textContent = '0%';
            }
            
            // Обновляем следующий термин
            if (data.today && data.today.next_appointment) {
                displayNextAppointment(data.today.next_appointment);
                startCountdown(data.today.next_appointment.start_time);
            } else {
                const card = document.getElementById('next-appointment-card');
                if (card) {
                    card.querySelector('.card-body').innerHTML = `
                        <div class="text-center text-muted p-4">
                            <i class="bi bi-calendar-x" style="font-size: 2rem;"></i>
                            <p class="mt-2">Keine Termine heute</p>
                        </div>
                    `;
                }
            }
            
            // Запускаем часы
            startClock();
            
            // Показываем контент
            document.getElementById('loading').style.display = 'none';
            document.getElementById('dashboard-content').style.display = 'block';
            
        } else if (response.status === 401) {
            // Токен истек или недействителен
            localStorage.removeItem('access_token');
            localStorage.removeItem('doctor_id');
            window.location.href = '/doctor/login';
        } else {
            throw new Error('Failed to load dashboard');
        }
        
    } catch (error) {
        console.error('Error loading dashboard:', error);
        document.getElementById('loading').innerHTML = `
            <div class="alert alert-danger">
                <h6>Fehler beim Laden des Dashboards</h6>
                <p>Bitte versuchen Sie es später erneut.</p>
                <button class="btn btn-primary" onclick="window.location.reload()">Erneut versuchen</button>
            </div>
        `;
    }
}

// Годинник в реальному часі
function startClock() {
    updateClock();
    setInterval(updateClock, 1000);
}

function updateClock() {
    const now = new Date();
    
    // Оновлюємо час
    const timeStr = now.toLocaleTimeString('de-DE', { 
        hour: '2-digit', 
        minute: '2-digit',
        second: '2-digit'
    });
    document.getElementById('current-time').textContent = timeStr;
    
    // Оновлюємо дату
    const dateStr = now.toLocaleDateString('de-DE', { 
        weekday: 'long',
        year: 'numeric', 
        month: 'long', 
        day: 'numeric' 
    });
    document.getElementById('current-date').textContent = dateStr;
}

// Таймер до наступного терміну
let countdownInterval = null;

function startCountdown(startTimeISO) {
    if (countdownInterval) {
        clearInterval(countdownInterval);
    }
    
    updateCountdown(startTimeISO);
    countdownInterval = setInterval(() => updateCountdown(startTimeISO), 1000);
}

function updateCountdown(startTimeISO) {
    const now = new Date();
    const appointmentTime = new Date(startTimeISO);
    const diff = appointmentTime - now;
    
    if (diff <= 0) {
        document.getElementById('countdown-timer').innerHTML = `
            <span class="text-danger">ЗАРАЗ</span>
        `;
        if (countdownInterval) {
            clearInterval(countdownInterval);
        }
        return;
    }
    
    const hours = Math.floor(diff / (1000 * 60 * 60));
    const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
    const seconds = Math.floor((diff % (1000 * 60)) / 1000);
    
    let timeStr = '';
    if (hours > 0) {
        timeStr = `${hours}h ${minutes}m`;
    } else if (minutes > 0) {
        timeStr = `${minutes}m ${seconds}s`;
    } else {
        timeStr = `${seconds}s`;
    }
    
    document.getElementById('countdown-timer').textContent = timeStr;
}

// Відображення наступного терміну
function displayNextAppointment(appointment) {
    const time = new Date(appointment.start_time).toLocaleTimeString('de-DE', { 
        hour: '2-digit', 
        minute: '2-digit'
    });
    
    const info = `
        <div class="text-center">
            <div class="mb-2">
                <i class="bi bi-person-circle" style="font-size: 2rem;"></i>
            </div>
            <h6 class="mb-1">${appointment.patient_name || 'Пацієнт'}</h6>
            <p class="text-muted mb-0">
                <i class="bi bi-clock"></i> ${time}
            </p>
            ${appointment.patient_phone ? `
                <p class="text-muted small mb-0">
                    <i class="bi bi-telephone"></i> ${appointment.patient_phone}
                </p>
            ` : ''}
        </div>
    `;
    
    document.getElementById('next-appointment-info').innerHTML = info;
}

// Таймлайн дня
function renderTimeline(appointments) {
    const container = document.getElementById('timeline-container');
    if (!container || !appointments || appointments.length === 0) {
        if (container) {
            container.innerHTML = '<p class="text-muted text-center">Keine Termine heute</p>';
        }
        return;
    }
    
    const now = new Date();
    const sortedAppts = [...appointments].sort((a, b) => 
        new Date(a.start_time) - new Date(b.start_time)
    );
    
    let html = '<div class="timeline">';
    
    sortedAppts.forEach((appt, index) => {
        const apptTime = new Date(appt.start_time);
        const timeStr = apptTime.toLocaleTimeString('de-DE', { 
            hour: '2-digit', 
            minute: '2-digit'
        });
        
        const isPast = apptTime < now;
        const isCurrent = !isPast && (index === 0 || new Date(sortedAppts[index-1].start_time) < now);
        
        let statusClass = 'text-muted';
        let icon = 'bi-circle';
        
        if (isPast) {
            statusClass = 'text-success';
            icon = 'bi-check-circle-fill';
        } else if (isCurrent) {
            statusClass = 'text-primary';
            icon = 'bi-arrow-right-circle-fill';
        }
        
        html += `
            <div class="timeline-item ${statusClass}">
                <div class="timeline-marker">
                    <i class="bi ${icon}"></i>
                </div>
                <div class="timeline-content">
                    <div class="fw-bold">${timeStr}</div>
                    <div class="small">${appt.patient_name || 'Пацієнт'}</div>
                </div>
            </div>
        `;
    });
    
    html += '</div>';
    container.innerHTML = html;
}

function setupCalendar() {
    // Показываем модальное окно для настройки календаря
    const modal = document.createElement('div');
    modal.className = 'modal fade';
    modal.id = 'calendarSetupModal';
    modal.innerHTML = `
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Kalender einrichten</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="calendar-form">
                        <div class="mb-3">
                            <label class="form-label">Dauer eines Termins (Minuten)</label>
                            <select class="form-select" id="slot-duration" required>
                                <option value="15">15 Minuten</option>
                                <option value="20">20 Minuten</option>
                                <option value="30" selected>30 Minuten</option>
                                <option value="45">45 Minuten</option>
                                <option value="60">60 Minuten</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Pause zwischen Terminen (Minuten)</label>
                            <select class="form-select" id="buffer-time">
                                <option value="0">Keine Pause</option>
                                <option value="5" selected>5 Minuten</option>
                                <option value="10">10 Minuten</option>
                                <option value="15">15 Minuten</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Arbeitszeiten</label>
                            <div id="working-hours">
                                <!-- Дни недели будут добавлены через JS -->
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Abbrechen</button>
                    <button type="button" class="btn btn-primary" onclick="createCalendar()">Kalender erstellen</button>
                </div>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
    
    // Инициализируем дни недели
    const days = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];
    const dayNames = {
        'monday': 'Montag',
        'tuesday': 'Dienstag', 
        'wednesday': 'Mittwoch',
        'thursday': 'Donnerstag',
        'friday': 'Freitag',
        'saturday': 'Samstag',
        'sunday': 'Sonntag'
    };
    
    const workingHoursDiv = document.getElementById('working-hours');
    days.forEach(day => {
        const dayDiv = document.createElement('div');
        dayDiv.className = 'mb-2';
        dayDiv.innerHTML = `
            <div class="form-check">
                <input class="form-check-input" type="checkbox" id="${day}-enabled" ${day !== 'sunday' ? 'checked' : ''}>
                <label class="form-check-label" for="${day}-enabled">
                    ${dayNames[day]}
                </label>
            </div>
            <div id="${day}-times" class="ms-3" ${day !== 'sunday' ? '' : 'style="display:none;"'}>
                <div class="row g-2">
                    <div class="col-md-5">
                        <input type="time" class="form-control" id="${day}-start" value="09:00">
                    </div>
                    <div class="col-md-1 text-center">-</div>
                    <div class="col-md-5">
                        <input type="time" class="form-control" id="${day}-end" value="18:00">
                    </div>
                </div>
            </div>
        `;
        workingHoursDiv.appendChild(dayDiv);
        
        // Обработчик изменения чекбокса
        document.getElementById(`${day}-enabled`).addEventListener('change', function() {
            document.getElementById(`${day}-times`).style.display = this.checked ? 'block' : 'none';
        });
    });
    
    // Показываем модальное окно
    const bsModal = new bootstrap.Modal(modal);
    bsModal.show();
    
    // Удаляем модальное окно после закрытия
    modal.addEventListener('hidden.bs.modal', function() {
        document.body.removeChild(modal);
    });
}

async function createCalendar() {
    const token = localStorage.getItem('access_token');
    const slotDuration = document.getElementById('slot-duration').value;
    const bufferTime = document.getElementById('buffer-time').value;
    
    // Собираем рабочие часы
    const workingHours = {};
    const days = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];
    
    days.forEach(day => {
        const enabled = document.getElementById(`${day}-enabled`).checked;
        if (enabled) {
            const start = document.getElementById(`${day}-start`).value;
            const end = document.getElementById(`${day}-end`).value;
            workingHours[day] = [{'start': start, 'end': end}];
        } else {
            workingHours[day] = [];
        }
    });
    
    try {
        const response = await fetch('/api/doctors/calendar/create', {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                working_hours: workingHours,
                slot_duration: parseInt(slotDuration),
                buffer_time: parseInt(bufferTime)
            })
        });
        
        if (response.ok) {
            // Закрываем модальное окно и перезагружаем dashboard
            const modal = document.getElementById('calendarSetupModal');
            const bsModal = bootstrap.Modal.getInstance(modal);
            bsModal.hide();
            
            // Перезагружаем dashboard
            loadDashboard();
            
            alert('Kalender erfolgreich erstellt!');
        } else {
            const error = await response.json();
            alert('Fehler: ' + error.error);
        }
    } catch (error) {
        console.error('Error creating calendar:', error);
        alert('Fehler beim Erstellen des Kalenders');
    }
}

function addTimeSlot() {
    // Показываем модальное окно для генерации слотов
    const modal = document.createElement('div');
    modal.className = 'modal fade';
    modal.id = 'slotGenerationModal';
    modal.innerHTML = `
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Termine generieren</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="slot-form">
                        <div class="mb-3">
                            <label class="form-label">Datum</label>
                            <input type="date" class="form-control" id="slot-date" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Abbrechen</button>
                    <button type="button" class="btn btn-primary" onclick="generateSlots()">Termine generieren</button>
                </div>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
    
    // Устанавливаем сегодняшнюю дату
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('slot-date').value = today;
    
    // Показываем модальное окно
    const bsModal = new bootstrap.Modal(modal);
    bsModal.show();
    
    // Удаляем модальное окно после закрытия
    modal.addEventListener('hidden.bs.modal', function() {
        document.body.removeChild(modal);
    });
}

async function generateSlots() {
    const token = localStorage.getItem('access_token');
    const date = document.getElementById('slot-date').value;
    
    try {
        const response = await fetch('/api/doctors/calendar/slots', {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                action: 'generate',
                date: date
            })
        });
        
        if (response.ok) {
            // Закрываем модальное окно
            const modal = document.getElementById('slotGenerationModal');
            const bsModal = bootstrap.Modal.getInstance(modal);
            bsModal.hide();
            
            alert('Termine erfolgreich generiert!');
        } else {
            const error = await response.json();
            alert('Fehler: ' + error.error);
        }
    } catch (error) {
        console.error('Error generating slots:', error);
        alert('Fehler beim Generieren der Termine');
    }
}
</script>
{% endblock %}

{% block toolbar %}
<button class="btn btn-sm btn-outline-success" id="add-slot-btn" style="display: none;" onclick="addTimeSlot()">
    <i class="bi bi-plus"></i> Termin hinzufügen
</button>
{% endblock %}