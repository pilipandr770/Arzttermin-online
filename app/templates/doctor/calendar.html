{% extends "base_dashboard.html" %}
{% set title = "Kalender verwalten" %}
{% set user_type = "doctor" %}

{% block dashboard_content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="card-title mb-0">Kalender verwalten</h5>
                        <div class="btn-group" role="group">
                            <button type="button" class="btn btn-outline-primary btn-sm" id="view-month">
                                <i class="bi bi-calendar-month"></i> Monat
                            </button>
                            <button type="button" class="btn btn-outline-primary btn-sm" id="view-week">
                                <i class="bi bi-calendar-week"></i> Woche
                            </button>
                            <button type="button" class="btn btn-outline-primary btn-sm active" id="view-day">
                                <i class="bi bi-calendar-day"></i> Tag
                            </button>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ –¥–∞—Ç–∞–º -->
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <button class="btn btn-outline-secondary" id="nav-prev">
                            <i class="bi bi-chevron-left"></i>
                        </button>
                        <h6 class="mb-0" id="current-period">Heute</h6>
                        <button class="btn btn-outline-secondary" id="nav-next">
                            <i class="bi bi-chevron-right"></i>
                        </button>
                        <button class="btn btn-outline-primary ms-3" id="go-today">
                            <i class="bi bi-calendar-event"></i> Heute
                        </button>
                    </div>

                    <!-- –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π -->
                    <div class="mb-4">
                        <button class="btn btn-success" id="generate-slots">
                            <i class="bi bi-plus-circle"></i> Termine generieren
                        </button>
                        <button class="btn btn-primary" id="refresh-calendar">
                            <i class="bi bi-arrow-clockwise"></i> Aktualisieren
                        </button>
                        <button class="btn btn-outline-info" id="test-api">
                            <i class="bi bi-bug"></i> API Test
                        </button>
                        <a href="{{ url_for('doctor_web.schedule_settings') }}" class="btn btn-outline-secondary">
                            <i class="bi bi-gear"></i> Zeitplan einstellen
                        </a>
                    </div>

                    <!-- –ö–∞–ª–µ–Ω–¥–∞—Ä—å -->
                    <div id="calendar-container">
                        <div class="alert alert-info">Lade Kalender...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –¥–µ—Ç–∞–ª–µ–π —Å–ª–æ—Ç–∞ -->
<div class="modal fade" id="slotModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="slotModalTitle">Termin Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="slotModalBody">
                <!-- –î–µ—Ç–∞–ª–∏ —Å–ª–æ—Ç–∞ –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∑–¥–µ—Å—å -->
            </div>
            <div class="modal-footer" id="slotModalFooter">
                <!-- –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã –∑–¥–µ—Å—å -->
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block dashboard_scripts %}
<script>
console.log('=== CALENDAR SCRIPT LOADED ===');

let currentView = 'day';
let currentDate = new Date();
let calendarData = {};

document.addEventListener('DOMContentLoaded', function() {
    console.log('=== DOCTOR CALENDAR PAGE LOADED ===');
    console.log('Current URL:', window.location.href);
    console.log('DOM ready, checking elements...');

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É—é—Ç –ª–∏ –∫–Ω–æ–ø–∫–∏
    const viewMonthBtn = document.getElementById('view-month');
    const viewWeekBtn = document.getElementById('view-week');
    const viewDayBtn = document.getElementById('view-day');
    const navPrevBtn = document.getElementById('nav-prev');
    const navNextBtn = document.getElementById('nav-next');
    const goTodayBtn = document.getElementById('go-today');
    const generateSlotsBtn = document.getElementById('generate-slots');
    const refreshCalendarBtn = document.getElementById('refresh-calendar');
    const testApiBtn = document.getElementById('test-api');

    console.log('Buttons found:', {
        viewMonth: !!viewMonthBtn,
        viewWeek: !!viewWeekBtn,
        viewDay: !!viewDayBtn,
        navPrev: !!navPrevBtn,
        navNext: !!navNextBtn,
        goToday: !!goTodayBtn,
        generateSlots: !!generateSlotsBtn,
        refreshCalendar: !!refreshCalendarBtn,
        testApi: !!testApiBtn
    });

    updatePeriodTitle();
    loadCalendar();

    // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π –¥–ª—è –∫–Ω–æ–ø–æ–∫
    if (viewMonthBtn) {
        viewMonthBtn.addEventListener('click', () => {
            console.log('Month view clicked');
            setView('month');
        });
    }
    if (viewWeekBtn) {
        viewWeekBtn.addEventListener('click', () => {
            console.log('Week view clicked');
            setView('week');
        });
    }
    if (viewDayBtn) {
        viewDayBtn.addEventListener('click', () => {
            console.log('Day view clicked');
            setView('day');
        });
    }

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
    if (navPrevBtn) {
        navPrevBtn.addEventListener('click', () => {
            console.log('Previous clicked');
            navigateDate(-1);
        });
    }
    if (navNextBtn) {
        navNextBtn.addEventListener('click', () => {
            console.log('Next clicked');
            navigateDate(1);
        });
    }

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ "Heute"
    if (goTodayBtn) {
        goTodayBtn.addEventListener('click', () => {
            console.log('Go to today clicked');
            goToToday();
        });
    }

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ "Termine generieren"
    if (generateSlotsBtn) {
        generateSlotsBtn.addEventListener('click', () => {
            console.log('Generate slots clicked');
            generateSlots();
        });
    }

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ "Aktualisieren"
    if (refreshCalendarBtn) {
        refreshCalendarBtn.addEventListener('click', () => {
            console.log('Refresh calendar clicked');
            loadCalendar();
        });
    }

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ "API Test"
    if (testApiBtn) {
        console.log('testApiBtn found, adding event listener');
        testApiBtn.addEventListener('click', () => {
            console.log('Test API clicked - event listener triggered');
            testAPI();
        });
    } else {
        console.log('testApiBtn NOT found!');
    }

    console.log('=== EVENT LISTENERS ADDED ===');
});

function setView(view) {
    console.log('setView called with:', view);
    currentView = view;

    // –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—É—é –∫–Ω–æ–ø–∫—É
    document.querySelectorAll('.btn-group .btn').forEach(btn => btn.classList.remove('active'));
    document.getElementById(`view-${view}`).classList.add('active');

    loadCalendar();
}

function navigateDate(direction) {
    if (currentView === 'month') {
        currentDate.setMonth(currentDate.getMonth() + direction);
    } else if (currentView === 'week') {
        currentDate.setDate(currentDate.getDate() + (direction * 7));
    } else { // day
        currentDate.setDate(currentDate.getDate() + direction);
    }
    updatePeriodTitle();
    loadCalendar();
}

function goToToday() {
    currentDate = new Date();
    updatePeriodTitle();
    loadCalendar();
}

function updatePeriodTitle() {
    const title = document.getElementById('current-period');

    if (currentView === 'month') {
        title.textContent = currentDate.toLocaleDateString('de-DE', { year: 'numeric', month: 'long' });
    } else if (currentView === 'week') {
        const monday = new Date(currentDate);
        monday.setDate(currentDate.getDate() - currentDate.getDay() + 1);
        const sunday = new Date(monday);
        sunday.setDate(monday.getDate() + 6);
        title.textContent = `${monday.toLocaleDateString('de-DE', { day: '2-digit', month: '2-digit' })} - ${sunday.toLocaleDateString('de-DE', { day: '2-digit', month: '2-digit', year: 'numeric' })}`;
    } else { // day
        title.textContent = currentDate.toLocaleDateString('de-DE', { weekday: 'long', day: '2-digit', month: 'long', year: 'numeric' });
    }
}

async function loadCalendar() {
    const container = document.getElementById('calendar-container');

    let token;
    try {
        token = localStorage.getItem('access_token');
    } catch (e) {
        console.warn('localStorage not available:', e);
        container.innerHTML = `
            <div class="alert alert-warning">
                <h5>üîí Speicherzugriff blockiert</h5>
                <p>Ihr Browser blockiert den Zugriff auf den lokalen Speicher aus Sicherheitsgr√ºnden.</p>
                <p>Bitte erlauben Sie Cookies und Speicher f√ºr diese Website:</p>
                <ol>
                    <li>Klicken Sie auf das üîí Schloss-Symbol in der Adressleiste</li>
                    <li>W√§hlen Sie "Cookies und Website-Daten" ‚Üí "Zulassen"</li>
                    <li>Oder √∂ffnen Sie diese Seite in einem privaten/incognito Fenster</li>
                    <li>Melden Sie sich erneut an</li>
                </ol>
                <div class="mt-3">
                    <a href="/doctor/login" class="btn btn-primary">Zur Anmeldung</a>
                    <a href="/doctor/calendar-test" class="btn btn-outline-secondary ms-2">Test-Seite (funktioniert ohne localStorage)</a>
                </div>
            </div>
        `;
        return;
    }

    console.log('Loading calendar, token present:', !!token);

    if (!token) {
        container.innerHTML = `
            <div class="alert alert-danger">
                <h5>‚ùå Nicht angemeldet</h5>
                <p>Sie m√ºssen sich zuerst anmelden, um Ihren Kalender zu sehen.</p>
                <div class="mt-3">
                    <a href="/doctor/login" class="btn btn-primary">Anmelden</a>
                    <a href="/doctor/calendar-test" class="btn btn-outline-secondary ms-2">Test-Seite</a>
                </div>
            </div>
        `;
        return;
    }

    container.innerHTML = '<div class="alert alert-info">Lade Kalender...</div>';

    try {
        let startDate, endDate;

        if (currentView === 'month') {
            startDate = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
            endDate = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0);
        } else if (currentView === 'week') {
            const monday = new Date(currentDate);
            monday.setDate(currentDate.getDate() - currentDate.getDay() + 1);
            startDate = new Date(monday);
            endDate = new Date(monday);
            endDate.setDate(monday.getDate() + 6);
        } else { // day
            startDate = new Date(currentDate);
            endDate = new Date(currentDate);
        }

        console.log('Fetching slots for:', startDate.toISOString().split('T')[0], 'to', endDate.toISOString().split('T')[0]);

        const response = await fetch(`/api/doctors/calendar/slots?start_date=${startDate.toISOString().split('T')[0]}&end_date=${endDate.toISOString().split('T')[0]}`, {
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            }
        });

        console.log('Response status:', response.status);

        if (response.ok) {
            const data = await response.json();
            console.log('Received slots:', data.slots ? data.slots.length : 0);
            calendarData = data;
            displayCalendar(data.slots);
        } else {
            const error = await response.text();
            console.error('API Error:', error);
            container.innerHTML = `<div class="alert alert-danger">Fehler beim Laden: ${response.status}</div>`;
        }
    } catch (error) {
        console.error('Network error:', error);
        container.innerHTML = `<div class="alert alert-danger">Netzwerkfehler: ${error.message}</div>`;
    }
}

function displayCalendar(slots) {
    const container = document.getElementById('calendar-container');

    if (currentView === 'month') {
        displayMonthView(slots);
    } else if (currentView === 'week') {
        displayWeekView(slots);
    } else { // day
        displayDayView(slots);
    }
}

function displayDayView(slots) {
    console.log('Displaying day view with', slots.length, 'slots');

    const container = document.getElementById('calendar-container');

    if (slots.length === 0) {
        container.innerHTML = '<div class="text-center py-5"><p class="text-muted">Keine Termine f√ºr dieses Datum gefunden.</p></div>';
        return;
    }

    let html = '<div class="row">';

    slots.forEach(slot => {
        const isBooked = slot.status === 'booked';
        const statusClass = isBooked ? 'border-primary bg-primary bg-opacity-10' : 'border-success';
        const statusText = isBooked ? 'Gebucht' : 'Verf√ºgbar';
        const startTime = new Date(slot.start_time).toLocaleTimeString('de-DE', {hour: '2-digit', minute: '2-digit'});
        const endTime = new Date(slot.end_time).toLocaleTimeString('de-DE', {hour: '2-digit', minute: '2-digit'});

        html += `
            <div class="col-md-6 col-lg-4 mb-3">
                <div class="card ${statusClass}" onclick="showSlotDetails('${slot.id}')">
                    <div class="card-body">
                        <h6 class="card-title">${startTime} - ${endTime}</h6>
                        <p class="card-text">
                            <span class="badge ${isBooked ? 'bg-primary' : 'bg-success'}">
                                ${isBooked ? '<i class="bi bi-person-check"></i> ' : ''}${statusText}
                            </span>
                        </p>
                    </div>
                </div>
            </div>
        `;
    });

    html += '</div>';
    container.innerHTML = html;
}

function displayMonthView(slots) {
    // –ó–∞–≥–ª—É—à–∫–∞ –¥–ª—è –º–µ—Å—è—á–Ω–æ–≥–æ –≤–∏–¥–∞
    const container = document.getElementById('calendar-container');
    container.innerHTML = '<div class="alert alert-info">Monatsansicht wird noch implementiert</div>';
}

function displayWeekView(slots) {
    // –ó–∞–≥–ª—É—à–∫–∞ –¥–ª—è –Ω–µ–¥–µ–ª—å–Ω–æ–≥–æ –≤–∏–¥–∞
    const container = document.getElementById('calendar-container');
    container.innerHTML = '<div class="alert alert-info">Wochenansicht wird noch implementiert</div>';
}

function showSlotDetails(slotId) {
    const slot = calendarData.slots.find(s => s.id === slotId);
    if (!slot) return;

    const modal = new bootstrap.Modal(document.getElementById('slotModal'));
    const title = document.getElementById('slotModalTitle');
    const body = document.getElementById('slotModalBody');
    const footer = document.getElementById('slotModalFooter');

    const startTime = new Date(slot.start_time).toLocaleString('de-DE');
    const endTime = new Date(slot.end_time).toLocaleString('de-DE');

    title.textContent = `Termin: ${startTime.split(',')[1].trim()}`;

    body.innerHTML = `
        <p><strong>Zeit:</strong> ${startTime} - ${endTime}</p>
        <p><strong>Status:</strong> <span class="badge ${slot.status === 'booked' ? 'bg-primary' : 'bg-success'}">${slot.status === 'booked' ? 'Gebucht' : 'Verf√ºgbar'}</span></p>
    `;

    footer.innerHTML = '<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Schlie√üen</button>';
    modal.show();
}

async function generateSlots() {
    let token;
    try {
        token = localStorage.getItem('access_token');
    } catch (e) {
        console.warn('localStorage not available:', e);
        alert('Speicherzugriff blockiert. Bitte erlauben Sie Cookies und Speicher f√ºr diese Seite.');
        return;
    }

    if (!token) {
        alert('Sie sind nicht angemeldet. Bitte melden Sie sich an.');
        return;
    }

    const date = currentDate.toISOString().split('T')[0];

    try {
        const response = await fetch('/api/doctors/calendar/generate-slots', {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ weeks_ahead: 1 })
        });

        if (response.ok) {
            loadCalendar();
        } else {
            alert('Fehler beim Generieren der Termine');
        }
    } catch (error) {
        console.error('Error generating slots:', error);
        alert('Fehler beim Generieren der Termine');
    }
}

async function testAPI() {
    console.log('=== testAPI function called ===');
    const container = document.getElementById('calendar-container');
    console.log('Container found:', !!container);
    container.innerHTML = '<div class="alert alert-info">üîç –¢–µ—Å—Ç–∏—Ä—É—é API...</div>';

    let token;
    try {
        token = localStorage.getItem('access_token');
    } catch (e) {
        container.innerHTML = '<div class="alert alert-danger">‚ùå localStorage –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω</div>';
        return;
    }

    if (!token) {
        container.innerHTML = '<div class="alert alert-danger">‚ùå –ù–µ—Ç —Ç–æ–∫–µ–Ω–∞. –í–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É.</div>';
        return;
    }

    try {
        const response = await fetch('/api/doctors/calendar/slots?start_date=2026-01-28&end_date=2026-01-28', {
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });

        if (response.ok) {
            const data = await response.json();
            const slots = data.slots || [];
            
            let html = `<div class="alert alert-success">‚úÖ API —Ä–∞–±–æ—Ç–∞–µ—Ç! –ü–æ–ª—É—á–µ–Ω–æ ${slots.length} —Å–ª–æ—Ç–æ–≤.</div>`;
            html += '<div class="row">';
            
            slots.forEach(slot => {
                const isBooked = slot.status === 'booked';
                const statusClass = isBooked ? 'border-primary bg-primary bg-opacity-10' : 'border-success';
                const statusText = isBooked ? 'Gebucht' : 'Verf√ºgbar';
                const time = new Date(slot.start_time).toLocaleTimeString('de-DE', {hour: '2-digit', minute: '2-digit'});
                
                html += `
                    <div class="col-md-6 col-lg-4 mb-3">
                        <div class="card ${statusClass}">
                            <div class="card-body">
                                <h6 class="card-title">${time}</h6>
                                <p class="card-text">
                                    <span class="badge ${isBooked ? 'bg-primary' : 'bg-success'}">
                                        ${isBooked ? '<i class="bi bi-person-check"></i> ' : ''}${statusText}
                                    </span>
                                </p>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            html += '<div class="mt-3"><button class="btn btn-primary" onclick="loadCalendar()">–í–µ—Ä–Ω—É—Ç—å—Å—è –∫ –∫–∞–ª–µ–Ω–¥–∞—Ä—é</button></div>';
            
            container.innerHTML = html;
        } else {
            container.innerHTML = `<div class="alert alert-danger">‚ùå API –æ—à–∏–±–∫–∞: ${response.status}</div>`;
        }
    } catch (error) {
        container.innerHTML = `<div class="alert alert-danger">‚ùå –°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞: ${error.message}</div>`;
    }
}

// –î–µ–ª–∞–µ–º —Ñ—É–Ω–∫—Ü–∏–∏ –≥–ª–æ–±–∞–ª—å–Ω–æ –¥–æ—Å—Ç—É–ø–Ω—ã–º–∏
window.setView = setView;
window.navigateDate = navigateDate;
window.goToToday = goToToday;
window.loadCalendar = loadCalendar;
window.generateSlots = generateSlots;
window.testAPI = testAPI;
window.showSlotDetails = showSlotDetails;
</script>
{% endblock dashboard_scripts %}