{% extends "base_dashboard.html" %}
{% set title = "Termine verwalten" %}
{% set user_type = "doctor" %}

{% block dashboard_content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">Alle Termine</h5>
                </div>
                <div class="card-body">
                    <!-- –§–∏–ª—å—Ç—Ä—ã -->
                    <div class="mb-4">
                        <div class="row g-3">
                            <div class="col-md-3">
                                <label class="form-label">Status</label>
                                <select class="form-select" id="status-filter">
                                    <option value="">Alle</option>
                                    <option value="confirmed">Best√§tigt</option>
                                    <option value="cancelled">Storniert</option>
                                    <option value="completed">Abgeschlossen</option>
                                    <option value="no_show">Nicht erschienen</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Datum von</label>
                                <input type="date" class="form-control" id="date-from">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Datum bis</label>
                                <input type="date" class="form-control" id="date-to">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">&nbsp;</label>
                                <button class="btn btn-primary w-100" id="filter-button">
                                    <i class="bi bi-search"></i> Filtern
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- –°–ø–∏—Å–æ–∫ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π -->
                    <div id="bookings-container">
                        <p class="text-muted">Lade Termine...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –¥–µ—Ç–∞–ª–µ–π –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è -->
<div class="modal fade" id="bookingModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Termindetails</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="booking-details">
                <!-- –î–µ—Ç–∞–ª–∏ –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã —á–µ—Ä–µ–∑ JS -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Schlie√üen</button>
                <button type="button" class="btn btn-danger" id="cancel-booking-btn" style="display: none;" onclick="cancelBooking()">
                    Termin stornieren
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block dashboard_scripts %}
<script>
console.log('=== BOOKINGS SCRIPT LOADED ===');

async function loadBookings() {
    console.log('loadBookings function called');
    try {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø –∫ localStorage
        let token;
        try {
            token = localStorage.getItem('access_token');
        } catch (e) {
            console.warn('localStorage not available:', e);
            const container = document.getElementById('bookings-container');
            container.innerHTML = `
                <div class="alert alert-warning">
                    <h5>üîí Speicherzugriff blockiert</h5>
                    <p>Ihr Browser blockiert den Zugriff auf den lokalen Speicher aus Sicherheitsgr√ºnden.</p>
                    <p>Bitte erlauben Sie Cookies und Speicher f√ºr diese Website:</p>
                    <ol>
                        <li>Klicken Sie auf das üîí Schloss-Symbol in der Adressleiste</li>
                        <li>W√§hlen Sie "Cookies und Website-Daten" ‚Üí "Zulassen"</li>
                        <li>Oder √∂ffnen Sie diese Seite in einem privaten/incognito Fenster</li>
                    </ol>
                    <button class="btn btn-primary mt-2" onclick="loadBookings()">
                        <i class="bi bi-arrow-clockwise"></i> Erneut versuchen
                    </button>
                </div>
            `;
            return;
        }

        if (!token) {
            const container = document.getElementById('bookings-container');
            container.innerHTML = '<div class="alert alert-danger">Sie sind nicht angemeldet. Bitte melden Sie sich an.</div>';
            return;
        }

        const status = document.getElementById('status-filter').value;
        const dateFrom = document.getElementById('date-from').value;
        const dateTo = document.getElementById('date-to').value;

        const container = document.getElementById('bookings-container');
        container.innerHTML = '<div class="text-center"><div class="spinner-border"></div> Lade Termine...</div>';

        // –°—Ç—Ä–æ–∏–º URL —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏
        let url = '/api/doctors/bookings';
        const params = new URLSearchParams();
        if (status) params.append('status', status);
        if (dateFrom) params.append('date_from', dateFrom);
        if (dateTo) params.append('date_to', dateTo);
        if (params.toString()) url += '?' + params.toString();

        const response = await fetch(url, {
            method: 'GET',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            }
        });

        if (response.ok) {
            const data = await response.json();
            displayBookings(data.bookings);
        } else {
            container.innerHTML = '<div class="alert alert-danger">Fehler beim Laden der Termine</div>';
        }
    } catch (error) {
        console.error('Error loading bookings:', error);
        const container = document.getElementById('bookings-container');
        if (error.name === 'SecurityError') {
            container.innerHTML = '<div class="alert alert-warning">Speicherzugriff blockiert. Bitte erlauben Sie Cookies und Speicher f√ºr diese Seite.</div>';
        } else {
            container.innerHTML = '<div class="alert alert-danger">Netzwerkfehler beim Laden der Termine</div>';
        }
    }
}

// –î–µ–ª–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é –≥–ª–æ–±–∞–ª—å–Ω–æ –¥–æ—Å—Ç—É–ø–Ω–æ–π
window.loadBookings = loadBookings;
window.viewBooking = viewBooking;
window.cancelBooking = cancelBooking;

document.addEventListener('DOMContentLoaded', function() {
    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –¥–∞—Ç—ã –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 30 –¥–Ω–µ–π)
    const today = new Date();
    const thirtyDaysAgo = new Date();
    thirtyDaysAgo.setDate(today.getDate() - 30);

    document.getElementById('date-to').value = today.toISOString().split('T')[0];
    document.getElementById('date-from').value = thirtyDaysAgo.toISOString().split('T')[0];

    // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–±—ã—Ç–∏—è –¥–ª—è –∫–Ω–æ–ø–∫–∏ —Ñ–∏–ª—å—Ç—Ä–∞
    const filterButton = document.getElementById('filter-button');
    if (filterButton) {
        filterButton.addEventListener('click', loadBookings);
    }

    loadBookings();
});

function displayBookings(bookings) {
    const container = document.getElementById('bookings-container');

    if (bookings.length === 0) {
        container.innerHTML = '<p class="text-muted">Keine Termine gefunden.</p>';
        return;
    }

    let html = '<div class="table-responsive"><table class="table table-striped">';
    html += `
        <thead>
            <tr>
                <th>Datum</th>
                <th>Uhrzeit</th>
                <th>Patient</th>
                <th>Status</th>
                <th>Buchungscode</th>
                <th>Aktionen</th>
            </tr>
        </thead>
        <tbody>
    `;

    bookings.forEach(booking => {
        const statusClass = getStatusClass(booking.status);
        const statusText = getStatusText(booking.status);

        html += `
            <tr>
                <td>${booking.date}</td>
                <td>${booking.time}</td>
                <td>${booking.patient_name}</td>
                <td><span class="badge bg-${statusClass}">${statusText}</span></td>
                <td><code>${booking.booking_code}</code></td>
                <td>
                    <button class="btn btn-sm btn-outline-primary" onclick="viewBooking('${booking.id}')">
                        <i class="bi bi-eye"></i> Details
                    </button>
                </td>
            </tr>
        `;
    });

    html += '</tbody></table></div>';
    container.innerHTML = html;
}

function getStatusClass(status) {
    switch (status) {
        case 'confirmed': return 'success';
        case 'cancelled': return 'danger';
        case 'completed': return 'info';
        case 'no_show': return 'warning';
        default: return 'secondary';
    }
}

function getStatusText(status) {
    switch (status) {
        case 'confirmed': return 'Best√§tigt';
        case 'cancelled': return 'Storniert';
        case 'completed': return 'Abgeschlossen';
        case 'no_show': return 'Nicht erschienen';
        default: return status;
    }
}

async function viewBooking(bookingId) {
    // –ü–æ–∫–∞ —á—Ç–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–æ—Å—Ç–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ, —Ç–∞–∫ –∫–∞–∫ –Ω–µ—Ç API –¥–ª—è –¥–µ—Ç–∞–ª–µ–π –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
    const modal = new bootstrap.Modal(document.getElementById('bookingModal'));
    const details = document.getElementById('booking-details');

    details.innerHTML = `
        <div class="alert alert-info">
            <h6>Details werden geladen...</h6>
            <p>Booking ID: ${bookingId}</p>
            <p>Diese Funktion wird in K√ºrze verf√ºgbar sein.</p>
        </div>
    `;

    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –æ—Ç–º–µ–Ω—ã –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–Ω—ã—Ö –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π
    document.getElementById('cancel-booking-btn').style.display = 'inline-block';

    modal.show();
}

function cancelBooking() {
    if (confirm('Sind Sie sicher, dass Sie diesen Termin stornieren m√∂chten?')) {
        alert('Funktion wird in K√ºrze verf√ºgbar sein.');
        // TODO: –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –æ—Ç–º–µ–Ω—É –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
    }
}

// Make functions globally accessible
window.loadBookings = loadBookings;
window.viewBooking = viewBooking;
window.cancelBooking = cancelBooking;
</script>
{% endblock dashboard_scripts %}