{% extends "base_dashboard.html" %}
{% set title = "Termin Kalender" %}
{% set user_type = "patient" %}

{% block dashboard_content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <!-- Фильтры календаря -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="card-title mb-0">Verfügbare Termine</h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-3">
                            <label class="form-label">Spezialisierung</label>
                            <select class="form-select" id="calendar-speciality">
                                <option value="">Alle Spezialisierungen</option>
                                {% for key, spec in specialities.items() %}
                                <option value="{{ key }}">{{ spec.de }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Arzt</label>
                            <select class="form-select" id="calendar-doctor">
                                <option value="">Alle Ärzte</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Datum von</label>
                            <input type="date" class="form-control" id="calendar-start-date">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Datum bis</label>
                            <input type="date" class="form-control" id="calendar-end-date">
                        </div>
                    </div>
                    <div class="mt-3">
                        <button class="btn btn-primary" onclick="loadCalendar()">
                            <i class="bi bi-calendar"></i> Kalender laden
                        </button>
                        <button class="btn btn-outline-secondary" onclick="clearCalendarFilters()">
                            <i class="bi bi-x-circle"></i> Filter löschen
                        </button>
                    </div>
                </div>
            </div>

            <!-- Календарь -->
            <div id="calendar-content">
                <div class="text-center py-5">
                    <i class="bi bi-calendar text-muted" style="font-size: 3rem;"></i>
                    <p class="text-muted mt-3">Wählen Sie Filter aus und laden Sie den Kalender.</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно для бронирования -->
<div class="modal fade" id="bookingModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Termin buchen</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="slot-details">
                    <!-- Детали слота будут загружены -->
                </div>
                <div class="mt-3">
                    <button type="button" class="btn btn-primary" onclick="bookSlot()">
                        <i class="bi bi-check-circle"></i> Termin buchen
                    </button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Abbrechen</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let currentSlotId = null;

document.addEventListener('DOMContentLoaded', function() {
    // Устанавливаем даты по умолчанию
    const today = new Date();
    const nextWeek = new Date(today);
    nextWeek.setDate(today.getDate() + 7);

    document.getElementById('calendar-start-date').value = today.toISOString().split('T')[0];
    document.getElementById('calendar-end-date').value = nextWeek.toISOString().split('T')[0];

    // Загружаем список врачей
    loadDoctors();
});

async function loadDoctors() {
    const token = localStorage.getItem('access_token');
    
    if (!token) {
        window.location.href = '/patient/login';
        return;
    }
    
    try {
        const response = await fetch('/api/patient/search/doctors', {
            method: 'GET',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            }
        });

        if (response.ok) {
            const data = await response.json();
            const doctorSelect = document.getElementById('calendar-doctor');
            doctorSelect.innerHTML = '<option value="">Alle Ärzte</option>';

            data.doctors.forEach(doctor => {
                const option = document.createElement('option');
                option.value = doctor.id;
                option.textContent = `${doctor.first_name} ${doctor.last_name} (${doctor.speciality})`;
                doctorSelect.appendChild(option);
            });
        }
    } catch (error) {
        console.error('Error loading doctors:', error);
    }
}

// Переменная для отслеживания раскрытых карточек
const expandedDoctorsCalendar = new Set();

async function loadCalendar() {
    const speciality = document.getElementById('calendar-speciality').value;
    const doctorId = document.getElementById('calendar-doctor').value;
    const startDate = document.getElementById('calendar-start-date').value;
    const endDate = document.getElementById('calendar-end-date').value;

    if (!startDate || !endDate) {
        alert('Bitte wählen Sie Start- und Enddatum aus.');
        return;
    }

    const calendarContent = document.getElementById('calendar-content');
    calendarContent.innerHTML = '<div class="text-center py-5"><div class="spinner-border"></div><p>Lade Kalender...</p></div>';

    try {
        // Используем новый API для поиска с количеством слотов
        const params = new URLSearchParams();
        if (speciality) params.append('speciality', speciality);
        if (doctorId) params.append('doctor_id', doctorId);
        params.append('date_from', startDate);
        params.append('date_to', endDate);

        const response = await fetch(`/api/search/doctors/available?${params}`);

        if (!response.ok) {
            throw new Error('Failed to load doctors');
        }

        const data = await response.json();

        if (data.doctors.length === 0) {
            calendarContent.innerHTML = '<div class="text-center py-5"><i class="bi bi-search text-muted" style="font-size: 3rem;"></i><p class="text-muted mt-3">Keine Ärzte gefunden.</p></div>';
            return;
        }

        // Создаем компактный список врачей
        let calendarHtml = '<div class="row">';

        for (const doctor of data.doctors) {
            const practice = doctor.practice || {};
            const practiceName = practice.name || '';
            const practiceCity = practice.city || '';
            const website = practice.website || '';
            const googleBusiness = practice.google_business_url || '';
            const phone = practice.phone || '';

            calendarHtml += `
                <div class="col-md-6 col-lg-4 mb-3" id="calendar-doctor-card-${doctor.id}">
                    <div class="card h-100">
                        <div class="card-body">
                            <h6 class="mb-2">
                                <i class="bi bi-person-circle text-primary"></i>
                                ${doctor.full_name}
                            </h6>
                            <p class="text-primary mb-2 small">${doctor.speciality_display}</p>
                            ${practiceName ? `<p class="text-muted mb-1 small"><i class="bi bi-hospital"></i> ${practiceName}</p>` : ''}
                            ${practiceCity ? `<p class="text-muted mb-2 small"><i class="bi bi-geo-alt"></i> ${practiceCity}</p>` : ''}
                            
                            <!-- Quick Links -->
                            ${(website || googleBusiness || phone) ? `
                            <div class="mb-2 d-flex gap-2">
                                ${website ? `<a href="${website}" target="_blank" class="btn btn-sm btn-outline-primary" title="Website"><i class="bi bi-globe"></i></a>` : ''}
                                ${googleBusiness ? `<a href="${googleBusiness}" target="_blank" class="btn btn-sm btn-outline-info" title="Google Business"><i class="bi bi-google"></i></a>` : ''}
                                ${phone ? `<a href="tel:${phone}" class="btn btn-sm btn-outline-secondary" title="Anrufen"><i class="bi bi-telephone"></i></a>` : ''}
                            </div>
                            ` : ''}
                            
                            <div class="mb-2">
                                <span class="badge bg-success">
                                    <i class="bi bi-calendar-check"></i> ${doctor.free_slots_count} freie Termine
                                </span>
                            </div>
                            <button class="btn btn-sm btn-primary w-100" onclick="toggleCalendarDoctorSlots('${doctor.id}', '${startDate}', '${endDate}')" id="calendar-toggle-btn-${doctor.id}">
                                <i class="bi bi-chevron-down"></i> Termine anzeigen
                            </button>
                            
                            <!-- Контейнер для слотов -->
                            <div id="calendar-slots-container-${doctor.id}" class="mt-3" style="display: none;">
                                <hr>
                                <div class="text-center">
                                    <div class="spinner-border spinner-border-sm"></div> Lade Termine...
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        calendarHtml += '</div>';
        calendarContent.innerHTML = calendarHtml;

    } catch (error) {
        console.error('Error loading calendar:', error);
        calendarContent.innerHTML = '<div class="alert alert-danger"><i class="bi bi-exclamation-triangle"></i> Fehler beim Laden des Kalenders.</div>';
    }
}

async function toggleCalendarDoctorSlots(doctorId, startDate, endDate) {
    const container = document.getElementById(`calendar-slots-container-${doctorId}`);
    const button = document.getElementById(`calendar-toggle-btn-${doctorId}`);
    
    // Если уже раскрыто - скрываем
    if (expandedDoctorsCalendar.has(doctorId)) {
        container.style.display = 'none';
        button.innerHTML = '<i class="bi bi-chevron-down"></i> Termine anzeigen';
        expandedDoctorsCalendar.delete(doctorId);
        return;
    }
    
    // Раскрываем и загружаем слоты
    container.style.display = 'block';
    button.innerHTML = '<i class="bi bi-chevron-up"></i> Termine ausblenden';
    expandedDoctorsCalendar.add(doctorId);
    
    // Загружаем слоты через новый API
    try {
        const params = new URLSearchParams();
        params.append('date_from', startDate);
        params.append('date_to', endDate);
        
        const response = await fetch(`/api/search/doctors/${doctorId}/slots?${params}`);

        if (response.ok) {
            const data = await response.json();
            displayCalendarDoctorSlots(doctorId, data);
        } else {
            container.innerHTML = '<div class="alert alert-danger">Fehler beim Laden der Termine</div>';
        }
    } catch (error) {
        console.error('Error loading slots:', error);
        container.innerHTML = '<div class="alert alert-danger">Fehler beim Laden der Termine</div>';
    }
}

function displayCalendarDoctorSlots(doctorId, data) {
    const container = document.getElementById(`calendar-slots-container-${doctorId}`);
    
    if (Object.keys(data.slots_by_date).length === 0) {
        container.innerHTML = '<p class="text-muted text-center">Keine Termine verfügbar</p>';
        return;
    }
    
    let html = '<div class="slots-list" style="max-height: 400px; overflow-y: auto;">';
    
    const sortedDates = Object.keys(data.slots_by_date).sort();
    
    sortedDates.forEach(date => {
        const slots = data.slots_by_date[date];
        const dateObj = new Date(date);
        const formattedDate = dateObj.toLocaleDateString('de-DE', {
            weekday: 'long',
            year: 'numeric',
            month: 'long',
            day: 'numeric'
        });
        
        html += `
            <div class="mb-3">
                <h6 class="text-primary">
                    <i class="bi bi-calendar3"></i> ${formattedDate}
                </h6>
                <div class="row g-2">
        `;
        
        slots.forEach(slot => {
            html += `
                <div class="col-6 col-md-3">
                    <button class="btn btn-outline-success btn-sm w-100" onclick="showBookingModal('${slot.id}', '${date}T${slot.start_time}:00', '${data.doctor.first_name} ${data.doctor.last_name}')">
                        <i class="bi bi-clock"></i> ${slot.start_time}
                    </button>
                </div>
            `;
        });
        
        html += `
                </div>
            </div>
        `;
    });
    
    html += '</div>';
    container.innerHTML = html;
}

function showBookingModal(slotId, startTime, doctorName) {
    currentSlotId = slotId;
    const slotDate = new Date(startTime);
    const formattedDateTime = slotDate.toLocaleString('de-DE');

    document.getElementById('slot-details').innerHTML = `
        <p><strong>Arzt:</strong> ${doctorName}</p>
        <p><strong>Datum & Zeit:</strong> ${formattedDateTime}</p>
        <p class="text-muted">Möchten Sie diesen Termin buchen?</p>
    `;

    const modal = new bootstrap.Modal(document.getElementById('bookingModal'));
    modal.show();
}

async function bookSlot() {
    if (!currentSlotId) return;

    try {
        const response = await fetch('/api/patient/book', {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${localStorage.getItem('access_token')}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ slot_id: currentSlotId })
        });

        const data = await response.json();

        if (response.ok) {
            alert(`Termin erfolgreich gebucht!\n\nBuchungscode: ${data.booking_code || data.booking_id}\nArzt: ${data.doctor_name}\n${data.date} um ${data.time}\n\nSie werden zu Ihren Terminen weitergeleitet...`);
            bootstrap.Modal.getInstance(document.getElementById('bookingModal')).hide();
            // Перенаправляем на страницу букингов
            window.location.href = '/patient/bookings';
        } else {
            alert(data.error || 'Fehler beim Buchen des Termins');
        }
    } catch (error) {
        console.error('Error booking slot:', error);
        alert('Fehler beim Buchen des Termins');
    }
}

function clearCalendarFilters() {
    document.getElementById('calendar-speciality').value = '';
    document.getElementById('calendar-doctor').value = '';
    document.getElementById('calendar-start-date').value = '';
    document.getElementById('calendar-end-date').value = '';

    const today = new Date();
    const nextWeek = new Date(today);
    nextWeek.setDate(today.getDate() + 7);

    document.getElementById('calendar-start-date').value = today.toISOString().split('T')[0];
    document.getElementById('calendar-end-date').value = nextWeek.toISOString().split('T')[0];
}
</script>
{% endblock %}