{% extends "base_dashboard.html" %}
{% set title = "Arzt suchen" %}
{% set user_type = "patient" %}

{% block dashboard_content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <!-- Фильтры поиска -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="card-title mb-0">Arzt suchen</h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-4">
                            <label class="form-label">Spezialisierung</label>
                            <select class="form-select" id="search-speciality">
                                <option value="">Alle Spezialisierungen</option>
                                {% for key, spec in specialities.items() %}
                                <option value="{{ key }}">{{ spec.de }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Stadt</label>
                            <div class="position-relative">
                                <input type="text" class="form-control" id="search-city" placeholder="Stadt eingeben" autocomplete="off">
                                <div id="city-autocomplete" class="list-group position-absolute w-100" style="z-index: 1000; display: none; max-height: 300px; overflow-y: auto;"></div>
                            </div>
                            <small class="text-muted">
                                <button type="button" class="btn btn-link btn-sm p-0" onclick="getUserLocation()">
                                    <i class="bi bi-geo-alt"></i> Meinen Standort verwenden
                                </button>
                            </small>
                        </div>
                    </div>
                    <div class="mt-3">
                        <button class="btn btn-primary" onclick="searchDoctors()">
                            <i class="bi bi-search"></i> Suchen
                        </button>
                        <button class="btn btn-outline-secondary" onclick="clearFilters()">
                            <i class="bi bi-x-circle"></i> Filter löschen
                        </button>
                    </div>
                </div>
            </div>

            <!-- Результаты поиска -->
            <div id="search-results">
                <div class="text-center py-5">
                    <i class="bi bi-search text-muted" style="font-size: 3rem;"></i>
                    <p class="text-muted mt-3">Verwenden Sie die Filter oben, um Ärzte zu suchen.</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно для просмотра всех слотов врача -->
<div class="modal fade" id="searchSlotsModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="searchSlotsModalTitle">Verfügbare Termine</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="searchSlotsModalBody" style="max-height: 70vh; overflow-y: auto;">
                <div class="text-center">
                    <div class="spinner-border"></div>
                    <p class="mt-2">Lade Termine...</p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block dashboard_scripts %}
<style>
.slots-list {
    max-height: 400px;
    overflow-y: auto;
}

.hover-shadow {
    transition: all 0.3s ease;
}

.hover-shadow:hover {
    box-shadow: 0 8px 16px rgba(0,0,0,0.15) !important;
    transform: translateY(-2px);
}

.highlight-pulse {
    animation: highlightPulse 3s ease-in-out;
    box-shadow: 0 0 0 0 rgba(13, 110, 253, 0.7);
}

@keyframes highlightPulse {
    0% {
        box-shadow: 0 0 0 0 rgba(13, 110, 253, 0.7);
    }
    50% {
        box-shadow: 0 0 20px 10px rgba(13, 110, 253, 0.4);
    }
    100% {
        box-shadow: 0 0 0 0 rgba(13, 110, 253, 0);
    }
}

#slots-container {
    animation: slideDown 0.3s ease-out;
}

@keyframes slideDown {
    from {
        opacity: 0;
        max-height: 0;
    }
    to {
        opacity: 1;
        max-height: 1000px;
    }
}

.mini-gallery {
    display: flex;
    gap: 4px;
    overflow-x: auto;
    margin-bottom: 8px;
}

.mini-gallery img {
    width: 60px;
    height: 60px;
    object-fit: cover;
    border-radius: 4px;
    cursor: pointer;
    transition: transform 0.2s;
}

.mini-gallery img:hover {
    transform: scale(1.1);
}

.star-rating {
    color: #ffc107;
}

.feature-icon {
    font-size: 1.2rem;
    margin-right: 4px;
}

/* NEW: Interactive elements */
.clickable-badge {
    cursor: pointer;
    transition: transform 0.2s, box-shadow 0.2s;
}

.clickable-badge:hover {
    transform: scale(1.05);
    box-shadow: 0 2px 8px rgba(0,0,0,0.2);
}

.clickable-icon {
    cursor: pointer;
    transition: all 0.2s;
}

.clickable-icon:hover {
    transform: scale(1.1);
    filter: brightness(1.2);
}

.clickable-text {
    cursor: pointer;
    transition: color 0.2s;
}

.clickable-text:hover {
    color: #0d6efd !important;
}

.toggle-icon {
    transition: transform 0.3s;
    display: inline-block;
    font-size: 0.8rem;
}

.doctor-photo-clickable:hover {
    opacity: 0.9;
    transform: scale(1.02);
    transition: all 0.3s;
}

.feature-badge {
    font-size: 1rem;
    padding: 0.4rem 0.6rem;
    margin: 0.1rem;
}

.gallery-thumb {
    cursor: pointer;
    transition: transform 0.2s, box-shadow 0.2s;
}

.gallery-thumb:hover {
    transform: scale(1.15);
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    z-index: 10;
}

.collapse {
    transition: all 0.3s ease-in-out;
}

/* NEW: Info sections buttons (8 sections) */
.info-sections {
    margin-top: 1rem;
}

.info-btn-full {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.75rem 1rem;
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    border: 1px solid #dee2e6;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s ease;
    font-size: 0.9rem;
    font-weight: 500;
    color: #495057;
    text-align: left;
}

.info-btn-full:hover {
    background: linear-gradient(135deg, #e9ecef 0%, #dee2e6 100%);
    border-color: #0d6efd;
    box-shadow: 0 4px 12px rgba(13, 110, 253, 0.15);
    transform: translateY(-2px);
}

.info-btn-full i:first-child {
    font-size: 1.2rem;
    color: #0d6efd;
}

.info-btn-full .toggle-chevron {
    font-size: 0.9rem;
    transition: transform 0.3s;
    color: #6c757d;
}

.info-btn-full .badge {
    font-size: 0.7rem;
}

.info-btn-full.btn-slots-available {
    background: linear-gradient(135deg, #d1f4e0 0%, #a8e6cf 100%);
    border-color: #198754;
}

.info-btn-full.btn-slots-available:hover {
    background: linear-gradient(135deg, #a8e6cf 0%, #7fd3ae 100%);
    box-shadow: 0 4px 12px rgba(25, 135, 84, 0.25);
}

.info-btn-full.btn-slots-none {
    background: linear-gradient(135deg, #f1f3f5 0%, #e9ecef 100%);
    border-color: #ced4da;
}

.info-btn-full.btn-slots-none:hover {
    background: linear-gradient(135deg, #e9ecef 0%, #dee2e6 100%);
}

.info-content {
    margin-top: 0.5rem;
    padding: 1rem;
    background-color: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 6px;
    font-size: 0.9rem;
    line-height: 1.6;
}

.info-content ul {
    padding-left: 1.5rem;
    margin-bottom: 0;
}

.info-content ul.list-unstyled {
    padding-left: 0;
}

.info-content li {
    margin-bottom: 0.5rem;
    line-height: 1.5;
}

.info-content li i {
    font-size: 0.9em;
}

.info-content li:last-child {
    margin-bottom: 0;
}

.collapse.show {
    animation: slideDown 0.3s ease-out;
}

</style>

<script>
console.log('=== SEARCH PAGE SCRIPT LOADED ===');
// Specialities data from server
const SPECIALITIES_DATA = {{ specialities|tojson|safe }};

// Helper function to generate star rating
function generateStarRating(rating) {
    const fullStars = Math.floor(rating);
    const hasHalfStar = rating % 1 >= 0.5;
    let html = '<span class="star-rating">';
    
    for (let i = 0; i < fullStars; i++) {
        html += '<i class="bi bi-star-fill"></i>';
    }
    
    if (hasHalfStar) {
        html += '<i class="bi bi-star-half"></i>';
    }
    
    const emptyStars = 5 - fullStars - (hasHalfStar ? 1 : 0);
    for (let i = 0; i < emptyStars; i++) {
        html += '<i class="bi bi-star"></i>';
    }
    
    html += ` <strong>${rating.toFixed(1)}</strong></span>`;
    return html;
}

// Helper function to generate features icons
function generateFeaturesIcons(features) {
    if (!features || features.length === 0) return '';
    
    const featureIcons = {
        'wheelchair_accessible': '<i class="bi bi-universal-access feature-icon text-info" title="Barrierefrei"></i>',
        'parking': '<i class="bi bi-p-circle feature-icon text-success" title="Parkplatz"></i>',
        'wifi': '<i class="bi bi-wifi feature-icon text-primary" title="WLAN"></i>',
        'online_booking': '<i class="bi bi-calendar-check feature-icon text-warning" title="Online-Buchung"></i>',
        'video_consultation': '<i class="bi bi-camera-video feature-icon text-danger" title="Video-Konsultation"></i>',
        'emergency_appointments': '<i class="bi bi-lightning feature-icon text-warning" title="Notfall-Termine"></i>'
    };
    
    let html = '<div class="d-flex gap-1 flex-wrap">';
    features.slice(0, 6).forEach(feature => {
        if (featureIcons[feature]) {
            html += featureIcons[feature];
        }
    });
    html += '</div>';
    
    return html;
}

// Helper function to generate insurance badges
function generateInsuranceBadges(insurances) {
    if (!insurances || insurances.length === 0) return '';
    
    let html = '<div class="d-flex gap-1 flex-wrap">';
    insurances.forEach(insurance => {
        const badgeClass = insurance.type === 'public' ? 'bg-success' : 'bg-primary';
        html += `<span class="badge ${badgeClass}" style="font-size: 0.7rem;">${insurance.name}</span>`;
    });
    html += '</div>';
    
    return html;
}

// Helper function to generate mini gallery
function generateMiniGallery(photos) {
    if (!photos || photos.length === 0) return '';
    
    let html = '<div class="mini-gallery mb-2">';
    photos.forEach(photo => {
        html += `<img src="${photo.url}" alt="${photo.title || 'Practice photo'}" onclick="window.open('${photo.url}', '_blank')">`;
    });
    html += '</div>';
    
    return html;
}

// NEW: Interactive features with tooltips
function generateInteractiveFeatures(features, doctorId) {
    if (!features || features.length === 0) return '';
    
    const featureInfo = {
        'wheelchair_accessible': { icon: 'universal-access', color: 'info', text: 'Barrierefrei zugänglich' },
        'parking': { icon: 'p-circle', color: 'success', text: 'Parkplätze vorhanden' },
        'wifi': { icon: 'wifi', color: 'primary', text: 'Kostenloses WLAN' },
        'online_booking': { icon: 'calendar-check', color: 'warning', text: 'Online-Buchung möglich' },
        'video_consultation': { icon: 'camera-video', color: 'danger', text: 'Video-Sprechstunde verfügbar' },
        'emergency_appointments': { icon: 'lightning', color: 'warning', text: 'Notfall-Termine möglich' }
    };
    
    let html = '';
    features.slice(0, 6).forEach(feature => {
        const info = featureInfo[feature];
        if (info) {
            html += `
                <span class="feature-badge badge bg-${info.color} clickable-badge" 
                      data-bs-toggle="tooltip" 
                      data-bs-placement="top" 
                      title="${info.text}">
                    <i class="bi bi-${info.icon}"></i>
                </span>
            `;
        }
    });
    
    return html;
}

// NEW: Generate clickable gallery
function generateClickableGallery(photos, doctorId) {
    if (!photos || photos.length === 0) return '';
    
    let html = '<div class="mini-gallery mb-2">';
    photos.forEach((photo, index) => {
        html += `
            <img src="${typeof photo === 'string' ? photo : photo.url}" 
                 alt="Praxisfoto" 
                 class="gallery-thumb"
                 onclick="showGalleryModal('${doctorId}', ${index})">
        `;
    });
    html += '</div>';
    
    return html;
}

// NEW: Toggle practice details
function togglePracticeDetails(doctorId) {
    const element = document.getElementById(`practice-details-${doctorId}`);
    const icon = document.getElementById(`toggle-practice-${doctorId}`);
    
    if (element.classList.contains('show')) {
        element.classList.remove('show');
        icon.classList.remove('bi-chevron-up');
        icon.classList.add('bi-chevron-down');
    } else {
        element.classList.add('show');
        icon.classList.remove('bi-chevron-down');
        icon.classList.add('bi-chevron-up');
    }
}

// NEW: Toggle doctor bio
function toggleDoctorBio(doctorId) {
    const element = document.getElementById(`doctor-bio-${doctorId}`);
    const icon = document.getElementById(`toggle-bio-${doctorId}`);
    
    if (element.classList.contains('show')) {
        element.classList.remove('show');
        icon.classList.remove('bi-chevron-up');
        icon.classList.add('bi-chevron-down');
    } else {
        element.classList.add('show');
        icon.classList.remove('bi-chevron-down');
        icon.classList.add('bi-chevron-up');
    }
}

// NEW: Toggle info section (8 sections)
function toggleInfoSection(doctorId, section) {
    const element = document.getElementById(`section-${doctorId}-${section}`);
    const chevron = document.getElementById(`chevron-${doctorId}-${section}`);
    
    if (element) {
        if (element.classList.contains('show')) {
            element.classList.remove('show');
            if (chevron) {
                chevron.classList.remove('bi-chevron-up');
                chevron.classList.add('bi-chevron-down');
            }
        } else {
            element.classList.add('show');
            if (chevron) {
                chevron.classList.remove('bi-chevron-down');
                chevron.classList.add('bi-chevron-up');
            }
        }
    }
}

// NEW: Show doctor photo modal
function showDoctorPhotoModal(photoUrl, doctorName) {
    const modalHtml = `
        <div class="modal fade" id="doctorPhotoModal" tabindex="-1">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">${doctorName}</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body text-center">
                        <img src="${photoUrl}" class="img-fluid" alt="${doctorName}">
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Remove existing modal if any
    const existing = document.getElementById('doctorPhotoModal');
    if (existing) existing.remove();
    
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    const modal = new bootstrap.Modal(document.getElementById('doctorPhotoModal'));
    modal.show();
}

// NEW: Show gallery modal
function showGalleryModal(doctorId, startIndex) {
    const data = doctorsData[doctorId];
    if (!data) {
        console.error('Doctor data not found for id:', doctorId);
        return;
    }
    
    const photos = data.practice.gallery_photos || [];
    const practiceName = data.practice.name || '';
    
    if (photos.length === 0) {
        return;
    }
    
    let currentIndex = startIndex;
    
    const showImage = (index) => {
        const photo = photos[index];
        const photoUrl = typeof photo === 'string' ? photo : photo.url;
        const photoTitle = typeof photo === 'string' ? '' : (photo.title || '');
        
        const modalBody = document.getElementById('galleryModalBody');
        modalBody.innerHTML = `
            <img src="${photoUrl}" class="img-fluid" alt="Praxisfoto">
            ${photoTitle ? `<p class="text-center mt-2 mb-0"><small>${photoTitle}</small></p>` : ''}
        `;
        
        // Update navigation
        document.getElementById('galleryPrev').disabled = index === 0;
        document.getElementById('galleryNext').disabled = index === photos.length - 1;
        document.getElementById('galleryCounter').textContent = `${index + 1} / ${photos.length}`;
    };
    
    const modalHtml = `
        <div class="modal fade" id="galleryModal" tabindex="-1">
            <div class="modal-dialog modal-lg modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">
                            <i class="bi bi-images"></i> ${practiceName} - Galerie
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body" id="galleryModalBody">
                        <!-- Image will be inserted here -->
                    </div>
                    <div class="modal-footer justify-content-between">
                        <button type="button" class="btn btn-secondary" id="galleryPrev">
                            <i class="bi bi-chevron-left"></i> Zurück
                        </button>
                        <span id="galleryCounter"></span>
                        <button type="button" class="btn btn-secondary" id="galleryNext">
                            Weiter <i class="bi bi-chevron-right"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Remove existing modal
    const existing = document.getElementById('galleryModal');
    if (existing) existing.remove();
    
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    
    // Setup navigation
    document.getElementById('galleryPrev').addEventListener('click', () => {
        if (currentIndex > 0) {
            currentIndex--;
            showImage(currentIndex);
        }
    });
    
    document.getElementById('galleryNext').addEventListener('click', () => {
        if (currentIndex < photos.length - 1) {
            currentIndex++;
            showImage(currentIndex);
        }
    });
    
    const modal = new bootstrap.Modal(document.getElementById('galleryModal'));
    modal.show();
    showImage(currentIndex);
}

// NEW: Show ratings info
function showRatingsInfo(doctorId, practiceName, ratingAvg, ratingCount) {
    const modalHtml = `
        <div class="modal fade" id="ratingsModal" tabindex="-1">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">
                            <i class="bi bi-star-fill text-warning"></i> Bewertungen
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <h6>${practiceName}</h6>
                        <div class="text-center my-3">
                            <div class="display-4 text-warning">${ratingAvg.toFixed(1)}</div>
                            ${generateStarRating(ratingAvg)}
                            <p class="text-muted mt-2">Basierend auf ${ratingCount} Bewertung${ratingCount !== 1 ? 'en' : ''}</p>
                        </div>
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle"></i> 
                            Detaillierte Bewertungen sind nach Ihrem Termin verfügbar.
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Schließen</button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    const existing = document.getElementById('ratingsModal');
    if (existing) existing.remove();
    
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    const modal = new bootstrap.Modal(document.getElementById('ratingsModal'));
    modal.show();
}

// NEW: Show insurance modal
function showInsuranceModal(doctorId, practiceName) {
    const data = doctorsData[doctorId];
    if (!data) {
        console.error('Doctor data not found for id:', doctorId);
        return;
    }
    
    const insurances = data.practice.accepted_insurances || [];
    if (insurances.length === 0) {
        return;
    }
    
    const publicIns = insurances.filter(i => i.type === 'public');
    const privateIns = insurances.filter(i => i.type === 'private');
    
    const modalHtml = `
        <div class="modal fade" id="insuranceModal" tabindex="-1">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">
                            <i class="bi bi-shield-check"></i> Akzeptierte Versicherungen
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <h6>${practiceName}</h6>
                        
                        ${publicIns.length > 0 ? `
                        <div class="mt-3">
                            <h6 class="text-success">
                                <i class="bi bi-hospital"></i> Gesetzliche Krankenkassen
                            </h6>
                            <div class="d-flex flex-wrap gap-2">
                                ${publicIns.map(i => `<span class="badge bg-success">${i.name}</span>`).join('')}
                            </div>
                        </div>
                        ` : ''}
                        
                        ${privateIns.length > 0 ? `
                        <div class="mt-3">
                            <h6 class="text-primary">
                                <i class="bi bi-star"></i> Private Versicherungen
                            </h6>
                            <div class="d-flex flex-wrap gap-2">
                                ${privateIns.map(i => `<span class="badge bg-primary">${i.name}</span>`).join('')}
                            </div>
                        </div>
                        ` : ''}
                        
                        <div class="alert alert-info mt-3 mb-0">
                            <small>
                                <i class="bi bi-info-circle"></i> 
                                Bitte bestätigen Sie Ihre Versicherung bei der Terminbuchung.
                            </small>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Schließen</button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    const existing = document.getElementById('insuranceModal');
    if (existing) existing.remove();
    
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    const modal = new bootstrap.Modal(document.getElementById('insuranceModal'));
    modal.show();
}

// ==================== CHATBOT MODAL ====================

let currentChatPracticeId = null;
let chatConversationId = null;
let chatHistory = [];

function openChatbotModal(practiceId, practiceName) {
    if (!practiceId) {
        alert('Chatbot ist für diese Praxis nicht verfügbar.');
        return;
    }
    
    currentChatPracticeId = practiceId;
    chatConversationId = null; // Reset conversation
    chatHistory = [];
    
    const modalHtml = `
        <div class="modal fade" id="chatbotModal" tabindex="-1">
            <div class="modal-dialog modal-dialog-scrollable">
                <div class="modal-content" style="height: 80vh;">
                    <div class="modal-header bg-primary text-white">
                        <h5 class="modal-title">
                            <i class="bi bi-robot"></i> Praxis-Assistent: ${practiceName}
                        </h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body p-0 d-flex flex-column" style="height: 100%;">
                        <div class="alert alert-info m-3 mb-0">
                            <i class="bi bi-info-circle"></i> <small><strong>AI-Assistent</strong><br>
                            Ich helfe Ihnen gerne mit Fragen zu Anfahrt, Öffnungszeiten, Leistungen und mehr!</small>
                        </div>
                        <div id="chatMessages" class="flex-grow-1 p-3" style="overflow-y: auto; max-height: calc(80vh - 250px);">
                            <div class="text-center text-muted py-5">
                                <i class="bi bi-chat-dots" style="font-size: 3rem;"></i>
                                <p class="mt-2">Stellen Sie mir eine Frage!</p>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <div class="input-group">
                            <input type="text" class="form-control" id="chatInput" 
                                   placeholder="Ihre Nachricht..." maxlength="1000"
                                   onkeypress="if(event.key === 'Enter') sendChatMessage()">
                            <button class="btn btn-primary" onclick="sendChatMessage()" id="chatSendBtn">
                                <i class="bi bi-send"></i> Senden
                            </button>
                        </div>
                        <small class="text-muted w-100 mt-1">
                            <i class="bi bi-shield-check"></i> Ihre Nachrichten werden vertraulich behandelt
                        </small>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    const existing = document.getElementById('chatbotModal');
    if (existing) existing.remove();
    
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    const modal = new bootstrap.Modal(document.getElementById('chatbotModal'));
    modal.show();
    
    // Focus input field
    document.getElementById('chatbotModal').addEventListener('shown.bs.modal', function() {
        document.getElementById('chatInput').focus();
    });
}

async function sendChatMessage() {
    const input = document.getElementById('chatInput');
    const message = input.value.trim();
    
    if (!message || !currentChatPracticeId) return;
    
    // Disable input during request
    input.disabled = true;
    document.getElementById('chatSendBtn').disabled = true;
    
    // Add user message to chat
    addChatMessage(message, 'user');
    input.value = '';
    
    // Show typing indicator
    const typingId = addChatMessage('...', 'assistant', true);
    
    try {
        const response = await fetch(`/api/chat/${currentChatPracticeId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                message: message,
                conversation_id: chatConversationId
            })
        });
        
        // Remove typing indicator
        const typingMsg = document.getElementById(typingId);
        if (typingMsg) typingMsg.remove();
        
        if (response.ok) {
            const data = await response.json();
            chatConversationId = data.conversation_id;
            addChatMessage(data.reply, 'assistant');
        } else {
            const error = await response.json();
            addChatMessage(error.error || 'Entschuldigung, ein Fehler ist aufgetreten.', 'assistant', false, true);
        }
    } catch (error) {
        // Remove typing indicator
        const typingMsg = document.getElementById(typingId);
        if (typingMsg) typingMsg.remove();
        
        console.error('Chat error:', error);
        addChatMessage('Verbindungsfehler. Bitte versuchen Sie es später erneut.', 'assistant', false, true);
    } finally {
        input.disabled = false;
        document.getElementById('chatSendBtn').disabled = false;
        input.focus();
    }
}

function addChatMessage(text, sender, isTyping = false, isError = false) {
    const messagesDiv = document.getElementById('chatMessages');
    
    // Remove empty state
    const emptyState = messagesDiv.querySelector('.text-center');
    if (emptyState) emptyState.remove();
    
    const messageId = `msg-${Date.now()}-${Math.random()}`;
    const isUser = sender === 'user';
    
    const messageHtml = `
        <div class="d-flex ${isUser ? 'justify-content-end' : 'justify-content-start'} mb-3" id="${messageId}">
            <div class="message-bubble ${isUser ? 'bg-primary text-white' : isError ? 'bg-danger text-white' : 'bg-light'}" 
                 style="max-width: 75%; border-radius: 15px; padding: 10px 15px; ${isTyping ? 'opacity: 0.6;' : ''}">
                ${!isUser && !isTyping ? '<i class="bi bi-robot me-1"></i>' : ''}
                ${isTyping ? '<span class="typing-indicator">...</span>' : text}
            </div>
        </div>
    `;
    
    messagesDiv.insertAdjacentHTML('beforeend', messageHtml);
    
    // Scroll to bottom
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
    
    return messageId;
}

// City autocomplete
let cityAutocompleteTimeout = null;
const cityInput = document.getElementById('search-city');
const cityAutocompleteDiv = document.getElementById('city-autocomplete');

document.addEventListener('DOMContentLoaded', function() {
    console.log('=== DOMContentLoaded EVENT FIRED ===');
    
    // Автокомплит городов
    cityInput.addEventListener('input', function() {
        clearTimeout(cityAutocompleteTimeout);
        const query = this.value.trim();
        
        if (query.length < 2) {
            cityAutocompleteDiv.style.display = 'none';
            return;
        }
        
        cityAutocompleteTimeout = setTimeout(() => {
            fetchCitySuggestions(query);
        }, 300);
    });
    
    // Скрыть автокомплит при клике вне
    document.addEventListener('click', function(e) {
        if (!cityInput.contains(e.target) && !cityAutocompleteDiv.contains(e.target)) {
            cityAutocompleteDiv.style.display = 'none';
        }
    });
    
    // Initialize Bootstrap tooltips for interactive elements
    const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    tooltipTriggerList.forEach(function (tooltipTriggerEl) {
        new bootstrap.Tooltip(tooltipTriggerEl);
    });
    
    // Автоматический поиск при загрузке страницы
    searchDoctors();
});

async function fetchCitySuggestions(query) {
    try {
        const response = await fetch(`/api/search/cities?q=${encodeURIComponent(query)}&limit=10`);
        if (response.ok) {
            const data = await response.json();
            displayCitySuggestions(data.cities);
        }
    } catch (error) {
        console.error('Error fetching city suggestions:', error);
    }
}

function displayCitySuggestions(cities) {
    if (cities.length === 0) {
        cityAutocompleteDiv.style.display = 'none';
        return;
    }
    
    cityAutocompleteDiv.innerHTML = cities.map(city => 
        `<button type="button" class="list-group-item list-group-item-action" onclick="selectCity('${city}')">${city}</button>`
    ).join('');
    
    cityAutocompleteDiv.style.display = 'block';
}

function selectCity(city) {
    cityInput.value = city;
    cityAutocompleteDiv.style.display = 'none';
    searchDoctors();
}

async function getUserLocation() {
    if (!navigator.geolocation) {
        alert('Geolocation wird von Ihrem Browser nicht unterstützt.');
        return;
    }
    
    cityInput.value = 'Suche nach Standort...';
    cityInput.disabled = true;
    
    navigator.geolocation.getCurrentPosition(
        async (position) => {
            const { latitude, longitude } = position.coords;
            console.log('User location:', latitude, longitude);
            
            try {
                // Используем Nominatim API для обратного геокодирования
                const response = await fetch(
                    `https://nominatim.openstreetmap.org/reverse?format=json&lat=${latitude}&lon=${longitude}&addressdetails=1`,
                    {
                        headers: {
                            'User-Agent': 'TerminFinder/1.0'
                        }
                    }
                );
                
                if (response.ok) {
                    const data = await response.json();
                    const city = data.address.city || data.address.town || data.address.village || '';
                    
                    if (city) {
                        cityInput.value = city;
                        searchDoctors();
                    } else {
                        alert('Stadt konnte nicht ermittelt werden.');
                        cityInput.value = '';
                    }
                }
            } catch (error) {
                console.error('Error reverse geocoding:', error);
                alert('Fehler beim Ermitteln des Standorts.');
                cityInput.value = '';
            }
            
            cityInput.disabled = false;
        },
        (error) => {
            console.error('Geolocation error:', error);
            alert('Standort konnte nicht ermittelt werden. Bitte erlauben Sie den Zugriff auf Ihren Standort.');
            cityInput.value = '';
            cityInput.disabled = false;
        },
        {
            enableHighAccuracy: true,
            timeout: 10000,
            maximumAge: 0
        }
    );
}

async function searchDoctors() {
    const speciality = document.getElementById('search-speciality').value;
    const city = document.getElementById('search-city').value;
    
    const resultsDiv = document.getElementById('search-results');
    resultsDiv.innerHTML = '<div class="text-center"><div class="spinner-border"></div> Suche...</div>';
    
    // Используем новый endpoint для поиска с количеством слотов
    const params = new URLSearchParams();
    if (speciality) params.append('speciality', speciality);
    if (city) params.append('city', city);
    
    try {
        const response = await fetch(`/api/search/doctors/available?${params}`, {
            method: 'GET'
        });
        
        if (response.ok) {
            const data = await response.json();
            console.log('Search results:', data);
            console.log('Doctors array:', data.doctors);
            console.log('Doctors length:', data.doctors.length);
            displayDoctors(data.doctors);
        } else {
            resultsDiv.innerHTML = '<div class="alert alert-danger">Fehler bei der Suche</div>';
        }
    } catch (error) {
        console.error('Error searching doctors:', error);
        resultsDiv.innerHTML = '<div class="alert alert-danger">Fehler bei der Suche</div>';
    }
}

// Store doctors data globally for modal access
let doctorsData = {};

async function displayDoctors(doctors) {
    const resultsDiv = document.getElementById('search-results');
    
    // Clear previous data
    doctorsData = {};
    
    console.log('displayDoctors called with doctors array');
    console.log('Is array?', Array.isArray(doctors));
    if (doctors) {
        console.log('Length:', doctors.length);
    }
    
    if (doctors.length === 0) {
        // Получаем текущие критерии поиска
        const speciality = document.getElementById('search-speciality').value;
        const city = document.getElementById('search-city').value;
        
        const specialityName = speciality ? getSpecialityName(speciality) : 'dieser Fachrichtung';
        const cityText = city ? ` in ${city}` : '';
        
        resultsDiv.innerHTML = `
            <div class="text-center py-5">
                <i class="bi bi-search text-muted" style="font-size: 3rem;"></i>
                <h5 class="mt-3">Keine Ärzte gefunden</h5>
                <p class="text-muted">Aktuell keine Termine verfügbar für ${specialityName}${cityText}</p>
                
                <div class="card mt-4 mx-auto" style="max-width: 500px;">
                    <div class="card-body">
                        <h6 class="card-title">
                            <i class="bi bi-bell text-primary"></i> 
                            Benachrichtigung einrichten?
                        </h6>
                        <p class="card-text small text-muted">
                            Wir informieren Sie automatisch, sobald ein Termin verfügbar wird.
                        </p>
                        <button class="btn btn-primary w-100" onclick="createSearchAlert()">
                            <i class="bi bi-bell-fill"></i> Ja, benachrichtigen Sie mich
                        </button>
                        <button class="btn btn-outline-secondary w-100 mt-2" onclick="clearFilters()">
                            Andere Suchkriterien
                        </button>
                    </div>
                </div>
            </div>
        `;
        return;
    }
    
    let html = '<div class="row">';
    
    // Проверяем существующие алерты для всех врачей (только если залогинены)
    const token = localStorage.getItem('access_token');
    let alertExistsMap = {};
    
    if (token) {
        const alertChecks = await Promise.all(doctors.map(async (doctor) => {
            try {
                const response = await fetch('/api/patient/alerts/check', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + token
                    },
                    body: JSON.stringify({
                        doctor_id: doctor.id,
                        speciality: doctor.speciality
                    })
                });
                if (response.ok) {
                    const data = await response.json();
                    return { doctorId: doctor.id, exists: data.exists };
                }
            } catch (error) {
                console.error('Error checking alert:', error);
            }
            return { doctorId: doctor.id, exists: false };
        }));
        
        alertChecks.forEach(check => {
            alertExistsMap[check.doctorId] = check.exists;
        });
    }
    
    doctors.forEach(doctor => {
        const practice = doctor.practice || {};
        const practiceName = practice.name || '';
        const practiceCity = practice.city || '';
        const website = practice.website || '';
        const googleBusiness = practice.google_business_url || '';
        const phone = practice.phone || '';
        const alertExists = alertExistsMap[doctor.id] || false;
        
        // Store doctor data for modal access
        doctorsData[doctor.id] = {
            doctor: doctor,
            practice: practice
        };
        
        // Features & Insurance
        const features = practice.features || [];
        const insurances = practice.accepted_insurances || [];
        
        html += `
            <div class="col-md-6 col-lg-4 mb-4" id="doctor-card-${doctor.id}">
                <div class="card h-100 shadow-sm hover-shadow">
                    <div class="card-body p-3">
                        <!-- Doctor Name & Speciality -->
                        <h5 class="card-title mb-2">
                            ${doctor.full_name_with_title || doctor.full_name}
                        </h5>
                        <p class="text-primary mb-2 fw-bold">
                            <i class="bi bi-person-circle"></i> ${doctor.speciality_display}
                        </p>
                        
                        <!-- Practice Name -->
                        ${practiceName ? `
                        <p class="text-muted mb-2">
                            <i class="bi bi-hospital"></i> ${practiceName}
                        </p>
                        ` : ''}
                        
                        <!-- Languages -->
                        ${doctor.languages && doctor.languages.length > 0 ? `
                        <p class="mb-3">
                            <span class="badge bg-light text-dark border">
                                <i class="bi bi-translate"></i> ${doctor.languages.map(function(l) { return l.toUpperCase(); }).join(', ')}
                            </span>
                        </p>
                        ` : ''}
                        
                        <!-- Information Sections - 7 Profile Sections + Termine (8 total) -->
                        <div class="info-sections mt-3">
                            <!-- 1. Grundinformationen -->
                            <button class="info-btn-full w-100 mb-2" onclick="toggleInfoSection('${doctor.id}', 'grundinfo')">
                                <i class="bi bi-info-circle"></i>
                                <span>Grundinformationen</span>
                                <i class="bi bi-chevron-down ms-auto toggle-chevron" id="chevron-${doctor.id}-grundinfo"></i>
                            </button>
                            <div id="section-${doctor.id}-grundinfo" class="info-content collapse mb-2">
                                ${practiceCity ? `<p class="mb-1"><i class="bi bi-geo-alt text-primary"></i> <strong>Adresse:</strong> ${practiceCity}</p>` : ''}
                                ${phone ? `<p class="mb-1"><i class="bi bi-telephone text-success"></i> <strong>Telefon:</strong> <a href="tel:${phone}">${phone}</a></p>` : ''}
                                ${practice.emergency_phone ? `<p class="mb-1"><i class="bi bi-exclamation-triangle text-danger"></i> <strong>Notfall:</strong> <a href="tel:${practice.emergency_phone}">${practice.emergency_phone}</a></p>` : ''}
                                ${practice.whatsapp_number ? `<p class="mb-1"><i class="bi bi-whatsapp text-success"></i> <strong>WhatsApp:</strong> <a href="https://wa.me/${practice.whatsapp_number.replace(/[^0-9]/g, '')}" target="_blank">Nachricht senden</a></p>` : ''}
                                ${practice.opening_hours ? `<p class="mb-0"><i class="bi bi-clock text-info"></i> <strong>Öffnungszeiten:</strong> ${practice.opening_hours}</p>` : ''}
                            </div>

                            <!-- 2. Medien (Social Media & Links) -->
                            ${(website || googleBusiness || practice.video_url || practice.virtual_tour_url || (practice.social_media && Object.keys(practice.social_media).length > 0)) ? `
                            <button class="info-btn-full w-100 mb-2" onclick="toggleInfoSection('${doctor.id}', 'media')">
                                <i class="bi bi-link-45deg"></i>
                                <span>Medien & Links</span>
                                <i class="bi bi-chevron-down ms-auto toggle-chevron" id="chevron-${doctor.id}-media"></i>
                            </button>
                            <div id="section-${doctor.id}-media" class="info-content collapse mb-2">
                                ${(website || googleBusiness) ? `
                                <div class="mb-3">
                                    <p class="mb-2 fw-bold text-primary"><i class="bi bi-globe me-2"></i>Website & Profile</p>
                                    <div class="d-flex flex-wrap gap-2">
                                        ${website ? `<a href="${website}" target="_blank" class="btn btn-outline-primary btn-sm"><i class="bi bi-globe"></i> Website</a>` : ''}
                                        ${googleBusiness ? `<a href="${googleBusiness}" target="_blank" class="btn btn-outline-danger btn-sm"><i class="bi bi-google"></i> Google Business</a>` : ''}
                                    </div>
                                </div>
                                ` : ''}
                                ${(practice.social_media && Object.values(practice.social_media).some(v => v)) ? `
                                <div class="mb-3">
                                    <p class="mb-2 fw-bold text-primary"><i class="bi bi-share me-2"></i>Soziale Medien</p>
                                    <div class="d-flex flex-wrap gap-2">
                                        ${practice.social_media.facebook ? `<a href="${practice.social_media.facebook}" target="_blank" class="btn btn-outline-primary btn-sm" title="Facebook"><i class="bi bi-facebook"></i></a>` : ''}
                                        ${practice.social_media.instagram ? `<a href="${practice.social_media.instagram}" target="_blank" class="btn btn-outline-danger btn-sm" title="Instagram"><i class="bi bi-instagram"></i></a>` : ''}
                                        ${practice.social_media.linkedin ? `<a href="${practice.social_media.linkedin}" target="_blank" class="btn btn-outline-primary btn-sm" title="LinkedIn"><i class="bi bi-linkedin"></i></a>` : ''}
                                        ${practice.social_media.twitter ? `<a href="${practice.social_media.twitter}" target="_blank" class="btn btn-outline-info btn-sm" title="Twitter/X"><i class="bi bi-twitter"></i></a>` : ''}
                                        ${practice.social_media.youtube ? `<a href="${practice.social_media.youtube}" target="_blank" class="btn btn-outline-danger btn-sm" title="YouTube"><i class="bi bi-youtube"></i></a>` : ''}
                                        ${practice.social_media.tiktok ? `<a href="${practice.social_media.tiktok}" target="_blank" class="btn btn-outline-dark btn-sm" title="TikTok"><i class="bi bi-tiktok"></i></a>` : ''}
                                    </div>
                                </div>
                                ` : ''}
                                ${(practice.video_url || practice.virtual_tour_url) ? `
                                <div>
                                    <p class="mb-2 fw-bold text-primary"><i class="bi bi-camera-video me-2"></i>Multimedia</p>
                                    <div class="d-flex flex-wrap gap-2">
                                        ${practice.video_url ? `<a href="${practice.video_url}" target="_blank" class="btn btn-outline-success btn-sm"><i class="bi bi-play-circle"></i> Video</a>` : ''}
                                        ${practice.virtual_tour_url ? `<a href="${practice.virtual_tour_url}" target="_blank" class="btn btn-outline-info btn-sm"><i class="bi bi-camera"></i> 360° Tour</a>` : ''}
                                    </div>
                                </div>
                                ` : ''}
                            </div>
                            ` : ''}

                            <!-- 3. Leistungen -->
                            ${practice.services && practice.services_list.length > 0 ? `
                            <button class="info-btn-full w-100 mb-2" onclick="toggleInfoSection('${doctor.id}', 'services')">
                                <i class="bi bi-briefcase"></i>
                                <span>Leistungen</span>
                                <span class="badge bg-primary ms-1">${practice.services_list.length}</span>
                                <i class="bi bi-chevron-down ms-auto toggle-chevron" id="chevron-${doctor.id}-services"></i>
                            </button>
                            <div id="section-${doctor.id}-services" class="info-content collapse mb-2">
                                <ul class="list-unstyled mb-0">
                                    ${practice.services_list.map(s => `<li><i class="bi bi-check-circle text-success"></i> ${s}</li>`).join('')}
                                </ul>
                            </div>
                            ` : ''}

                            <!-- 4. Ausstattung -->
                            ${practice.equipment && practice.equipment_list.length > 0 ? `
                            <button class="info-btn-full w-100 mb-2" onclick="toggleInfoSection('${doctor.id}', 'equipment')">
                                <i class="bi bi-gear"></i>
                                <span>Ausstattung</span>
                                <span class="badge bg-info ms-1">${practice.equipment_list.length}</span>
                                <i class="bi bi-chevron-down ms-auto toggle-chevron" id="chevron-${doctor.id}-equipment"></i>
                            </button>
                            <div id="section-${doctor.id}-equipment" class="info-content collapse mb-2">
                                <ul class="list-unstyled mb-0">
                                    ${practice.equipment_list.map(e => `<li><i class="bi bi-check-circle text-info"></i> ${e}</li>`).join('')}
                                </ul>
                            </div>
                            ` : ''}

                            <!-- 5. Versicherungen -->
                            ${insurances.length > 0 ? `
                            <button class="info-btn-full w-100 mb-2" onclick="toggleInfoSection('${doctor.id}', 'insurance')">
                                <i class="bi bi-shield-check"></i>
                                <span>Versicherungen</span>
                                <span class="badge bg-success ms-1">${insurances.length}</span>
                                <i class="bi bi-chevron-down ms-auto toggle-chevron" id="chevron-${doctor.id}-insurance"></i>
                            </button>
                            <div id="section-${doctor.id}-insurance" class="info-content collapse mb-2">
                                ${insurances.filter(i => i.type === 'public').length > 0 ? `
                                <p class="mb-2 fw-bold text-success"><i class="bi bi-shield-fill-check me-2"></i>Gesetzliche:</p>
                                <ul class="list-unstyled ms-3 mb-3">
                                    ${insurances.filter(i => i.type === 'public').map(i => `<li class="mb-1"><i class="bi bi-check-circle-fill text-success me-2"></i>${i.name}</li>`).join('')}
                                </ul>
                                ` : ''}
                                ${insurances.filter(i => i.type === 'private').length > 0 ? `
                                <p class="mb-2 fw-bold text-primary"><i class="bi bi-shield-fill-check me-2"></i>Private:</p>
                                <ul class="list-unstyled ms-3">
                                    ${insurances.filter(i => i.type === 'private').map(i => `<li class="mb-1"><i class="bi bi-check-circle-fill text-primary me-2"></i>${i.name}</li>`).join('')}
                                </ul>
                                ` : ''}
                            </div>
                            ` : ''}

                            <!-- 6. Besonderheiten -->
                            ${features.length > 0 ? `
                            <button class="info-btn-full w-100 mb-2" onclick="toggleInfoSection('${doctor.id}', 'features')">
                                <i class="bi bi-stars"></i>
                                <span>Besonderheiten</span>
                                <span class="badge bg-warning text-dark ms-1">${features.length}</span>
                                <i class="bi bi-chevron-down ms-auto toggle-chevron" id="chevron-${doctor.id}-features"></i>
                            </button>
                            <div id="section-${doctor.id}-features" class="info-content collapse mb-2">
                                <ul class="list-unstyled">
                                    ${features.map(f => `<li class="mb-2"><i class="bi bi-star-fill text-warning me-2"></i>${f}</li>`).join('')}
                                </ul>
                            </div>
                            ` : ''}

                            <!-- 7. FAQ -->
                            ${practice.faq && practice.faq_list.length > 0 ? `
                            <button class="info-btn-full w-100 mb-2" onclick="toggleInfoSection('${doctor.id}', 'faq')">
                                <i class="bi bi-question-circle"></i>
                                <span>FAQ</span>
                                <span class="badge bg-secondary ms-1">${practice.faq_list.length}</span>
                                <i class="bi bi-chevron-down ms-auto toggle-chevron" id="chevron-${doctor.id}-faq"></i>
                            </button>
                            <div id="section-${doctor.id}-faq" class="info-content collapse mb-2">
                                ${practice.faq_list.map(faq => `
                                <div class="mb-2 pb-2 border-bottom">
                                    <p class="mb-1 fw-bold"><small><i class="bi bi-question-circle text-primary"></i> ${faq.question}</small></p>
                                    <p class="mb-0 text-muted"><small><i class="bi bi-arrow-return-right"></i> ${faq.answer}</small></p>
                                </div>
                                `).join('')}
                            </div>
                            ` : ''}

                            <!-- 8. Chatbot - AI Assistant -->
                            <button class="info-btn-full w-100" onclick="openChatbotModal('${doctor.practice_id}', '${doctor.practice_name || doctor.full_name}')">
                                <i class="bi bi-robot"></i>
                                <span>Chatbot - Praxis Assistent</span>
                                <span class="badge bg-info ms-1">AI</span>
                            </button>

                            <!-- 9. Termine -->
                            <button class="info-btn-full w-100 ${doctor.free_slots_count > 0 ? 'btn-slots-available' : 'btn-slots-none'}" 
                                    onclick="${doctor.free_slots_count > 0 ? `openSearchSlotsModal('${doctor.id}', '${doctor.full_name}')` : `toggleInfoSection('${doctor.id}', 'slots')`}">
                                <i class="bi bi-calendar-check"></i>
                                <span>Termine</span>
                                ${doctor.free_slots_count > 0 ? 
                                    `<span class="badge bg-success ms-1">${doctor.free_slots_count} verfügbar</span>` : 
                                    '<span class="badge bg-secondary ms-1">Keine verfügbar</span>'}
                                ${doctor.free_slots_count === 0 ? `<i class="bi bi-chevron-down ms-auto toggle-chevron" id="chevron-${doctor.id}-slots"></i>` : ''}
                            </button>
                            ${doctor.free_slots_count === 0 ? `
                            <div id="section-${doctor.id}-slots" class="info-content collapse">
                                <p class="mb-2 text-muted"><small>Aktuell keine freien Termine verfügbar.</small></p>
                                ${!alertExists ? `
                                <button class="btn btn-sm btn-warning w-100" onclick="createAlert('${doctor.id}', '${doctor.full_name}', '${doctor.speciality}')">
                                    <i class="bi bi-bell"></i> Benachrichtigung einrichten
                                </button>
                                ` : `
                                <p class="text-success mb-0"><i class="bi bi-bell-fill"></i> Benachrichtigung ist aktiv</p>
                                `}
                            </div>
                            ` : ''}
                        </div>
                    </div>
                </div>
            </div>
        `;
    });
    html += '</div>';
    
    resultsDiv.innerHTML = html;
    
    // Проверяем URL параметр highlight для подсветки и автоматического открытия
    const urlParams = new URLSearchParams(window.location.search);
    const highlightDoctorId = urlParams.get('highlight');
    if (highlightDoctorId) {
        // Прокручиваем к карточке врача
        const doctorCard = document.getElementById(`doctor-card-${highlightDoctorId}`);
        if (doctorCard) {
            setTimeout(() => {
                doctorCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
                // Добавляем временную анимацию подсветки
                doctorCard.classList.add('highlight-pulse');
                setTimeout(() => {
                    doctorCard.classList.remove('highlight-pulse');
                }, 3000);
                
                // Автоматически раскрываем все секции для этого врача
                const sections = ['grundinfo', 'media', 'services', 'equipment', 'insurance', 'features', 'faq', 'termine'];
                sections.forEach(section => {
                    const sectionElement = document.getElementById(`section-${highlightDoctorId}-${section}`);
                    if (sectionElement) {
                        sectionElement.classList.add('show');
                        expandedDoctors.add(`${highlightDoctorId}-${section}`);
                        const chevron = document.getElementById(`chevron-${highlightDoctorId}-${section}`);
                        if (chevron) {
                            chevron.style.transform = 'rotate(180deg)';
                        }
                    }
                });
            }, 300);
        }
    }
}

function getSpecialityName(speciality) {
    return SPECIALITIES_DATA[speciality] ? SPECIALITIES_DATA[speciality].de : speciality;
}

// Переменная для отслеживания раскрытых карточек
const expandedDoctors = new Set();

async function openSearchSlotsModal(doctorId, doctorName) {
    const modal = new bootstrap.Modal(document.getElementById('searchSlotsModal'));
    const modalTitle = document.getElementById('searchSlotsModalTitle');
    const modalBody = document.getElementById('searchSlotsModalBody');
    
    modalTitle.textContent = `Verfügbare Termine - ${doctorName}`;
    modalBody.innerHTML = '<div class="text-center"><div class="spinner-border"></div><p class="mt-2">Lade Termine...</p></div>';
    
    modal.show();
    
    try {
        const response = await fetch(`/api/search/doctors/${doctorId}/slots`);

        if (response.ok) {
            const data = await response.json();
            displaySearchSlotsInModal(data, doctorName);
        } else {
            modalBody.innerHTML = '<div class="alert alert-danger">Fehler beim Laden der Termine</div>';
        }
    } catch (error) {
        console.error('Error loading slots:', error);
        modalBody.innerHTML = '<div class="alert alert-danger">Fehler beim Laden der Termine</div>';
    }
}

function displaySearchSlotsInModal(data, doctorName) {
    const modalBody = document.getElementById('searchSlotsModalBody');
    
    if (Object.keys(data.slots_by_date).length === 0) {
        modalBody.innerHTML = '<div class="text-center py-5"><i class="bi bi-calendar-x text-muted" style="font-size: 3rem;"></i><p class="text-muted mt-3">Keine Termine verfügbar</p></div>';
        return;
    }
    
    let html = '';
    const sortedDates = Object.keys(data.slots_by_date).sort();
    
    sortedDates.forEach(date => {
        const slots = data.slots_by_date[date];
        const dateObj = new Date(date);
        const formattedDate = dateObj.toLocaleDateString('de-DE', {
            weekday: 'long',
            year: 'numeric',
            month: 'long',
            day: 'numeric'
        });
        
        html += `
            <div class="mb-4">
                <h5 class="text-primary mb-3">
                    <i class="bi bi-calendar3"></i> ${formattedDate}
                </h5>
                <div class="d-flex flex-wrap gap-2">
        `;
        
        slots.forEach(slot => {
            html += `
                <button class="btn btn-outline-primary" style="min-width: 100px;" onclick="bookSlotFromModal('${slot.id}', '${date}T${slot.start_time}:00', '${doctorName}')">
                    <i class="bi bi-clock"></i> ${slot.start_time.substring(0, 5)}
                </button>
            `;
        });
        
        html += `
                </div>
            </div>
        `;
    });
    
    modalBody.innerHTML = html;
}

async function bookSlotFromModal(slotId, startTime, doctorName) {
    if (!confirm(`Möchten Sie diesen Termin buchen?\n\nArzt: ${doctorName}\nZeit: ${new Date(startTime).toLocaleString('de-DE')}`)) {
        return;
    }
    
    const token = localStorage.getItem('access_token');
    if (!token) {
        alert('Bitte melden Sie sich an, um einen Termin zu buchen.');
        window.location.href = '/patient/login';
        return;
    }
    
    try {
        const response = await fetch('/api/patient/book', {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ slot_id: slotId })
        });

        const data = await response.json();

        if (response.ok) {
            alert(`Termin erfolgreich gebucht!\n\nBuchungscode: ${data.booking_code || data.booking_id}\nArzt: ${data.doctor_name}\n${data.date} um ${data.time}`);
            const modal = bootstrap.Modal.getInstance(document.getElementById('searchSlotsModal'));
            if (modal) modal.hide();
            window.location.href = '/patient/bookings';
        } else {
            if (response.status === 401) {
                alert('Ihre Sitzung ist abgelaufen. Bitte melden Sie sich erneut an.');
                localStorage.removeItem('access_token');
                window.location.href = '/patient/login';
            } else {
                alert('Fehler: ' + (data.error || 'Unbekannter Fehler'));
            }
        }
    } catch (error) {
        console.error('Error booking slot:', error);
        alert('Fehler bei der Buchung: ' + error.message);
    }
}

async function toggleDoctorSlots(doctorId) {
    const container = document.getElementById(`slots-container-${doctorId}`);
    const button = document.getElementById(`toggle-btn-${doctorId}`);
    
    // Если уже раскрыто - скрываем
    if (expandedDoctors.has(doctorId)) {
        container.style.display = 'none';
        button.innerHTML = '<i class="bi bi-chevron-down"></i> Termine anzeigen';
        expandedDoctors.delete(doctorId);
        return;
    }
    
    // Раскрываем и загружаем слоты
    container.style.display = 'block';
    button.innerHTML = '<i class="bi bi-chevron-up"></i> Termine ausblenden';
    expandedDoctors.add(doctorId);
    
    // Загружаем слоты через новый API
    try {
        const response = await fetch(`/api/search/doctors/${doctorId}/slots`, {
            method: 'GET'
        });
        
        if (response.ok) {
            const data = await response.json();
            displayDoctorSlots(doctorId, data);
        } else {
            container.innerHTML = '<div class="alert alert-danger">Fehler beim Laden der Termine</div>';
        }
    } catch (error) {
        console.error('Error loading slots:', error);
        container.innerHTML = '<div class="alert alert-danger">Fehler beim Laden der Termine</div>';
    }
}

function displayDoctorSlots(doctorId, data) {
    const container = document.getElementById(`slots-container-${doctorId}`);
    
    if (Object.keys(data.slots_by_date).length === 0) {
        container.innerHTML = '<p class="text-muted text-center">Keine Termine verfügbar</p>';
        return;
    }
    
    let html = '<div class="slots-list">';
    
    // Сортируем даты
    const sortedDates = Object.keys(data.slots_by_date).sort();
    
    sortedDates.forEach(date => {
        const slots = data.slots_by_date[date];
        html += `
            <div class="mb-3">
                <h6 class="text-primary">
                    <i class="bi bi-calendar3"></i> ${formatDate(date)}
                </h6>
                <div class="row g-2">
        `;
        
        slots.forEach(slot => {
            html += `
                <div class="col-6 col-md-3 col-lg-2">
                    <button class="btn btn-outline-primary btn-sm w-100" onclick="bookSlotDirect('${slot.id}', '${doctorId}', '${date}', '${slot.start_time}')">
                        <i class="bi bi-clock"></i> ${slot.start_time}
                    </button>
                </div>
            `;
        });
        
        html += `
                </div>
            </div>
        `;
    });
    
    html += '</div>';
    container.innerHTML = html;
}

async function bookSlotDirect(slotId, doctorId, date, time) {
    if (!confirm(`Möchten Sie diesen Termin buchen?\n\nDatum: ${formatDate(date)}\nUhrzeit: ${time}`)) {
        return;
    }
    
    const token = localStorage.getItem('access_token');
    if (!token) {
        alert('Bitte melden Sie sich an, um einen Termin zu buchen.');
        window.location.href = '/patient/login';
        return;
    }
    
    try {
        const response = await fetch('/api/patient/book', {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ slot_id: slotId })
        });
        
        const data = await response.json();
        
        if (response.ok) {
            alert(`Termin erfolgreich gebucht!\n\nBuchungscode: ${data.booking_code || data.booking_id}\nArzt: ${data.doctor_name}\n${data.date} um ${data.time}\n\nSie werden zu Ihren Terminen weitergeleitet...`);
            window.location.href = '/patient/bookings';
        } else {
            if (response.status === 401) {
                alert('Ihre Sitzung ist abgelaufen. Bitte melden Sie sich erneut an.');
                localStorage.removeItem('access_token');
                window.location.href = '/patient/login';
            } else {
                alert('Fehler: ' + (data.error || 'Unbekannter Fehler'));
                alert('Fehler: ' + (data.error || 'Unbekannter Fehler'));
            }
        }
    } catch (error) {
        console.error('Error booking slot:', error);
        alert('Fehler bei der Buchung: ' + error.message);
    }
}

async function viewSlots(doctorId) {
    // Эта функция больше не используется, но оставим для совместимости
    toggleDoctorSlots(doctorId);
}

function formatDate(dateStr) {
    const date = new Date(dateStr);
    return date.toLocaleDateString('de-DE', { 
        weekday: 'long', 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric' 
    });
}

// Создать алерт по критериям поиска (когда результатов нет)
async function createSearchAlert() {
    const speciality = document.getElementById('search-speciality').value;
    const city = document.getElementById('search-city').value;
    
    if (!speciality) {
        alert('Bitte wählen Sie mindestens eine Fachrichtung aus');
        return;
    }
    
    const payload = {
        speciality: speciality,
        city: city || null
    };
    
    console.log('Creating search alert with payload:', payload);
    
    try {
        const response = await fetch('/api/patient/alerts', {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${localStorage.getItem('access_token')}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(payload)
        });
        
        if (response.ok) {
            const data = await response.json();
            console.log('Alert created:', data);
            alert('Benachrichtigung erfolgreich eingerichtet!\n\nSie werden informiert, sobald ein Termin verfügbar wird.\n\nSie können Ihre Benachrichtigungen im Dashboard verwalten.');
            // Очищаем результаты и позволяем продолжить поиск
            clearFilters();
        } else {
            const error = await response.json();
            console.error('Error response:', error);
            console.error('Full error details:', JSON.stringify(error, null, 2));
            if (error.error === 'Alert already exists for this doctor/speciality') {
                alert('Sie haben bereits eine Benachrichtigung für diese Suche eingerichtet.\n\nSie können sie in Ihrem Dashboard verwalten.');
                clearFilters();
            } else {
                alert('Fehler: ' + (error.error || 'Konnte Benachrichtigung nicht erstellen'));
            }
        }
    } catch (error) {
        console.error('Error creating alert:', error);
        alert('Fehler beim Erstellen der Benachrichtigung');
    }
}

// Создать алерт для конкретного врача
async function createAlert(doctorId, doctorName, speciality) {
    if (!confirm(`Möchten Sie eine Benachrichtigung einrichten für: ${doctorName}?\n\nSie werden informiert, wenn ein neuer Termin verfügbar wird.`)) {
        return;
    }
    
    const payload = {
        doctor_id: doctorId,
        speciality: speciality
    };
    
    console.log('Creating alert with payload:', payload);
    
    try {
        const response = await fetch('/api/patient/alerts', {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${localStorage.getItem('access_token')}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(payload)
        });
        
        if (response.ok) {
            const data = await response.json();
            console.log('Alert created:', data);
            alert('Benachrichtigung erfolgreich eingerichtet!\n\nSie erhalten eine Nachricht, sobald ein Termin verfügbar wird.');
        } else {
            const error = await response.json();
            console.error('Error response:', error);
            alert('Fehler: ' + (error.error || 'Konnte Benachrichtigung nicht erstellen'));
        }
    } catch (error) {
        console.error('Error creating alert:', error);
        alert('Fehler beim Erstellen der Benachrichtigung');
    }
}


function clearFilters() {
    document.getElementById('search-speciality').value = '';
    document.getElementById('search-city').value = '';
    document.getElementById('search-results').innerHTML = '<div class="text-center py-5 text-muted"><p>Wählen Sie Ihre Suchkriterien und klicken Sie auf "Suchen"</p></div>';
}
</script>
{% endblock dashboard_scripts %}