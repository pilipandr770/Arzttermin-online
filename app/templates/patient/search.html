{% extends "base_dashboard.html" %}
{% set title = "Arzt suchen" %}
{% set user_type = "patient" %}

{% block dashboard_content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <!-- Фильтры поиска -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="card-title mb-0">Arzt suchen</h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-4">
                            <label class="form-label">Spezialisierung</label>
                            <select class="form-select" id="search-speciality">
                                <option value="">Alle Spezialisierungen</option>
                                {% for key, spec in specialities.items() %}
                                <option value="{{ key }}">{{ spec.de }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Stadt</label>
                            <div class="position-relative">
                                <input type="text" class="form-control" id="search-city" placeholder="Stadt eingeben" autocomplete="off">
                                <div id="city-autocomplete" class="list-group position-absolute w-100" style="z-index: 1000; display: none; max-height: 300px; overflow-y: auto;"></div>
                            </div>
                            <small class="text-muted">
                                <button type="button" class="btn btn-link btn-sm p-0" onclick="getUserLocation()">
                                    <i class="bi bi-geo-alt"></i> Meinen Standort verwenden
                                </button>
                            </small>
                        </div>
                    </div>
                    <div class="mt-3">
                        <button class="btn btn-primary" onclick="searchDoctors()">
                            <i class="bi bi-search"></i> Suchen
                        </button>
                        <button class="btn btn-outline-secondary" onclick="clearFilters()">
                            <i class="bi bi-x-circle"></i> Filter löschen
                        </button>
                    </div>
                </div>
            </div>

            <!-- Результаты поиска -->
            <div id="search-results">
                <div class="text-center py-5">
                    <i class="bi bi-search text-muted" style="font-size: 3rem;"></i>
                    <p class="text-muted mt-3">Verwenden Sie die Filter oben, um Ärzte zu suchen.</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно для просмотра всех слотов врача -->
<div class="modal fade" id="searchSlotsModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="searchSlotsModalTitle">Verfügbare Termine</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="searchSlotsModalBody" style="max-height: 70vh; overflow-y: auto;">
                <div class="text-center">
                    <div class="spinner-border"></div>
                    <p class="mt-2">Lade Termine...</p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block dashboard_scripts %}
<style>
.slots-list {
    max-height: 400px;
    overflow-y: auto;
}

.hover-shadow {
    transition: all 0.3s ease;
}

.hover-shadow:hover {
    box-shadow: 0 8px 16px rgba(0,0,0,0.15) !important;
    transform: translateY(-2px);
}

#slots-container {
    animation: slideDown 0.3s ease-out;
}

@keyframes slideDown {
    from {
        opacity: 0;
        max-height: 0;
    }
    to {
        opacity: 1;
        max-height: 1000px;
    }
}

.mini-gallery {
    display: flex;
    gap: 4px;
    overflow-x: auto;
    margin-bottom: 8px;
}

.mini-gallery img {
    width: 60px;
    height: 60px;
    object-fit: cover;
    border-radius: 4px;
    cursor: pointer;
    transition: transform 0.2s;
}

.mini-gallery img:hover {
    transform: scale(1.1);
}

.star-rating {
    color: #ffc107;
}

.feature-icon {
    font-size: 1.2rem;
    margin-right: 4px;
}

/* NEW: Interactive elements */
.clickable-badge {
    cursor: pointer;
    transition: transform 0.2s, box-shadow 0.2s;
}

.clickable-badge:hover {
    transform: scale(1.05);
    box-shadow: 0 2px 8px rgba(0,0,0,0.2);
}

.clickable-icon {
    cursor: pointer;
    transition: all 0.2s;
}

.clickable-icon:hover {
    transform: scale(1.1);
    filter: brightness(1.2);
}

.clickable-text {
    cursor: pointer;
    transition: color 0.2s;
}

.clickable-text:hover {
    color: #0d6efd !important;
}

.toggle-icon {
    transition: transform 0.3s;
    display: inline-block;
    font-size: 0.8rem;
}

.doctor-photo-clickable:hover {
    opacity: 0.9;
    transform: scale(1.02);
    transition: all 0.3s;
}

.feature-badge {
    font-size: 1rem;
    padding: 0.4rem 0.6rem;
    margin: 0.1rem;
}

.gallery-thumb {
    cursor: pointer;
    transition: transform 0.2s, box-shadow 0.2s;
}

.gallery-thumb:hover {
    transform: scale(1.15);
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    z-index: 10;
}

.collapse {
    transition: all 0.3s ease-in-out;
}

.collapse.show {
    animation: slideDown 0.3s ease-out;
}

</style>

<script>
console.log('=== SEARCH PAGE SCRIPT LOADED ===');
// Specialities data from server
const SPECIALITIES_DATA = {{ specialities|tojson|safe }};

// Helper function to generate star rating
function generateStarRating(rating) {
    const fullStars = Math.floor(rating);
    const hasHalfStar = rating % 1 >= 0.5;
    let html = '<span class="star-rating">';
    
    for (let i = 0; i < fullStars; i++) {
        html += '<i class="bi bi-star-fill"></i>';
    }
    
    if (hasHalfStar) {
        html += '<i class="bi bi-star-half"></i>';
    }
    
    const emptyStars = 5 - fullStars - (hasHalfStar ? 1 : 0);
    for (let i = 0; i < emptyStars; i++) {
        html += '<i class="bi bi-star"></i>';
    }
    
    html += ` <strong>${rating.toFixed(1)}</strong></span>`;
    return html;
}

// Helper function to generate features icons
function generateFeaturesIcons(features) {
    if (!features || features.length === 0) return '';
    
    const featureIcons = {
        'wheelchair_accessible': '<i class="bi bi-universal-access feature-icon text-info" title="Barrierefrei"></i>',
        'parking': '<i class="bi bi-p-circle feature-icon text-success" title="Parkplatz"></i>',
        'wifi': '<i class="bi bi-wifi feature-icon text-primary" title="WLAN"></i>',
        'online_booking': '<i class="bi bi-calendar-check feature-icon text-warning" title="Online-Buchung"></i>',
        'video_consultation': '<i class="bi bi-camera-video feature-icon text-danger" title="Video-Konsultation"></i>',
        'emergency_appointments': '<i class="bi bi-lightning feature-icon text-warning" title="Notfall-Termine"></i>'
    };
    
    let html = '<div class="d-flex gap-1 flex-wrap">';
    features.slice(0, 6).forEach(feature => {
        if (featureIcons[feature]) {
            html += featureIcons[feature];
        }
    });
    html += '</div>';
    
    return html;
}

// Helper function to generate insurance badges
function generateInsuranceBadges(insurances) {
    if (!insurances || insurances.length === 0) return '';
    
    let html = '<div class="d-flex gap-1 flex-wrap">';
    insurances.forEach(insurance => {
        const badgeClass = insurance.type === 'public' ? 'bg-success' : 'bg-primary';
        html += `<span class="badge ${badgeClass}" style="font-size: 0.7rem;">${insurance.name}</span>`;
    });
    html += '</div>';
    
    return html;
}

// Helper function to generate mini gallery
function generateMiniGallery(photos) {
    if (!photos || photos.length === 0) return '';
    
    let html = '<div class="mini-gallery mb-2">';
    photos.forEach(photo => {
        html += `<img src="${photo.url}" alt="${photo.title || 'Practice photo'}" onclick="window.open('${photo.url}', '_blank')">`;
    });
    html += '</div>';
    
    return html;
}

// NEW: Interactive features with tooltips
function generateInteractiveFeatures(features, doctorId) {
    if (!features || features.length === 0) return '';
    
    const featureInfo = {
        'wheelchair_accessible': { icon: 'universal-access', color: 'info', text: 'Barrierefrei zugänglich' },
        'parking': { icon: 'p-circle', color: 'success', text: 'Parkplätze vorhanden' },
        'wifi': { icon: 'wifi', color: 'primary', text: 'Kostenloses WLAN' },
        'online_booking': { icon: 'calendar-check', color: 'warning', text: 'Online-Buchung möglich' },
        'video_consultation': { icon: 'camera-video', color: 'danger', text: 'Video-Sprechstunde verfügbar' },
        'emergency_appointments': { icon: 'lightning', color: 'warning', text: 'Notfall-Termine möglich' }
    };
    
    let html = '';
    features.slice(0, 6).forEach(feature => {
        const info = featureInfo[feature];
        if (info) {
            html += `
                <span class="feature-badge badge bg-${info.color} clickable-badge" 
                      data-bs-toggle="tooltip" 
                      data-bs-placement="top" 
                      title="${info.text}">
                    <i class="bi bi-${info.icon}"></i>
                </span>
            `;
        }
    });
    
    return html;
}

// NEW: Generate clickable gallery
function generateClickableGallery(photos, doctorId) {
    if (!photos || photos.length === 0) return '';
    
    let html = '<div class="mini-gallery mb-2">';
    photos.forEach((photo, index) => {
        html += `
            <img src="${typeof photo === 'string' ? photo : photo.url}" 
                 alt="Praxisfoto" 
                 class="gallery-thumb"
                 onclick="showGalleryModal('${doctorId}', ${index})">
        `;
    });
    html += '</div>';
    
    return html;
}

// NEW: Toggle practice details
function togglePracticeDetails(doctorId) {
    const element = document.getElementById(`practice-details-${doctorId}`);
    const icon = document.getElementById(`toggle-practice-${doctorId}`);
    
    if (element.classList.contains('show')) {
        element.classList.remove('show');
        icon.classList.remove('bi-chevron-up');
        icon.classList.add('bi-chevron-down');
    } else {
        element.classList.add('show');
        icon.classList.remove('bi-chevron-down');
        icon.classList.add('bi-chevron-up');
    }
}

// NEW: Toggle doctor bio
function toggleDoctorBio(doctorId) {
    const element = document.getElementById(`doctor-bio-${doctorId}`);
    const icon = document.getElementById(`toggle-bio-${doctorId}`);
    
    if (element.classList.contains('show')) {
        element.classList.remove('show');
        icon.classList.remove('bi-chevron-up');
        icon.classList.add('bi-chevron-down');
    } else {
        element.classList.add('show');
        icon.classList.remove('bi-chevron-down');
        icon.classList.add('bi-chevron-up');
    }
}

// NEW: Show doctor photo modal
function showDoctorPhotoModal(photoUrl, doctorName) {
    const modalHtml = `
        <div class="modal fade" id="doctorPhotoModal" tabindex="-1">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">${doctorName}</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body text-center">
                        <img src="${photoUrl}" class="img-fluid" alt="${doctorName}">
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Remove existing modal if any
    const existing = document.getElementById('doctorPhotoModal');
    if (existing) existing.remove();
    
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    const modal = new bootstrap.Modal(document.getElementById('doctorPhotoModal'));
    modal.show();
}

// NEW: Show gallery modal
function showGalleryModal(doctorId, startIndex) {
    const data = doctorsData[doctorId];
    if (!data) {
        console.error('Doctor data not found for id:', doctorId);
        return;
    }
    
    const photos = data.practice.gallery_photos || [];
    const practiceName = data.practice.name || '';
    
    if (photos.length === 0) {
        return;
    }
    
    let currentIndex = startIndex;
    
    const showImage = (index) => {
        const photo = photos[index];
        const photoUrl = typeof photo === 'string' ? photo : photo.url;
        const photoTitle = typeof photo === 'string' ? '' : (photo.title || '');
        
        const modalBody = document.getElementById('galleryModalBody');
        modalBody.innerHTML = `
            <img src="${photoUrl}" class="img-fluid" alt="Praxisfoto">
            ${photoTitle ? `<p class="text-center mt-2 mb-0"><small>${photoTitle}</small></p>` : ''}
        `;
        
        // Update navigation
        document.getElementById('galleryPrev').disabled = index === 0;
        document.getElementById('galleryNext').disabled = index === photos.length - 1;
        document.getElementById('galleryCounter').textContent = `${index + 1} / ${photos.length}`;
    };
    
    const modalHtml = `
        <div class="modal fade" id="galleryModal" tabindex="-1">
            <div class="modal-dialog modal-lg modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">
                            <i class="bi bi-images"></i> ${practiceName} - Galerie
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body" id="galleryModalBody">
                        <!-- Image will be inserted here -->
                    </div>
                    <div class="modal-footer justify-content-between">
                        <button type="button" class="btn btn-secondary" id="galleryPrev">
                            <i class="bi bi-chevron-left"></i> Zurück
                        </button>
                        <span id="galleryCounter"></span>
                        <button type="button" class="btn btn-secondary" id="galleryNext">
                            Weiter <i class="bi bi-chevron-right"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Remove existing modal
    const existing = document.getElementById('galleryModal');
    if (existing) existing.remove();
    
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    
    // Setup navigation
    document.getElementById('galleryPrev').addEventListener('click', () => {
        if (currentIndex > 0) {
            currentIndex--;
            showImage(currentIndex);
        }
    });
    
    document.getElementById('galleryNext').addEventListener('click', () => {
        if (currentIndex < photos.length - 1) {
            currentIndex++;
            showImage(currentIndex);
        }
    });
    
    const modal = new bootstrap.Modal(document.getElementById('galleryModal'));
    modal.show();
    showImage(currentIndex);
}

// NEW: Show ratings info
function showRatingsInfo(doctorId, practiceName, ratingAvg, ratingCount) {
    const modalHtml = `
        <div class="modal fade" id="ratingsModal" tabindex="-1">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">
                            <i class="bi bi-star-fill text-warning"></i> Bewertungen
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <h6>${practiceName}</h6>
                        <div class="text-center my-3">
                            <div class="display-4 text-warning">${ratingAvg.toFixed(1)}</div>
                            ${generateStarRating(ratingAvg)}
                            <p class="text-muted mt-2">Basierend auf ${ratingCount} Bewertung${ratingCount !== 1 ? 'en' : ''}</p>
                        </div>
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle"></i> 
                            Detaillierte Bewertungen sind nach Ihrem Termin verfügbar.
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Schließen</button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    const existing = document.getElementById('ratingsModal');
    if (existing) existing.remove();
    
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    const modal = new bootstrap.Modal(document.getElementById('ratingsModal'));
    modal.show();
}

// NEW: Show insurance modal
function showInsuranceModal(doctorId, practiceName) {
    const data = doctorsData[doctorId];
    if (!data) {
        console.error('Doctor data not found for id:', doctorId);
        return;
    }
    
    const insurances = data.practice.accepted_insurances || [];
    if (insurances.length === 0) {
        return;
    }
    
    const publicIns = insurances.filter(i => i.type === 'public');
    const privateIns = insurances.filter(i => i.type === 'private');
    
    const modalHtml = `
        <div class="modal fade" id="insuranceModal" tabindex="-1">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">
                            <i class="bi bi-shield-check"></i> Akzeptierte Versicherungen
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <h6>${practiceName}</h6>
                        
                        ${publicIns.length > 0 ? `
                        <div class="mt-3">
                            <h6 class="text-success">
                                <i class="bi bi-hospital"></i> Gesetzliche Krankenkassen
                            </h6>
                            <div class="d-flex flex-wrap gap-2">
                                ${publicIns.map(i => `<span class="badge bg-success">${i.name}</span>`).join('')}
                            </div>
                        </div>
                        ` : ''}
                        
                        ${privateIns.length > 0 ? `
                        <div class="mt-3">
                            <h6 class="text-primary">
                                <i class="bi bi-star"></i> Private Versicherungen
                            </h6>
                            <div class="d-flex flex-wrap gap-2">
                                ${privateIns.map(i => `<span class="badge bg-primary">${i.name}</span>`).join('')}
                            </div>
                        </div>
                        ` : ''}
                        
                        <div class="alert alert-info mt-3 mb-0">
                            <small>
                                <i class="bi bi-info-circle"></i> 
                                Bitte bestätigen Sie Ihre Versicherung bei der Terminbuchung.
                            </small>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Schließen</button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    const existing = document.getElementById('insuranceModal');
    if (existing) existing.remove();
    
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    const modal = new bootstrap.Modal(document.getElementById('insuranceModal'));
    modal.show();
}

// City autocomplete
let cityAutocompleteTimeout = null;
const cityInput = document.getElementById('search-city');
const cityAutocompleteDiv = document.getElementById('city-autocomplete');

document.addEventListener('DOMContentLoaded', function() {
    console.log('=== DOMContentLoaded EVENT FIRED ===');
    
    // Автокомплит городов
    cityInput.addEventListener('input', function() {
        clearTimeout(cityAutocompleteTimeout);
        const query = this.value.trim();
        
        if (query.length < 2) {
            cityAutocompleteDiv.style.display = 'none';
            return;
        }
        
        cityAutocompleteTimeout = setTimeout(() => {
            fetchCitySuggestions(query);
        }, 300);
    });
    
    // Скрыть автокомплит при клике вне
    document.addEventListener('click', function(e) {
        if (!cityInput.contains(e.target) && !cityAutocompleteDiv.contains(e.target)) {
            cityAutocompleteDiv.style.display = 'none';
        }
    });
    
    // Initialize Bootstrap tooltips for interactive elements
    const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    tooltipTriggerList.forEach(function (tooltipTriggerEl) {
        new bootstrap.Tooltip(tooltipTriggerEl);
    });
    
    // Автоматический поиск при загрузке страницы
    searchDoctors();
});

async function fetchCitySuggestions(query) {
    try {
        const response = await fetch(`/api/search/cities?q=${encodeURIComponent(query)}&limit=10`);
        if (response.ok) {
            const data = await response.json();
            displayCitySuggestions(data.cities);
        }
    } catch (error) {
        console.error('Error fetching city suggestions:', error);
    }
}

function displayCitySuggestions(cities) {
    if (cities.length === 0) {
        cityAutocompleteDiv.style.display = 'none';
        return;
    }
    
    cityAutocompleteDiv.innerHTML = cities.map(city => 
        `<button type="button" class="list-group-item list-group-item-action" onclick="selectCity('${city}')">${city}</button>`
    ).join('');
    
    cityAutocompleteDiv.style.display = 'block';
}

function selectCity(city) {
    cityInput.value = city;
    cityAutocompleteDiv.style.display = 'none';
    searchDoctors();
}

async function getUserLocation() {
    if (!navigator.geolocation) {
        alert('Geolocation wird von Ihrem Browser nicht unterstützt.');
        return;
    }
    
    cityInput.value = 'Suche nach Standort...';
    cityInput.disabled = true;
    
    navigator.geolocation.getCurrentPosition(
        async (position) => {
            const { latitude, longitude } = position.coords;
            console.log('User location:', latitude, longitude);
            
            try {
                // Используем Nominatim API для обратного геокодирования
                const response = await fetch(
                    `https://nominatim.openstreetmap.org/reverse?format=json&lat=${latitude}&lon=${longitude}&addressdetails=1`,
                    {
                        headers: {
                            'User-Agent': 'TerminFinder/1.0'
                        }
                    }
                );
                
                if (response.ok) {
                    const data = await response.json();
                    const city = data.address.city || data.address.town || data.address.village || '';
                    
                    if (city) {
                        cityInput.value = city;
                        searchDoctors();
                    } else {
                        alert('Stadt konnte nicht ermittelt werden.');
                        cityInput.value = '';
                    }
                }
            } catch (error) {
                console.error('Error reverse geocoding:', error);
                alert('Fehler beim Ermitteln des Standorts.');
                cityInput.value = '';
            }
            
            cityInput.disabled = false;
        },
        (error) => {
            console.error('Geolocation error:', error);
            alert('Standort konnte nicht ermittelt werden. Bitte erlauben Sie den Zugriff auf Ihren Standort.');
            cityInput.value = '';
            cityInput.disabled = false;
        },
        {
            enableHighAccuracy: true,
            timeout: 10000,
            maximumAge: 0
        }
    );
}

async function searchDoctors() {
    const speciality = document.getElementById('search-speciality').value;
    const city = document.getElementById('search-city').value;
    
    const resultsDiv = document.getElementById('search-results');
    resultsDiv.innerHTML = '<div class="text-center"><div class="spinner-border"></div> Suche...</div>';
    
    // Используем новый endpoint для поиска с количеством слотов
    const params = new URLSearchParams();
    if (speciality) params.append('speciality', speciality);
    if (city) params.append('city', city);
    
    try {
        const response = await fetch(`/api/search/doctors/available?${params}`, {
            method: 'GET'
        });
        
        if (response.ok) {
            const data = await response.json();
            console.log('Search results:', data);
            console.log('Doctors array:', data.doctors);
            console.log('Doctors length:', data.doctors.length);
            displayDoctors(data.doctors);
        } else {
            resultsDiv.innerHTML = '<div class="alert alert-danger">Fehler bei der Suche</div>';
        }
    } catch (error) {
        console.error('Error searching doctors:', error);
        resultsDiv.innerHTML = '<div class="alert alert-danger">Fehler bei der Suche</div>';
    }
}

// Store doctors data globally for modal access
let doctorsData = {};

async function displayDoctors(doctors) {
    const resultsDiv = document.getElementById('search-results');
    
    // Clear previous data
    doctorsData = {};
    
    console.log('displayDoctors called with doctors array');
    console.log('Is array?', Array.isArray(doctors));
    if (doctors) {
        console.log('Length:', doctors.length);
    }
    
    if (doctors.length === 0) {
        // Получаем текущие критерии поиска
        const speciality = document.getElementById('search-speciality').value;
        const city = document.getElementById('search-city').value;
        
        const specialityName = speciality ? getSpecialityName(speciality) : 'dieser Fachrichtung';
        const cityText = city ? ` in ${city}` : '';
        
        resultsDiv.innerHTML = `
            <div class="text-center py-5">
                <i class="bi bi-search text-muted" style="font-size: 3rem;"></i>
                <h5 class="mt-3">Keine Ärzte gefunden</h5>
                <p class="text-muted">Aktuell keine Termine verfügbar für ${specialityName}${cityText}</p>
                
                <div class="card mt-4 mx-auto" style="max-width: 500px;">
                    <div class="card-body">
                        <h6 class="card-title">
                            <i class="bi bi-bell text-primary"></i> 
                            Benachrichtigung einrichten?
                        </h6>
                        <p class="card-text small text-muted">
                            Wir informieren Sie automatisch, sobald ein Termin verfügbar wird.
                        </p>
                        <button class="btn btn-primary w-100" onclick="createSearchAlert()">
                            <i class="bi bi-bell-fill"></i> Ja, benachrichtigen Sie mich
                        </button>
                        <button class="btn btn-outline-secondary w-100 mt-2" onclick="clearFilters()">
                            Andere Suchkriterien
                        </button>
                    </div>
                </div>
            </div>
        `;
        return;
    }
    
    let html = '<div class="row">';
    
    // Проверяем существующие алерты для всех врачей
    const alertChecks = await Promise.all(doctors.map(async (doctor) => {
        try {
            const response = await fetch('/api/patient/alerts/check', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + localStorage.getItem('access_token')
                },
                body: JSON.stringify({
                    doctor_id: doctor.id,
                    speciality: doctor.speciality
                })
            });
            if (response.ok) {
                const data = await response.json();
                return { doctorId: doctor.id, exists: data.exists };
            }
        } catch (error) {
            console.error('Error checking alert:', error);
        }
        return { doctorId: doctor.id, exists: false };
    }));
    
    const alertExistsMap = {};
    alertChecks.forEach(check => {
        alertExistsMap[check.doctorId] = check.exists;
    });
    
    doctors.forEach(doctor => {
        const practice = doctor.practice || {};
        const practiceName = practice.name || '';
        const practiceCity = practice.city || '';
        const website = practice.website || '';
        const googleBusiness = practice.google_business_url || '';
        const phone = practice.phone || '';
        const alertExists = alertExistsMap[doctor.id] || false;
        
        // Store doctor data for modal access
        doctorsData[doctor.id] = {
            doctor: doctor,
            practice: practice
        };
        
        // Rating display
        const ratingAvg = practice.rating_avg || 0;
        const ratingCount = practice.rating_count || 0;
        const ratingStars = generateStarRating(ratingAvg);
        
        // Features icons
        const features = practice.features || [];
        const featuresHtml = generateFeaturesIcons(features);
        
        // Insurance badges
        const insurances = practice.accepted_insurances || [];
        const insurancesHtml = generateInsuranceBadges(insurances);
        
        // Doctor photo or placeholder
        const doctorPhoto = doctor.photo_url || `https://ui-avatars.com/api/?name=${encodeURIComponent(doctor.full_name)}&size=200&background=0D6EFD&color=fff&bold=true`;
        
        // Practice gallery mini-gallery
        const galleryPhotos = practice.gallery_photos || [];
        const galleryHtml = generateMiniGallery(galleryPhotos);
        
        html += `
            <div class="col-md-6 col-lg-4 mb-4" id="doctor-card-${doctor.id}">
                <div class="card h-100 shadow-sm hover-shadow">
                    <!-- Doctor Photo -->
                    <div class="position-relative">
                        <img src="${doctorPhoto}" class="card-img-top doctor-photo-clickable" alt="${doctor.full_name}" 
                             style="height: 200px; object-fit: cover; cursor: pointer;"
                             onclick="showDoctorPhotoModal('${doctorPhoto}', '${doctor.full_name}')">
                        ${doctor.title ? `<span class="badge bg-primary position-absolute top-0 start-0 m-2">${doctor.title}</span>` : ''}
                        ${doctor.experience_years ? `
                        <span class="badge bg-info position-absolute top-0 end-0 m-2 clickable-badge" 
                              data-bs-toggle="tooltip" data-bs-placement="left" 
                              title="Seit ${doctor.experience_years} Jahren in der Praxis tätig">
                            <i class="bi bi-award"></i> ${doctor.experience_years} Jahre
                        </span>` : ''}
                        ${ratingCount > 0 ? `
                        <span class="badge bg-warning position-absolute bottom-0 end-0 m-2 clickable-badge"
                              onclick="showRatingsInfo('${doctor.id}', '${practiceName}', ${ratingAvg}, ${ratingCount})">
                            <i class="bi bi-star-fill"></i> ${ratingAvg.toFixed(1)}
                        </span>` : ''}
                    </div>
                    
                    <div class="card-body p-3">
                        <!-- Doctor Name & Speciality -->
                        <h6 class="card-title mb-1">
                            <i class="bi bi-person-circle text-primary"></i>
                            ${doctor.full_name_with_title || doctor.full_name}
                        </h6>
                        <p class="text-primary mb-2 small fw-bold">${doctor.speciality_display}</p>
                        
                        <!-- Languages with clickable icon -->
                        ${doctor.languages && doctor.languages.length > 0 ? `
                        <div class="mb-2">
                            <span class="badge bg-light text-dark clickable-icon" 
                                  data-bs-toggle="tooltip" 
                                  title="Spricht: ${doctor.languages.map(function(l) { return l.toUpperCase(); }).join(', ')}">
                                <i class="bi bi-translate"></i> ${doctor.languages.length} Sprache${doctor.languages.length > 1 ? 'n' : ''}
                            </span>
                        </div>
                        ` : ''}
                        
                        <!-- Practice Info with clickable icon -->
                        ${practiceName ? `
                        <div class="mb-2">
                            <small class="text-muted clickable-text" onclick="togglePracticeDetails('${doctor.id}')">
                                <i class="bi bi-hospital"></i> ${practiceName}
                                <i class="bi bi-chevron-down toggle-icon" id="toggle-practice-${doctor.id}"></i>
                            </small>
                        </div>
                        ` : ''}
                        
                        <!-- Collapsible Practice Details -->
                        <div id="practice-details-${doctor.id}" class="collapse">
                            <div class="card card-body bg-light mb-2 p-2">
                                ${practiceCity ? `
                                <small class="mb-1">
                                    <i class="bi bi-geo-alt text-primary"></i> 
                                    <a href="https://maps.google.com/?q=${encodeURIComponent(practiceName + ' ' + practiceCity)}" 
                                       target="_blank" class="text-decoration-none">
                                        ${practiceCity}
                                    </a>
                                </small>` : ''}
                                
                                ${phone ? `
                                <small class="mb-1">
                                    <i class="bi bi-telephone text-success"></i> 
                                    <a href="tel:${phone}" class="text-decoration-none">${phone}</a>
                                </small>` : ''}
                                
                                ${practice.emergency_phone ? `
                                <small class="mb-1">
                                    <i class="bi bi-exclamation-triangle text-danger"></i> 
                                    Notfall: <a href="tel:${practice.emergency_phone}" class="text-decoration-none">${practice.emergency_phone}</a>
                                </small>` : ''}
                                
                                ${practice.whatsapp_number ? `
                                <small class="mb-1">
                                    <i class="bi bi-whatsapp text-success"></i> 
                                    <a href="https://wa.me/${practice.whatsapp_number.replace(/[^0-9]/g, '')}" 
                                       target="_blank" class="text-decoration-none">WhatsApp</a>
                                </small>` : ''}
                                
                                ${website || googleBusiness ? `
                                <div class="d-flex gap-1 mt-1">
                                    ${website ? `<a href="${website}" target="_blank" class="btn btn-xs btn-outline-primary btn-sm" title="Website"><i class="bi bi-globe"></i></a>` : ''}
                                    ${googleBusiness ? `<a href="${googleBusiness}" target="_blank" class="btn btn-xs btn-outline-info btn-sm" title="Google"><i class="bi bi-google"></i></a>` : ''}
                                </div>` : ''}
                            </div>
                        </div>
                        
                        <!-- Features Icons with tooltips -->
                        ${features.length > 0 ? `
                        <div class="mb-2 d-flex gap-1 flex-wrap">
                            ${generateInteractiveFeatures(features, doctor.id)}
                        </div>
                        ` : ''}
                        
                        <!-- Insurance info icon -->
                        ${insurances.length > 0 ? `
                        <div class="mb-2">
                            <span class="badge bg-success clickable-badge" 
                                  onclick="showInsuranceModal('${doctor.id}', '${practiceName.replace(/'/g, "\\'")}')">
                                <i class="bi bi-shield-check"></i> ${insurances.length} Versicherung${insurances.length > 1 ? 'en' : ''}
                            </span>
                        </div>
                        ` : ''}
                        
                        <!-- Collapsible Doctor Bio -->
                        ${doctor.bio ? `
                        <div class="mb-2">
                            <small class="text-muted clickable-text" onclick="toggleDoctorBio('${doctor.id}')">
                                <i class="bi bi-info-circle"></i> Über den Arzt
                                <i class="bi bi-chevron-down toggle-icon" id="toggle-bio-${doctor.id}"></i>
                            </small>
                            <div id="doctor-bio-${doctor.id}" class="collapse mt-1">
                                <small class="text-muted">${doctor.bio}</small>
                            </div>
                        </div>
                        ` : ''}
                        
                        <!-- Mini Gallery clickable -->
                        ${galleryPhotos.length > 0 ? `
                        <div class="mb-2">
                            <small class="text-muted d-block mb-1">
                                <i class="bi bi-images"></i> Praxisfotos
                            </small>
                            ${generateClickableGallery(galleryPhotos, doctor.id)}
                        </div>
                        ` : ''}
                        
                        <!-- Availability Badge -->
                        <div class="mb-2">
                            <span class="badge ${doctor.free_slots_count > 0 ? 'bg-success' : 'bg-secondary'} w-100">
                                <i class="bi bi-calendar-check"></i> 
                                ${doctor.free_slots_count > 0 ? doctor.free_slots_count + ' freie Termine' : 'Keine freien Termine'}
                            </span>
                        </div>
                        
                        <!-- Action Buttons -->
                        <div class="d-grid gap-2">
                            ${doctor.free_slots_count > 0 ? `
                            <button class="btn btn-primary" onclick="openSearchSlotsModal('${doctor.id}', '${doctor.full_name}')">
                                <i class="bi bi-calendar3"></i> Termine anzeigen
                            </button>
                            ` : alertExists ? `
                            <button class="btn btn-success" disabled>
                                <i class="bi bi-bell-fill"></i> Benachrichtigung aktiv
                            </button>
                            ` : `
                            <button class="btn btn-warning" onclick="createAlert('${doctor.id}', '${doctor.full_name}', '${doctor.speciality}')">
                                <i class="bi bi-bell"></i> Benachrichtigung einrichten
                            </button>
                            `}
                            
                            ${practice.slug ? `
                            <a href="/practice/${practice.slug}" class="btn btn-outline-primary btn-sm">
                                <i class="bi bi-info-circle"></i> Mehr über die Praxis
                            </a>
                            ` : ''}
                        </div>
                    </div>
                </div>
            </div>
        `;
    });
    html += '</div>';
    
    resultsDiv.innerHTML = html;
}

function getSpecialityName(speciality) {
    return SPECIALITIES_DATA[speciality] ? SPECIALITIES_DATA[speciality].de : speciality;
}

// Переменная для отслеживания раскрытых карточек
const expandedDoctors = new Set();

async function openSearchSlotsModal(doctorId, doctorName) {
    const modal = new bootstrap.Modal(document.getElementById('searchSlotsModal'));
    const modalTitle = document.getElementById('searchSlotsModalTitle');
    const modalBody = document.getElementById('searchSlotsModalBody');
    
    modalTitle.textContent = `Verfügbare Termine - ${doctorName}`;
    modalBody.innerHTML = '<div class="text-center"><div class="spinner-border"></div><p class="mt-2">Lade Termine...</p></div>';
    
    modal.show();
    
    try {
        const response = await fetch(`/api/search/doctors/${doctorId}/slots`);

        if (response.ok) {
            const data = await response.json();
            displaySearchSlotsInModal(data, doctorName);
        } else {
            modalBody.innerHTML = '<div class="alert alert-danger">Fehler beim Laden der Termine</div>';
        }
    } catch (error) {
        console.error('Error loading slots:', error);
        modalBody.innerHTML = '<div class="alert alert-danger">Fehler beim Laden der Termine</div>';
    }
}

function displaySearchSlotsInModal(data, doctorName) {
    const modalBody = document.getElementById('searchSlotsModalBody');
    
    if (Object.keys(data.slots_by_date).length === 0) {
        modalBody.innerHTML = '<div class="text-center py-5"><i class="bi bi-calendar-x text-muted" style="font-size: 3rem;"></i><p class="text-muted mt-3">Keine Termine verfügbar</p></div>';
        return;
    }
    
    let html = '';
    const sortedDates = Object.keys(data.slots_by_date).sort();
    
    sortedDates.forEach(date => {
        const slots = data.slots_by_date[date];
        const dateObj = new Date(date);
        const formattedDate = dateObj.toLocaleDateString('de-DE', {
            weekday: 'long',
            year: 'numeric',
            month: 'long',
            day: 'numeric'
        });
        
        html += `
            <div class="mb-4">
                <h5 class="text-primary mb-3">
                    <i class="bi bi-calendar3"></i> ${formattedDate}
                </h5>
                <div class="d-flex flex-wrap gap-2">
        `;
        
        slots.forEach(slot => {
            html += `
                <button class="btn btn-outline-primary" style="min-width: 100px;" onclick="bookSlotFromModal('${slot.id}', '${date}T${slot.start_time}:00', '${doctorName}')">
                    <i class="bi bi-clock"></i> ${slot.start_time.substring(0, 5)}
                </button>
            `;
        });
        
        html += `
                </div>
            </div>
        `;
    });
    
    modalBody.innerHTML = html;
}

async function bookSlotFromModal(slotId, startTime, doctorName) {
    if (!confirm(`Möchten Sie diesen Termin buchen?\n\nArzt: ${doctorName}\nZeit: ${new Date(startTime).toLocaleString('de-DE')}`)) {
        return;
    }
    
    try {
        const response = await fetch('/api/patient/book', {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${localStorage.getItem('access_token')}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ slot_id: slotId })
        });

        const data = await response.json();

        if (response.ok) {
            alert(`Termin erfolgreich gebucht!\n\nBuchungscode: ${data.booking_code || data.booking_id}\nArzt: ${data.doctor_name}\n${data.date} um ${data.time}`);
            bootstrap.Modal.getInstance(document.getElementById('searchSlotsModal')).hide();
            window.location.href = '/patient/bookings';
        } else {
            const error = await response.json();
            alert('Fehler: ' + error.error);
        }
    } catch (error) {
        console.error('Error booking slot:', error);
        alert('Fehler bei der Buchung');
    }
}

async function toggleDoctorSlots(doctorId) {
    const container = document.getElementById(`slots-container-${doctorId}`);
    const button = document.getElementById(`toggle-btn-${doctorId}`);
    
    // Если уже раскрыто - скрываем
    if (expandedDoctors.has(doctorId)) {
        container.style.display = 'none';
        button.innerHTML = '<i class="bi bi-chevron-down"></i> Termine anzeigen';
        expandedDoctors.delete(doctorId);
        return;
    }
    
    // Раскрываем и загружаем слоты
    container.style.display = 'block';
    button.innerHTML = '<i class="bi bi-chevron-up"></i> Termine ausblenden';
    expandedDoctors.add(doctorId);
    
    // Загружаем слоты через новый API
    try {
        const response = await fetch(`/api/search/doctors/${doctorId}/slots`, {
            method: 'GET'
        });
        
        if (response.ok) {
            const data = await response.json();
            displayDoctorSlots(doctorId, data);
        } else {
            container.innerHTML = '<div class="alert alert-danger">Fehler beim Laden der Termine</div>';
        }
    } catch (error) {
        console.error('Error loading slots:', error);
        container.innerHTML = '<div class="alert alert-danger">Fehler beim Laden der Termine</div>';
    }
}

function displayDoctorSlots(doctorId, data) {
    const container = document.getElementById(`slots-container-${doctorId}`);
    
    if (Object.keys(data.slots_by_date).length === 0) {
        container.innerHTML = '<p class="text-muted text-center">Keine Termine verfügbar</p>';
        return;
    }
    
    let html = '<div class="slots-list">';
    
    // Сортируем даты
    const sortedDates = Object.keys(data.slots_by_date).sort();
    
    sortedDates.forEach(date => {
        const slots = data.slots_by_date[date];
        html += `
            <div class="mb-3">
                <h6 class="text-primary">
                    <i class="bi bi-calendar3"></i> ${formatDate(date)}
                </h6>
                <div class="row g-2">
        `;
        
        slots.forEach(slot => {
            html += `
                <div class="col-6 col-md-3 col-lg-2">
                    <button class="btn btn-outline-primary btn-sm w-100" onclick="bookSlotDirect('${slot.id}', '${doctorId}', '${date}', '${slot.start_time}')">
                        <i class="bi bi-clock"></i> ${slot.start_time}
                    </button>
                </div>
            `;
        });
        
        html += `
                </div>
            </div>
        `;
    });
    
    html += '</div>';
    container.innerHTML = html;
}

async function bookSlotDirect(slotId, doctorId, date, time) {
    if (!confirm(`Möchten Sie diesen Termin buchen?\n\nDatum: ${formatDate(date)}\nUhrzeit: ${time}`)) {
        return;
    }
    
    try {
        const response = await fetch('/api/patient/book', {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${localStorage.getItem('access_token')}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ slot_id: slotId })
        });
        
        if (response.ok) {
            const data = await response.json();
            alert(`Termin erfolgreich gebucht!\n\nBuchungscode: ${data.booking_code || data.booking_id}\nArzt: ${data.doctor_name}\n${data.date} um ${data.time}\n\nSie werden zu Ihren Terminen weitergeleitet...`);
            
            // Перенаправляем на страницу букингов
            window.location.href = '/patient/bookings';
        } else {
            const error = await response.json();
            alert('Fehler: ' + error.error);
        }
    } catch (error) {
        console.error('Error booking slot:', error);
        alert('Fehler bei der Buchung');
    }
}

async function viewSlots(doctorId) {
    // Эта функция больше не используется, но оставим для совместимости
    toggleDoctorSlots(doctorId);
}

function formatDate(dateStr) {
    const date = new Date(dateStr);
    return date.toLocaleDateString('de-DE', { 
        weekday: 'long', 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric' 
    });
}

// Создать алерт по критериям поиска (когда результатов нет)
async function createSearchAlert() {
    const speciality = document.getElementById('search-speciality').value;
    const city = document.getElementById('search-city').value;
    
    if (!speciality) {
        alert('Bitte wählen Sie mindestens eine Fachrichtung aus');
        return;
    }
    
    const payload = {
        speciality: speciality,
        city: city || null
    };
    
    console.log('Creating search alert with payload:', payload);
    
    try {
        const response = await fetch('/api/patient/alerts', {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${localStorage.getItem('access_token')}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(payload)
        });
        
        if (response.ok) {
            const data = await response.json();
            console.log('Alert created:', data);
            alert('Benachrichtigung erfolgreich eingerichtet!\n\nSie werden informiert, sobald ein Termin verfügbar wird.\n\nSie können Ihre Benachrichtigungen im Dashboard verwalten.');
            // Очищаем результаты и позволяем продолжить поиск
            clearFilters();
        } else {
            const error = await response.json();
            console.error('Error response:', error);
            console.error('Full error details:', JSON.stringify(error, null, 2));
            if (error.error === 'Alert already exists for this doctor/speciality') {
                alert('Sie haben bereits eine Benachrichtigung für diese Suche eingerichtet.\n\nSie können sie in Ihrem Dashboard verwalten.');
                clearFilters();
            } else {
                alert('Fehler: ' + (error.error || 'Konnte Benachrichtigung nicht erstellen'));
            }
        }
    } catch (error) {
        console.error('Error creating alert:', error);
        alert('Fehler beim Erstellen der Benachrichtigung');
    }
}

// Создать алерт для конкретного врача
async function createAlert(doctorId, doctorName, speciality) {
    if (!confirm(`Möchten Sie eine Benachrichtigung einrichten für: ${doctorName}?\n\nSie werden informiert, wenn ein neuer Termin verfügbar wird.`)) {
        return;
    }
    
    const payload = {
        doctor_id: doctorId,
        speciality: speciality
    };
    
    console.log('Creating alert with payload:', payload);
    
    try {
        const response = await fetch('/api/patient/alerts', {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${localStorage.getItem('access_token')}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(payload)
        });
        
        if (response.ok) {
            const data = await response.json();
            console.log('Alert created:', data);
            alert('Benachrichtigung erfolgreich eingerichtet!\n\nSie erhalten eine Nachricht, sobald ein Termin verfügbar wird.');
        } else {
            const error = await response.json();
            console.error('Error response:', error);
            alert('Fehler: ' + (error.error || 'Konnte Benachrichtigung nicht erstellen'));
        }
    } catch (error) {
        console.error('Error creating alert:', error);
        alert('Fehler beim Erstellen der Benachrichtigung');
    }
}


function clearFilters() {
    document.getElementById('search-speciality').value = '';
    document.getElementById('search-city').value = '';
    document.getElementById('search-results').innerHTML = '<div class="text-center py-5 text-muted"><p>Wählen Sie Ihre Suchkriterien und klicken Sie auf "Suchen"</p></div>';
}
</script>
{% endblock dashboard_scripts %}