{% extends "base_dashboard.html" %}
{% set title = "Arzt suchen" %}
{% set user_type = "patient" %}

{% block dashboard_content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <!-- Фильтры поиска -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="card-title mb-0">Arzt suchen</h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-4">
                            <label class="form-label">Spezialisierung</label>
                            <select class="form-select" id="search-speciality">
                                <option value="">Alle Spezialisierungen</option>
                                {% for key, spec in specialities.items() %}
                                <option value="{{ key }}">{{ spec.de }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Stadt</label>
                            <input type="text" class="form-control" id="search-city" placeholder="Stadt eingeben">
                        </div>
                    </div>
                    <div class="mt-3">
                        <button class="btn btn-primary" onclick="searchDoctors()">
                            <i class="bi bi-search"></i> Suchen
                        </button>
                        <button class="btn btn-outline-secondary" onclick="clearFilters()">
                            <i class="bi bi-x-circle"></i> Filter löschen
                        </button>
                    </div>
                </div>
            </div>

            <!-- Результаты поиска -->
            <div id="search-results">
                <div class="text-center py-5">
                    <i class="bi bi-search text-muted" style="font-size: 3rem;"></i>
                    <p class="text-muted mt-3">Verwenden Sie die Filter oben, um Ärzte zu suchen.</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно для просмотра всех слотов врача -->
<div class="modal fade" id="searchSlotsModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="searchSlotsModalTitle">Verfügbare Termine</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="searchSlotsModalBody" style="max-height: 70vh; overflow-y: auto;">
                <div class="text-center">
                    <div class="spinner-border"></div>
                    <p class="mt-2">Lade Termine...</p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block dashboard_scripts %}
<style>
.slots-list {
    max-height: 400px;
    overflow-y: auto;
}

#doctor-card {
    transition: all 0.3s ease;
}

#doctor-card:hover {
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

#slots-container {
    animation: slideDown 0.3s ease-out;
}

@keyframes slideDown {
    from {
        opacity: 0;
        max-height: 0;
    }
    to {
        opacity: 1;
        max-height: 1000px;
    }
}
</style>

<script>
console.log('=== SEARCH PAGE SCRIPT LOADED ===');
// Specialities data from server
const SPECIALITIES_DATA = {{ specialities|tojson|safe }};

document.addEventListener('DOMContentLoaded', function() {
    console.log('=== DOMContentLoaded EVENT FIRED ===');
    // Автоматический поиск при загрузке страницы
    searchDoctors();
});

async function searchDoctors() {
    const speciality = document.getElementById('search-speciality').value;
    const city = document.getElementById('search-city').value;
    
    const resultsDiv = document.getElementById('search-results');
    resultsDiv.innerHTML = '<div class="text-center"><div class="spinner-border"></div> Suche...</div>';
    
    // Используем новый endpoint для поиска с количеством слотов
    const params = new URLSearchParams();
    if (speciality) params.append('speciality', speciality);
    if (city) params.append('city', city);
    
    try {
        const response = await fetch(`/api/search/doctors/available?${params}`, {
            method: 'GET'
        });
        
        if (response.ok) {
            const data = await response.json();
            console.log('Search results:', data);
            console.log('Doctors array:', data.doctors);
            console.log('Doctors length:', data.doctors.length);
            displayDoctors(data.doctors);
        } else {
            resultsDiv.innerHTML = '<div class="alert alert-danger">Fehler bei der Suche</div>';
        }
    } catch (error) {
        console.error('Error searching doctors:', error);
        resultsDiv.innerHTML = '<div class="alert alert-danger">Fehler bei der Suche</div>';
    }
}

async function displayDoctors(doctors) {
    const resultsDiv = document.getElementById('search-results');
    
    console.log('displayDoctors called with:', doctors);
    console.log('Is array?', Array.isArray(doctors));
    console.log('Length:', doctors ? doctors.length : 'null/undefined');
    
    if (doctors.length === 0) {
        // Получаем текущие критерии поиска
        const speciality = document.getElementById('search-speciality').value;
        const city = document.getElementById('search-city').value;
        
        const specialityName = speciality ? getSpecialityName(speciality) : 'dieser Fachrichtung';
        const cityText = city ? ` in ${city}` : '';
        
        resultsDiv.innerHTML = `
            <div class="text-center py-5">
                <i class="bi bi-search text-muted" style="font-size: 3rem;"></i>
                <h5 class="mt-3">Keine Ärzte gefunden</h5>
                <p class="text-muted">Aktuell keine Termine verfügbar für ${specialityName}${cityText}</p>
                
                <div class="card mt-4 mx-auto" style="max-width: 500px;">
                    <div class="card-body">
                        <h6 class="card-title">
                            <i class="bi bi-bell text-primary"></i> 
                            Benachrichtigung einrichten?
                        </h6>
                        <p class="card-text small text-muted">
                            Wir informieren Sie automatisch, sobald ein Termin verfügbar wird.
                        </p>
                        <button class="btn btn-primary w-100" onclick="createSearchAlert()">
                            <i class="bi bi-bell-fill"></i> Ja, benachrichtigen Sie mich
                        </button>
                        <button class="btn btn-outline-secondary w-100 mt-2" onclick="clearFilters()">
                            Andere Suchkriterien
                        </button>
                    </div>
                </div>
            </div>
        `;
        return;
    }
    
    let html = '<div class="row">';
    
    // Проверяем существующие алерты для всех врачей
    const alertChecks = await Promise.all(doctors.map(async (doctor) => {
        try {
            const response = await fetch('/api/patient/alerts/check', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + localStorage.getItem('access_token')
                },
                body: JSON.stringify({
                    doctor_id: doctor.id,
                    speciality: doctor.speciality
                })
            });
            if (response.ok) {
                const data = await response.json();
                return { doctorId: doctor.id, exists: data.exists };
            }
        } catch (error) {
            console.error('Error checking alert:', error);
        }
        return { doctorId: doctor.id, exists: false };
    }));
    
    const alertExistsMap = {};
    alertChecks.forEach(check => {
        alertExistsMap[check.doctorId] = check.exists;
    });
    
    doctors.forEach(doctor => {
        const practice = doctor.practice || {};
        const practiceName = practice.name || '';
        const practiceCity = practice.city || '';
        const website = practice.website || '';
        const googleBusiness = practice.google_business_url || '';
        const phone = practice.phone || '';
        const alertExists = alertExistsMap[doctor.id] || false;
        
        html += `
            <div class="col-md-6 col-lg-4 mb-3" id="doctor-card-${doctor.id}">
                <div class="card h-100">
                    <div class="card-body">
                        <h6 class="mb-2">
                            <i class="bi bi-person-circle text-primary"></i>
                            ${doctor.full_name}
                        </h6>
                        <p class="text-primary mb-2 small">${doctor.speciality_display}</p>
                        ${practiceName ? `<p class="text-muted mb-1 small"><i class="bi bi-hospital"></i> ${practiceName}</p>` : ''}
                        ${practiceCity ? `<p class="text-muted mb-2 small"><i class="bi bi-geo-alt"></i> ${practiceCity}</p>` : ''}
                        
                        <!-- Quick Links -->
                        ${(website || googleBusiness || phone) ? `
                        <div class="mb-2 d-flex gap-2">
                            ${website ? `<a href="${website}" target="_blank" class="btn btn-sm btn-outline-primary" title="Website"><i class="bi bi-globe"></i></a>` : ''}
                            ${googleBusiness ? `<a href="${googleBusiness}" target="_blank" class="btn btn-sm btn-outline-info" title="Google Business"><i class="bi bi-google"></i></a>` : ''}
                            ${phone ? `<a href="tel:${phone}" class="btn btn-sm btn-outline-secondary" title="Anrufen"><i class="bi bi-telephone"></i></a>` : ''}
                        </div>
                        ` : ''}
                        
                        <div class="mb-2">
                            <span class="badge bg-success">
                                <i class="bi bi-calendar-check"></i> ${doctor.free_slots_count} freie Termine
                            </span>
                        </div>
                        
                        ${doctor.free_slots_count > 0 ? `
                        <button class="btn btn-sm btn-primary w-100" onclick="openSearchSlotsModal('${doctor.id}', '${doctor.full_name}')">
                            <i class="bi bi-calendar3"></i> Termine anzeigen
                        </button>
                        ` : alertExists ? `
                        <button class="btn btn-sm btn-success w-100" disabled>
                            <i class="bi bi-bell-fill"></i> Benachrichtigung aktiv
                        </button>
                        ` : `
                        <button class="btn btn-sm btn-warning w-100" onclick="createAlert('${doctor.id}', '${doctor.full_name}', '${doctor.speciality}')">
                            <i class="bi bi-bell"></i> Benachrichtigung einrichten
                        </button>
                        `}
                    </div>
                </div>
            </div>
        `;
    });
    html += '</div>';
    
    resultsDiv.innerHTML = html;
}

function getSpecialityName(speciality) {
    return SPECIALITIES_DATA[speciality] ? SPECIALITIES_DATA[speciality].de : speciality;
}

// Переменная для отслеживания раскрытых карточек
const expandedDoctors = new Set();

async function openSearchSlotsModal(doctorId, doctorName) {
    const modal = new bootstrap.Modal(document.getElementById('searchSlotsModal'));
    const modalTitle = document.getElementById('searchSlotsModalTitle');
    const modalBody = document.getElementById('searchSlotsModalBody');
    
    modalTitle.textContent = `Verfügbare Termine - ${doctorName}`;
    modalBody.innerHTML = '<div class="text-center"><div class="spinner-border"></div><p class="mt-2">Lade Termine...</p></div>';
    
    modal.show();
    
    try {
        const response = await fetch(`/api/search/doctors/${doctorId}/slots`);

        if (response.ok) {
            const data = await response.json();
            displaySearchSlotsInModal(data, doctorName);
        } else {
            modalBody.innerHTML = '<div class="alert alert-danger">Fehler beim Laden der Termine</div>';
        }
    } catch (error) {
        console.error('Error loading slots:', error);
        modalBody.innerHTML = '<div class="alert alert-danger">Fehler beim Laden der Termine</div>';
    }
}

function displaySearchSlotsInModal(data, doctorName) {
    const modalBody = document.getElementById('searchSlotsModalBody');
    
    if (Object.keys(data.slots_by_date).length === 0) {
        modalBody.innerHTML = '<div class="text-center py-5"><i class="bi bi-calendar-x text-muted" style="font-size: 3rem;"></i><p class="text-muted mt-3">Keine Termine verfügbar</p></div>';
        return;
    }
    
    let html = '';
    const sortedDates = Object.keys(data.slots_by_date).sort();
    
    sortedDates.forEach(date => {
        const slots = data.slots_by_date[date];
        const dateObj = new Date(date);
        const formattedDate = dateObj.toLocaleDateString('de-DE', {
            weekday: 'long',
            year: 'numeric',
            month: 'long',
            day: 'numeric'
        });
        
        html += `
            <div class="mb-4">
                <h5 class="text-primary mb-3">
                    <i class="bi bi-calendar3"></i> ${formattedDate}
                </h5>
                <div class="d-flex flex-wrap gap-2">
        `;
        
        slots.forEach(slot => {
            html += `
                <button class="btn btn-outline-primary" style="min-width: 100px;" onclick="bookSlotFromModal('${slot.id}', '${date}T${slot.start_time}:00', '${doctorName}')">
                    <i class="bi bi-clock"></i> ${slot.start_time.substring(0, 5)}
                </button>
            `;
        });
        
        html += `
                </div>
            </div>
        `;
    });
    
    modalBody.innerHTML = html;
}

async function bookSlotFromModal(slotId, startTime, doctorName) {
    if (!confirm(`Möchten Sie diesen Termin buchen?\n\nArzt: ${doctorName}\nZeit: ${new Date(startTime).toLocaleString('de-DE')}`)) {
        return;
    }
    
    try {
        const response = await fetch('/api/patient/book', {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${localStorage.getItem('access_token')}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ slot_id: slotId })
        });

        const data = await response.json();

        if (response.ok) {
            alert(`Termin erfolgreich gebucht!\n\nBuchungscode: ${data.booking_code || data.booking_id}\nArzt: ${data.doctor_name}\n${data.date} um ${data.time}`);
            bootstrap.Modal.getInstance(document.getElementById('searchSlotsModal')).hide();
            window.location.href = '/patient/bookings';
        } else {
            const error = await response.json();
            alert('Fehler: ' + error.error);
        }
    } catch (error) {
        console.error('Error booking slot:', error);
        alert('Fehler bei der Buchung');
    }
}

async function toggleDoctorSlots(doctorId) {
    const container = document.getElementById(`slots-container-${doctorId}`);
    const button = document.getElementById(`toggle-btn-${doctorId}`);
    
    // Если уже раскрыто - скрываем
    if (expandedDoctors.has(doctorId)) {
        container.style.display = 'none';
        button.innerHTML = '<i class="bi bi-chevron-down"></i> Termine anzeigen';
        expandedDoctors.delete(doctorId);
        return;
    }
    
    // Раскрываем и загружаем слоты
    container.style.display = 'block';
    button.innerHTML = '<i class="bi bi-chevron-up"></i> Termine ausblenden';
    expandedDoctors.add(doctorId);
    
    // Загружаем слоты через новый API
    try {
        const response = await fetch(`/api/search/doctors/${doctorId}/slots`, {
            method: 'GET'
        });
        
        if (response.ok) {
            const data = await response.json();
            displayDoctorSlots(doctorId, data);
        } else {
            container.innerHTML = '<div class="alert alert-danger">Fehler beim Laden der Termine</div>';
        }
    } catch (error) {
        console.error('Error loading slots:', error);
        container.innerHTML = '<div class="alert alert-danger">Fehler beim Laden der Termine</div>';
    }
}

function displayDoctorSlots(doctorId, data) {
    const container = document.getElementById(`slots-container-${doctorId}`);
    
    if (Object.keys(data.slots_by_date).length === 0) {
        container.innerHTML = '<p class="text-muted text-center">Keine Termine verfügbar</p>';
        return;
    }
    
    let html = '<div class="slots-list">';
    
    // Сортируем даты
    const sortedDates = Object.keys(data.slots_by_date).sort();
    
    sortedDates.forEach(date => {
        const slots = data.slots_by_date[date];
        html += `
            <div class="mb-3">
                <h6 class="text-primary">
                    <i class="bi bi-calendar3"></i> ${formatDate(date)}
                </h6>
                <div class="row g-2">
        `;
        
        slots.forEach(slot => {
            html += `
                <div class="col-6 col-md-3 col-lg-2">
                    <button class="btn btn-outline-primary btn-sm w-100" onclick="bookSlotDirect('${slot.id}', '${doctorId}', '${date}', '${slot.start_time}')">
                        <i class="bi bi-clock"></i> ${slot.start_time}
                    </button>
                </div>
            `;
        });
        
        html += `
                </div>
            </div>
        `;
    });
    
    html += '</div>';
    container.innerHTML = html;
}

async function bookSlotDirect(slotId, doctorId, date, time) {
    if (!confirm(`Möchten Sie diesen Termin buchen?\n\nDatum: ${formatDate(date)}\nUhrzeit: ${time}`)) {
        return;
    }
    
    try {
        const response = await fetch('/api/patient/book', {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${localStorage.getItem('access_token')}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ slot_id: slotId })
        });
        
        if (response.ok) {
            const data = await response.json();
            alert(`Termin erfolgreich gebucht!\n\nBuchungscode: ${data.booking_code || data.booking_id}\nArzt: ${data.doctor_name}\n${data.date} um ${data.time}\n\nSie werden zu Ihren Terminen weitergeleitet...`);
            
            // Перенаправляем на страницу букингов
            window.location.href = '/patient/bookings';
        } else {
            const error = await response.json();
            alert('Fehler: ' + error.error);
        }
    } catch (error) {
        console.error('Error booking slot:', error);
        alert('Fehler bei der Buchung');
    }
}

async function viewSlots(doctorId) {
    // Эта функция больше не используется, но оставим для совместимости
    toggleDoctorSlots(doctorId);
}

function formatDate(dateStr) {
    const date = new Date(dateStr);
    return date.toLocaleDateString('de-DE', { 
        weekday: 'long', 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric' 
    });
}

// Создать алерт по критериям поиска (когда результатов нет)
async function createSearchAlert() {
    const speciality = document.getElementById('search-speciality').value;
    const city = document.getElementById('search-city').value;
    
    if (!speciality) {
        alert('Bitte wählen Sie mindestens eine Fachrichtung aus');
        return;
    }
    
    const payload = {
        speciality: speciality,
        city: city || null
    };
    
    console.log('Creating search alert with payload:', payload);
    
    try {
        const response = await fetch('/api/patient/alerts', {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${localStorage.getItem('access_token')}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(payload)
        });
        
        if (response.ok) {
            const data = await response.json();
            console.log('Alert created:', data);
            alert('Benachrichtigung erfolgreich eingerichtet!\n\nSie werden informiert, sobald ein Termin verfügbar wird.\n\nSie können Ihre Benachrichtigungen im Dashboard verwalten.');
            // Очищаем результаты и позволяем продолжить поиск
            clearFilters();
        } else {
            const error = await response.json();
            console.error('Error response:', error);
            console.error('Full error details:', JSON.stringify(error, null, 2));
            if (error.error === 'Alert already exists for this doctor/speciality') {
                alert('Sie haben bereits eine Benachrichtigung für diese Suche eingerichtet.\n\nSie können sie in Ihrem Dashboard verwalten.');
                clearFilters();
            } else {
                alert('Fehler: ' + (error.error || 'Konnte Benachrichtigung nicht erstellen'));
            }
        }
    } catch (error) {
        console.error('Error creating alert:', error);
        alert('Fehler beim Erstellen der Benachrichtigung');
    }
}

// Создать алерт для конкретного врача
async function createAlert(doctorId, doctorName, speciality) {
    if (!confirm(`Möchten Sie eine Benachrichtigung einrichten für: ${doctorName}?\n\nSie werden informiert, wenn ein neuer Termin verfügbar wird.`)) {
        return;
    }
    
    const payload = {
        doctor_id: doctorId,
        speciality: speciality
    };
    
    console.log('Creating alert with payload:', payload);
    
    try {
        const response = await fetch('/api/patient/alerts', {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${localStorage.getItem('access_token')}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(payload)
        });
        
        if (response.ok) {
            const data = await response.json();
            console.log('Alert created:', data);
            alert('Benachrichtigung erfolgreich eingerichtet!\n\nSie erhalten eine Nachricht, sobald ein Termin verfügbar wird.');
        } else {
            const error = await response.json();
            console.error('Error response:', error);
            alert('Fehler: ' + (error.error || 'Konnte Benachrichtigung nicht erstellen'));
        }
    } catch (error) {
        console.error('Error creating alert:', error);
        alert('Fehler beim Erstellen der Benachrichtigung');
    }
}


function clearFilters() {
    document.getElementById('search-speciality').value = '';
    document.getElementById('search-city').value = '';
    document.getElementById('search-results').innerHTML = '<div class="text-center py-5 text-muted"><p>Wählen Sie Ihre Suchkriterien und klicken Sie auf "Suchen"</p></div>';
}
</script>
{% endblock dashboard_scripts %}