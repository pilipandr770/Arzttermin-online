{% extends "base_dashboard.html" %}
{% set title = "Arzt suchen" %}
{% set user_type = "patient" %}

{% block dashboard_content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <!-- Фильтры поиска -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="card-title mb-0">Arzt suchen</h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-4">
                            <label class="form-label">Spezialisierung</label>
                            <select class="form-select" id="search-speciality">
                                <option value="">Alle Spezialisierungen</option>
                                {% for key, spec in specialities.items() %}
                                <option value="{{ key }}">{{ spec.de }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Stadt</label>
                            <input type="text" class="form-control" id="search-city" placeholder="Stadt eingeben">
                        </div>
                    </div>
                    <div class="mt-3">
                        <button class="btn btn-primary" onclick="searchDoctors()">
                            <i class="bi bi-search"></i> Suchen
                        </button>
                        <button class="btn btn-outline-secondary" onclick="clearFilters()">
                            <i class="bi bi-x-circle"></i> Filter löschen
                        </button>
                    </div>
                </div>
            </div>

            <!-- Результаты поиска -->
            <div id="search-results">
                <div class="text-center py-5">
                    <i class="bi bi-search text-muted" style="font-size: 3rem;"></i>
                    <p class="text-muted mt-3">Verwenden Sie die Filter oben, um Ärzte zu suchen.</p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block dashboard_scripts %}
<style>
.slots-list {
    max-height: 400px;
    overflow-y: auto;
}

#doctor-card {
    transition: all 0.3s ease;
}

#doctor-card:hover {
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

#slots-container {
    animation: slideDown 0.3s ease-out;
}

@keyframes slideDown {
    from {
        opacity: 0;
        max-height: 0;
    }
    to {
        opacity: 1;
        max-height: 1000px;
    }
}
</style>

<script>
// Specialities data from server
const SPECIALITIES_DATA = {{ specialities|tojson|safe }};

document.addEventListener('DOMContentLoaded', function() {
    // Автоматический поиск при загрузке страницы
    searchDoctors();
});

async function searchDoctors() {
    const speciality = document.getElementById('search-speciality').value;
    const city = document.getElementById('search-city').value;
    
    const resultsDiv = document.getElementById('search-results');
    resultsDiv.innerHTML = '<div class="text-center"><div class="spinner-border"></div> Suche...</div>';
    
    // Используем новый endpoint для поиска с количеством слотов
    const params = new URLSearchParams();
    if (speciality) params.append('speciality', speciality);
    if (city) params.append('city', city);
    
    try {
        const response = await fetch(`/api/search/doctors/available?${params}`, {
            method: 'GET'
        });
        
        if (response.ok) {
            const data = await response.json();
            displayDoctors(data.doctors);
        } else {
            resultsDiv.innerHTML = '<div class="alert alert-danger">Fehler bei der Suche</div>';
        }
    } catch (error) {
        console.error('Error searching doctors:', error);
        resultsDiv.innerHTML = '<div class="alert alert-danger">Fehler bei der Suche</div>';
    }
}

function displayDoctors(doctors) {
    const resultsDiv = document.getElementById('search-results');
    
    if (doctors.length === 0) {
        resultsDiv.innerHTML = `
            <div class="text-center py-5">
                <i class="bi bi-search text-muted" style="font-size: 3rem;"></i>
                <p class="text-muted mt-3">Keine Ärzte gefunden. Versuchen Sie andere Suchkriterien.</p>
            </div>
        `;
        return;
    }
    
    let html = '<div class="row">';
    doctors.forEach(doctor => {
        const practiceName = doctor.practice ? doctor.practice.name : '';
        const practiceCity = doctor.practice ? doctor.practice.city : '';
        const practiceAddress = doctor.practice ? doctor.practice.address : '';
        
        html += `
            <div class="col-12 mb-3" id="doctor-card-${doctor.id}">
                <div class="card">
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col-md-8">
                                <h5 class="card-title mb-1">
                                    <i class="bi bi-person-circle text-primary"></i>
                                    ${doctor.full_name}
                                </h5>
                                <p class="text-primary mb-1">${doctor.speciality_display}</p>
                                ${practiceName ? `<p class="text-muted mb-0 small"><i class="bi bi-hospital"></i> ${practiceName}</p>` : ''}
                                ${practiceCity ? `<p class="text-muted mb-0 small"><i class="bi bi-geo-alt"></i> ${practiceCity}</p>` : ''}
                            </div>
                            <div class="col-md-4 text-md-end">
                                <div class="mb-2">
                                    <span class="badge bg-success fs-6">
                                        <i class="bi bi-calendar-check"></i> ${doctor.free_slots_count} freie Termine
                                    </span>
                                </div>
                                <button class="btn btn-primary" onclick="toggleDoctorSlots('${doctor.id}')" id="toggle-btn-${doctor.id}">
                                    <i class="bi bi-chevron-down"></i> Termine anzeigen
                                </button>
                            </div>
                        </div>
                        
                        <!-- Контейнер для слотов (скрыт по умолчанию) -->
                        <div id="slots-container-${doctor.id}" class="mt-3" style="display: none;">
                            <hr>
                            <div class="text-center">
                                <div class="spinner-border spinner-border-sm"></div> Lade Termine...
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    });
    html += '</div>';
    
    resultsDiv.innerHTML = html;
}

function getSpecialityName(speciality) {
    return SPECIALITIES_DATA[speciality] ? SPECIALITIES_DATA[speciality].de : speciality;
}

// Переменная для отслеживания раскрытых карточек
const expandedDoctors = new Set();

async function toggleDoctorSlots(doctorId) {
    const container = document.getElementById(`slots-container-${doctorId}`);
    const button = document.getElementById(`toggle-btn-${doctorId}`);
    
    // Если уже раскрыто - скрываем
    if (expandedDoctors.has(doctorId)) {
        container.style.display = 'none';
        button.innerHTML = '<i class="bi bi-chevron-down"></i> Termine anzeigen';
        expandedDoctors.delete(doctorId);
        return;
    }
    
    // Раскрываем и загружаем слоты
    container.style.display = 'block';
    button.innerHTML = '<i class="bi bi-chevron-up"></i> Termine ausblenden';
    expandedDoctors.add(doctorId);
    
    // Загружаем слоты через новый API
    try {
        const response = await fetch(`/api/search/doctors/${doctorId}/slots`, {
            method: 'GET'
        });
        
        if (response.ok) {
            const data = await response.json();
            displayDoctorSlots(doctorId, data);
        } else {
            container.innerHTML = '<div class="alert alert-danger">Fehler beim Laden der Termine</div>';
        }
    } catch (error) {
        console.error('Error loading slots:', error);
        container.innerHTML = '<div class="alert alert-danger">Fehler beim Laden der Termine</div>';
    }
}

function displayDoctorSlots(doctorId, data) {
    const container = document.getElementById(`slots-container-${doctorId}`);
    
    if (Object.keys(data.slots_by_date).length === 0) {
        container.innerHTML = '<p class="text-muted text-center">Keine Termine verfügbar</p>';
        return;
    }
    
    let html = '<div class="slots-list">';
    
    // Сортируем даты
    const sortedDates = Object.keys(data.slots_by_date).sort();
    
    sortedDates.forEach(date => {
        const slots = data.slots_by_date[date];
        html += `
            <div class="mb-3">
                <h6 class="text-primary">
                    <i class="bi bi-calendar3"></i> ${formatDate(date)}
                </h6>
                <div class="row g-2">
        `;
        
        slots.forEach(slot => {
            html += `
                <div class="col-6 col-md-3 col-lg-2">
                    <button class="btn btn-outline-primary btn-sm w-100" onclick="bookSlotDirect('${slot.id}', '${doctorId}', '${date}', '${slot.start_time}')">
                        <i class="bi bi-clock"></i> ${slot.start_time}
                    </button>
                </div>
            `;
        });
        
        html += `
                </div>
            </div>
        `;
    });
    
    html += '</div>';
    container.innerHTML = html;
}

async function bookSlotDirect(slotId, doctorId, date, time) {
    if (!confirm(`Möchten Sie diesen Termin buchen?\n\nDatum: ${formatDate(date)}\nUhrzeit: ${time}`)) {
        return;
    }
    
    try {
        const response = await fetch('/api/patient/book', {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${localStorage.getItem('access_token')}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ slot_id: slotId })
        });
        
        if (response.ok) {
            const data = await response.json();
            alert(`Termin erfolgreich gebucht!\n\nBuchungscode: ${data.booking_code}\n${date} um ${time}`);
            
            // Обновляем список докторов
            searchDoctors();
        } else {
            const error = await response.json();
            alert('Fehler: ' + error.error);
        }
    } catch (error) {
        console.error('Error booking slot:', error);
        alert('Fehler bei der Buchung');
    }
}

async function viewSlots(doctorId) {
    // Эта функция больше не используется, но оставим для совместимости
    toggleDoctorSlots(doctorId);
}

function formatDate(dateStr) {
    const date = new Date(dateStr);
    return date.toLocaleDateString('de-DE', { 
        weekday: 'long', 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric' 
    });
}

function clearFilters() {
    document.getElementById('search-speciality').value = '';
    document.getElementById('search-city').value = '';
    searchDoctors();
}
</script>
{% endblock dashboard_scripts %}